(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=s(o);fetch(o.href,l)}})();const d={gameState:"menu",selectedColor:0,playerName:"",player:null,worms:[],foods:[],items:[],particles:[],camera:{x:0,y:0,targetX:0,targetY:0,zoom:1,targetZoom:1},mouse:{x:0,y:0},boosting:!1,killCount:0,minionCooldown:0,frameCount:0,notifications:[],activeItemEffects:[],lastTime:0,survivalTime:0,wave:0,waveTimer:0,skillChoices:null,selectedSkills:[],skillModifiers:{},nextSkillScore:500,achievements:{},obstacles:[],portals:[],dangerZone:{active:!1,radius:0},bossesAlive:0,evolutionFlash:0,screenShake:0,screenShakeX:0,screenShakeY:0,foodGrid:null,segmentGrid:null,canvas:null,ctx:null,mmCanvas:null,mmCtx:null,W:0,H:0,dpr:1,damageVignette:0,speedLines:!1,floatTexts:[],foodAbsorbs:[],isMobile:!1,joystick:{active:!1,startX:0,startY:0,currentX:0,currentY:0,id:null}},P={WORLD_W:5e3,WORLD_H:5e3,FOOD_COUNT:400,ITEM_COUNT:15,AI_COUNT:12,SEGMENT_DIST:6,BASE_SPEED:2.8,BOOST_SPEED:5.2,BOOST_DRAIN:.15,INITIAL_LENGTH:20,HEAD_RADIUS_BASE:14,ITEM_RADIUS:12,MINION_COUNT:5,MINION_DURATION:12e3,MINION_COOLDOWN:25e3,ITEM_DURATION:8e3,EAT_DISTANCE:1.3,BORDER_MARGIN:80,CAMERA_SMOOTH:.08},Z=[{name:"í•‘í¬",h:"#ff6b9d",b:"#ff4477",l:"#ffaac8"},{name:"ë³´ë¼",h:"#c44dff",b:"#9933dd",l:"#dd88ff"},{name:"íŒŒëž‘",h:"#4d8bff",b:"#2266dd",l:"#88bbff"},{name:"í•˜ëŠ˜",h:"#44ddff",b:"#22aadd",l:"#88eeff"},{name:"ì´ˆë¡",h:"#44dd88",b:"#22aa66",l:"#88ffbb"},{name:"ë…¸ëž‘",h:"#ffdd44",b:"#ddaa22",l:"#ffee88"},{name:"ì£¼í™©",h:"#ff8844",b:"#dd6622",l:"#ffbb88"},{name:"ë¹¨ê°•",h:"#ff4455",b:"#dd2233",l:"#ff8899"}],Oe=[{id:"speed",icon:"âš¡",name:"ê°€ì†",color:"#ffdd44",desc:"ì´ë™ ì†ë„ ì¦ê°€"},{id:"shield",icon:"ðŸ›¡ï¸",name:"ë°©ì–´ë§‰",color:"#44ddff",desc:"ì¼ì • ì‹œê°„ ë¬´ì "},{id:"magnet",icon:"ðŸ§²",name:"ìžì„",color:"#ff4455",desc:"ì£¼ë³€ ë¨¹ì´ í¡ìˆ˜"},{id:"growth",icon:"â­",name:"ì„±ìž¥",color:"#44dd88",desc:"ì¦‰ì‹œ ì„±ìž¥"},{id:"freeze",icon:"â„ï¸",name:"ë¹™ê²°",color:"#aaddff",desc:"ì£¼ë³€ ì  ê°ì†"}],Ee=["ë³„ì´","ë‹¬ì´","í•´í”¼","ëŸ­í‚¤","ì½”ì½”","ëª¨ëª¨","ë‘ë¶€","ì½©ì´","ë‚˜ë¹„","ë´„ì´","í•˜ë£¨","ì†Œë¼","êµ¬ë¦„","ë°”ë‹¤","í’€ìžŽ","ê½ƒìžŽ"],G=[{name:"ì•„ê¸° ì§€ë ì´",icon:"ðŸ›",minScore:0,turnMod:1,eatMod:1,decoration:null,headScale:1,colorIntensity:1,eyeStyle:"baby",aura:null,trailParticles:!1},{name:"ì§€ë ì´",icon:"ðŸª±",minScore:10,turnMod:1.05,eatMod:1.05,decoration:null,headScale:1.06,colorIntensity:1.1,eyeStyle:"alert",aura:{color:"255,220,100",radius:1.8,alpha:.18,pulse:1.5},trailParticles:!1},{name:"í° ì§€ë ì´",icon:"ðŸ",minScore:30,turnMod:1.1,eatMod:1.1,decoration:"horns",headScale:1.15,colorIntensity:1.2,eyeStyle:"fierce",aura:{color:"255,160,60",radius:2.2,alpha:.25,pulse:2},trailParticles:!1},{name:"ë±€",icon:"ðŸ‘‘",minScore:60,turnMod:1.2,eatMod:1.2,decoration:"crown",headScale:1.25,colorIntensity:1.35,eyeStyle:"regal",aura:{color:"200,120,255",radius:2.6,alpha:.3,pulse:2.5},trailParticles:!1},{name:"ìš©",icon:"ðŸ‰",minScore:120,turnMod:1.3,eatMod:1.3,decoration:"wings",headScale:1.35,colorIntensity:1.5,eyeStyle:"dragon",aura:{color:"255,80,30",radius:3,alpha:.35,pulse:3},trailParticles:!0}],Y={DURATION:60,FOOD_PER_WAVE:30,AI_PER_WAVE:2,AI_LENGTH_PER_WAVE:10,BOSS_WAVES:[3,6,9,12],BOSS_LENGTH_MULT:3,WAVE_BONUS_MULT:20},Ie=[{id:"speedUp",icon:"ðŸ’¨",name:"ì§€ì† ë¶€ìŠ¤íŠ¸",desc:"ê¸°ë³¸ ì´ë™ì†ë„ +10%",maxLevel:3,effect:{speedMult:.1}},{id:"fastMove",icon:"âš¡",name:"ë¹ ë¥¸ ì´ë™",desc:"ë¶€ìŠ¤íŠ¸ ë“œë ˆì¸ -20%",maxLevel:3,effect:{boostDrainMult:-.2}},{id:"wideEat",icon:"ðŸ‘„",name:"ë„“ì€ ìž…",desc:"ë¨¹ê¸° ë²”ìœ„ +15%",maxLevel:3,effect:{eatRadiusMult:.15}},{id:"moreMinions",icon:"ðŸ‘¥",name:"ë¶€í•˜ ì¦ì›",desc:"ì†Œí™˜ ë¶€í•˜ +2",maxLevel:2,effect:{minionCountBonus:2}},{id:"fastSummon",icon:"ðŸ”„",name:"ë¹ ë¥¸ ì†Œí™˜",desc:"ì†Œí™˜ ì¿¨ë‹¤ìš´ -25%",maxLevel:2,effect:{minionCdMult:-.25}},{id:"autoMagnet",icon:"ðŸ§²",name:"ìžë™ í¡ìˆ˜",desc:"ê·¼ì²˜ ë¨¹ì´ ìžë™ í¡ìˆ˜",maxLevel:1,effect:{autoMagnet:!0}},{id:"regen",icon:"ðŸ’š",name:"ìž¬ìƒ",desc:"ì´ˆë‹¹ ê¸¸ì´ +0.5 ìž¬ìƒ",maxLevel:3,effect:{regenPerSec:.5}},{id:"shield",icon:"ðŸ›¡ï¸",name:"ë³´í˜¸ë§‰",desc:"ë¶€í™œ 1íšŒ (ê¸¸ì´ 50%)",maxLevel:1,effect:{revive:!0}},{id:"scoreBoost",icon:"ðŸ’°",name:"ì ìˆ˜ ë¶€ìŠ¤íŠ¸",desc:"ì ìˆ˜ íšë“ +20%",maxLevel:3,effect:{scoreMult:.2}},{id:"freezeAura",icon:"â„ï¸",name:"ëƒ‰ê¸° ì˜¤ë¼",desc:"ê·¼ì²˜ ì  10% ê°ì†",maxLevel:2,effect:{freezeAura:.1}}],fe=[{id:"firstKill",icon:"ðŸ—¡ï¸",name:"ì²« ì‚¬ëƒ¥",desc:"ì²˜ìŒìœ¼ë¡œ ì ì„ ì²˜ì¹˜",check:t=>t.killCount>=1},{id:"kill10",icon:"âš”ï¸",name:"ì‚¬ëƒ¥ê¾¼",desc:"í•œ ê²Œìž„ì—ì„œ 10í‚¬",check:t=>t.killCount>=10},{id:"length100",icon:"ðŸ“",name:"ê¸´ ëª¸",desc:"ê¸¸ì´ 100 ë„ë‹¬",check:t=>t.player&&t.player.length>=100},{id:"length300",icon:"ðŸ²",name:"ëŒ€ìž¥ ì§€ë ì´",desc:"ê¸¸ì´ 300 ë„ë‹¬",check:t=>t.player&&t.player.length>=300},{id:"survive3m",icon:"â±ï¸",name:"3ë¶„ ìƒì¡´",desc:"3ë¶„ê°„ ìƒì¡´",check:t=>t.survivalTime>=180},{id:"survive5m",icon:"ðŸ•",name:"5ë¶„ ìƒì¡´",desc:"5ë¶„ê°„ ìƒì¡´",check:t=>t.survivalTime>=300},{id:"score1000",icon:"â­",name:"ì²œì ",desc:"ì ìˆ˜ 1000 ë„ë‹¬",check:t=>t.player&&t.player.score>=1e3},{id:"score5000",icon:"ðŸŒŸ",name:"ë§Œì ì™•",desc:"ì ìˆ˜ 5000 ë„ë‹¬",check:t=>t.player&&t.player.score>=5e3},{id:"evolveDragon",icon:"ðŸ‰",name:"ìš© ì§„í™”",desc:"ìš©ìœ¼ë¡œ ì§„í™”",check:t=>t.player&&t.player.evolutionStage>=4},{id:"wave5",icon:"ðŸŒŠ",name:"ì›¨ì´ë¸Œ 5",desc:"ì›¨ì´ë¸Œ 5 ë„ë‹¬",check:t=>t.wave>=5},{id:"bossKill",icon:"ðŸ’€",name:"ë³´ìŠ¤ ì²˜ì¹˜",desc:"ë³´ìŠ¤ë¥¼ ì²˜ì¹˜",check:t=>t._bossKilled},{id:"skillMaster",icon:"ðŸŽ“",name:"ìŠ¤í‚¬ ë§ˆìŠ¤í„°",desc:"ìŠ¤í‚¬ 5ê°œ ì´ìƒ ì„ íƒ",check:t=>t.selectedSkills&&t.selectedSkills.length>=5}],V=[{id:"small",weight:60,radiusMin:2.5,radiusMax:4,scoreValue:5,growValue:1,golden:!1},{id:"medium",weight:25,radiusMin:4.5,radiusMax:6.5,scoreValue:10,growValue:2,golden:!1},{id:"large",weight:10,radiusMin:7,radiusMax:9,scoreValue:25,growValue:4,golden:!1},{id:"golden",weight:5,radiusMin:5,radiusMax:7,scoreValue:50,growValue:6,golden:!0}],tt=V.reduce((t,e)=>t+e.weight,0),$e=[];{let t=0;for(const e of V)t+=e.weight,$e.push(t)}function ot(){const t=Math.random()*tt;for(let e=0;e<V.length;e++)if(t<$e[e])return V[e];return V[0]}const $={OBSTACLES_PER_WAVE:3,MAX_OBSTACLES:30,OBSTACLE_RADIUS_MIN:20,OBSTACLE_RADIUS_MAX:60,PORTALS_EVERY_N_WAVES:2,MAX_PORTAL_PAIRS:5,PORTAL_RADIUS:25,PORTAL_COOLDOWN:3e3,DANGER_ZONE_START_WAVE:5,DANGER_ZONE_SHRINK_RATE:2,DANGER_ZONE_MIN_RADIUS:800,DANGER_ZONE_DAMAGE:.5};function _(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}function oe(t,e,s){return t+(e-t)*s}function z(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function A(t,e){return t+Math.random()*(e-t)}function Q(t,e){return Math.floor(A(t,e+1))}function Ae(t,e,s){return Math.max(e,Math.min(s,t))}function ke(){return{x:A(200,P.WORLD_W-200),y:A(200,P.WORLD_H-200)}}const se=[];for(let t=4;t<=45;t+=2)se.push(t);const Se=new Map;function Ne(t,e,s=0){const o=Math.ceil((e+6)*2),l=document.createElement("canvas");l.width=o,l.height=o;const a=l.getContext("2d"),i=o/2,h=o/2,r=e;return s===0?at(a,i,h,r,t):s===1?st(a,i,h,r,t):s===2?nt(a,i,h,r,t):s===3?it(a,i,h,r,t):s>=4?lt(a,i,h,r,t):l}function at(t,e,s,n,o){t.shadowColor="rgba(0,0,0,0.2)",t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=3,t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const l=t.createRadialGradient(e-n*.3,s-n*.3,0,e,s,n);return l.addColorStop(0,"#ffffff"),l.addColorStop(.3,o.l),l.addColorStop(.7,o.h),l.addColorStop(1,o.b),t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.fillStyle=l,t.fill(),t.beginPath(),t.ellipse(e-n*.2,s-n*.2,n*.4,n*.3,0,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.4)",t.fill(),t.canvas}function st(t,e,s,n,o){t.shadowColor="rgba(0,0,0,0.25)",t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=3,t.beginPath(),t.ellipse(e,s,n*1.1,n*.9,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const l=t.createRadialGradient(e-n*.3,s-n*.3,0,e,s,n);return l.addColorStop(0,o.l),l.addColorStop(.35,o.h),l.addColorStop(.7,o.b),l.addColorStop(1,ne(o.b,.7)),t.beginPath(),t.ellipse(e,s,n*1.1,n*.9,0,0,Math.PI*2),t.fillStyle=l,t.fill(),t.beginPath(),t.ellipse(e-n*.15,s-n*.35,n*.6,n*.25,-.3,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.25)",t.fill(),t.canvas}function nt(t,e,s,n,o){const l=n*1.15,a=n*.9;t.shadowColor="rgba(0,0,0,0.4)",t.shadowOffsetX=1.5,t.shadowOffsetY=3,t.shadowBlur=6,t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const i=t.createRadialGradient(e-l*.25,s-a*.35,0,e,s,l*1.1);i.addColorStop(0,ae(o.h,1.4)),i.addColorStop(.15,ae(o.h,1.15)),i.addColorStop(.4,o.h),i.addColorStop(.7,o.b),i.addColorStop(.85,ne(o.b,.8)),i.addColorStop(1,ne(o.b,.5)),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle=i,t.fill(),t.save(),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.clip();const h=Math.max(4,n*.25),r=Math.ceil(a*2/(h*.6)),f=Math.ceil(l*2/(h*.8));for(let g=0;g<r;g++)for(let u=0;u<f;u++){const p=g%2*h*.4,m=e-l+u*h*.8+p,y=s-a+g*h*.6,C=t.createRadialGradient(m-h*.1,y-h*.1,0,m,y,h*.4);C.addColorStop(0,"rgba(255,255,255,0.15)"),C.addColorStop(.5,"rgba(255,255,255,0.05)"),C.addColorStop(1,"rgba(0,0,0,0.1)"),t.beginPath(),t.ellipse(m,y,h*.35,h*.25,Math.PI*.1,0,Math.PI*2),t.fillStyle=C,t.fill(),t.strokeStyle="rgba(0,0,0,0.08)",t.lineWidth=.3,t.stroke()}t.restore();const c=t.createLinearGradient(e,s-a*.2,e,s+a*.6);return c.addColorStop(0,"rgba(255,255,255,0)"),c.addColorStop(.3,"rgba(255,255,255,0.12)"),c.addColorStop(.7,"rgba(255,255,255,0.08)"),c.addColorStop(1,"rgba(255,255,255,0)"),t.beginPath(),t.ellipse(e,s+a*.1,l*.6,a*.4,0,0,Math.PI*2),t.fillStyle=c,t.fill(),t.beginPath(),t.ellipse(e-l*.15,s-a*.25,l*.5,a*.15,-.2,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.2)",t.fill(),t.canvas}function it(t,e,s,n,o){const l=n*1.25,a=n*.95;t.shadowColor="rgba(0,0,0,0.5)",t.shadowOffsetX=2,t.shadowOffsetY=4,t.shadowBlur=8,t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const i=t.createRadialGradient(e-l*.2,s-a*.3,0,e,s,l*1.2);i.addColorStop(0,"#fffacd"),i.addColorStop(.1,"#ffd700"),i.addColorStop(.25,"#ffed4e"),i.addColorStop(.4,o.h),i.addColorStop(.6,"#daa520"),i.addColorStop(.8,o.b),i.addColorStop(1,"#8b6914"),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle=i,t.fill(),t.save(),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.clip();const h=Math.max(5,n*.28),r=h*Math.sqrt(3)/2,f=Math.ceil(a*2/(r*1.5)),c=Math.ceil(l*2/(h*1.5));for(let u=0;u<f;u++)for(let p=0;p<c;p++){const m=u%2*h*.75,y=e-l+p*h*1.5+m,C=s-a+u*r*1.5,v=t.createRadialGradient(y-h*.2,C-h*.2,0,y,C,h*.6);v.addColorStop(0,"rgba(255,255,200,0.4)"),v.addColorStop(.3,"rgba(255,215,0,0.25)"),v.addColorStop(.7,"rgba(218,165,32,0.15)"),v.addColorStop(1,"rgba(139,105,20,0.2)"),t.beginPath();for(let S=0;S<6;S++){const T=S*Math.PI/3,b=y+Math.cos(T)*h*.35,I=C+Math.sin(T)*h*.35;S===0?t.moveTo(b,I):t.lineTo(b,I)}t.closePath(),t.fillStyle=v,t.fill(),t.strokeStyle="rgba(184,134,11,0.4)",t.lineWidth=.8,t.stroke(),t.beginPath(),t.arc(y,C,1.5,0,Math.PI*2),t.fillStyle="rgba(255,255,100,0.9)",t.fill()}t.restore();const g=t.createLinearGradient(e,s-a*.3,e,s+a*.5);return g.addColorStop(0,"rgba(255,255,255,0)"),g.addColorStop(.2,"rgba(255,255,200,0.25)"),g.addColorStop(.5,"rgba(255,215,0,0.15)"),g.addColorStop(.8,"rgba(255,255,200,0.1)"),g.addColorStop(1,"rgba(255,255,255,0)"),t.beginPath(),t.ellipse(e,s+a*.05,l*.7,a*.5,0,0,Math.PI*2),t.fillStyle=g,t.fill(),t.beginPath(),t.ellipse(e-l*.1,s-a*.3,l*.6,a*.2,-.15,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.3)",t.fill(),t.beginPath(),t.ellipse(e-l*.2,s-a*.15,l*.3,a*.1,-.2,0,Math.PI*2),t.fillStyle="rgba(255,215,0,0.2)",t.fill(),t.canvas}function lt(t,e,s,n,o){const l=n*1.35,a=n*1.05;t.shadowColor="rgba(0,0,0,0.6)",t.shadowOffsetX=3,t.shadowOffsetY=5,t.shadowBlur=10,t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const i=t.createRadialGradient(e-l*.25,s-a*.3,0,e,s,l*1.3);i.addColorStop(0,ae(o.h,1.8)),i.addColorStop(.08,ae(o.h,1.5)),i.addColorStop(.2,ae(o.h,1.2)),i.addColorStop(.35,o.h),i.addColorStop(.5,o.b),i.addColorStop(.65,ne(o.b,.8)),i.addColorStop(.8,ne(o.b,.6)),i.addColorStop(.92,"#2d1810"),i.addColorStop(1,"#0a0000"),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.fillStyle=i,t.fill(),t.save(),t.beginPath(),t.ellipse(e,s,l,a,0,0,Math.PI*2),t.clip();const h=Math.max(6,n*.3),r=Math.ceil(a*2/(h*.7)),f=Math.ceil(l*2/(h*.9));for(let p=0;p<r;p++)for(let m=0;m<f;m++){const y=p%2*h*.45,C=e-l+m*h*.9+y,v=s-a+p*h*.7,S=t.createRadialGradient(C-h*.15,v-h*.2,0,C,v,h*.5);S.addColorStop(0,"rgba(255,200,100,0.3)"),S.addColorStop(.3,"rgba(255,120,0,0.2)"),S.addColorStop(.7,"rgba(200,60,0,0.15)"),S.addColorStop(1,"rgba(100,20,0,0.25)"),t.beginPath();for(let b=0;b<5;b++){const I=b*2*Math.PI/5-Math.PI/2+p*.1,w=h*(.35+Math.sin(b*1.2)*.05),O=C+Math.cos(I)*w,R=v+Math.sin(I)*w;b===0?t.moveTo(O,R):t.lineTo(O,R)}t.closePath(),t.fillStyle=S,t.fill(),t.strokeStyle="rgba(255,80,20,0.4)",t.lineWidth=1.2,t.stroke();const T=t.createRadialGradient(C,v,0,C,v,2.5);T.addColorStop(0,"rgba(255,255,200,0.9)"),T.addColorStop(.5,"rgba(255,150,0,0.7)"),T.addColorStop(1,"rgba(200,50,0,0.3)"),t.beginPath(),t.arc(C,v,2,0,Math.PI*2),t.fillStyle=T,t.fill()}t.restore();const c=t.createLinearGradient(e,s-a*.4,e,s+a*.6);c.addColorStop(0,"rgba(255,100,0,0)"),c.addColorStop(.2,"rgba(255,180,50,0.15)"),c.addColorStop(.4,"rgba(255,120,0,0.25)"),c.addColorStop(.6,"rgba(255,180,50,0.2)"),c.addColorStop(.8,"rgba(255,100,0,0.1)"),c.addColorStop(1,"rgba(255,100,0,0)"),t.beginPath(),t.ellipse(e,s+a*.05,l*.8,a*.6,0,0,Math.PI*2),t.fillStyle=c,t.fill();const g=t.createRadialGradient(e-l*.2,s-a*.35,0,e,s-a*.2,l*.6);g.addColorStop(0,"rgba(255,255,255,0.4)"),g.addColorStop(.3,"rgba(255,200,100,0.25)"),g.addColorStop(.7,"rgba(255,150,50,0.15)"),g.addColorStop(1,"rgba(255,100,0,0.05)"),t.beginPath(),t.ellipse(e-l*.1,s-a*.3,l*.6,a*.25,-.1,0,Math.PI*2),t.fillStyle=g,t.fill();const u=t.createRadialGradient(e,s,a*.5,e,s,a*1.2);return u.addColorStop(0,"rgba(255,100,0,0)"),u.addColorStop(.6,"rgba(255,80,20,0.08)"),u.addColorStop(.8,"rgba(255,60,0,0.15)"),u.addColorStop(1,"rgba(200,40,0,0.08)"),t.beginPath(),t.ellipse(e,s,l*1.1,a*1.1,0,0,Math.PI*2),t.fillStyle=u,t.fill(),t.canvas}function ae(t,e){const s=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),l=Math.min(255,Math.round(s*e)),a=Math.min(255,Math.round(n*e)),i=Math.min(255,Math.round(o*e));return`rgb(${l},${a},${i})`}function rt(t,e,s=0){const n=Ne(t,e,s),o=n.getContext("2d"),l=n.width/2,a=n.height/2,i=e;if(s===0||s===1)o.beginPath(),o.arc(l,a,i*.82,0,Math.PI*2),o.strokeStyle="rgba(255,255,255,0.1)",o.lineWidth=Math.max(1.5,i*.12),o.stroke();else if(s===2){o.save(),o.beginPath(),o.arc(l,a,i,0,Math.PI*2),o.clip(),o.strokeStyle="rgba(255,255,255,0.15)",o.lineWidth=2,o.beginPath();const h=8;for(let r=0;r<=h;r++){const f=r/h*Math.PI*2,c=i*.7,g=i*.9,u=r%2===0?c:g,p=l+Math.cos(f)*u,m=a+Math.sin(f)*u;r===0?o.moveTo(p,m):o.lineTo(p,m)}o.closePath(),o.stroke(),o.restore()}else if(s===3)o.beginPath(),o.arc(l,a,i*.85,0,Math.PI*2),o.strokeStyle="rgba(255,215,0,0.4)",o.lineWidth=Math.max(2,i*.15),o.stroke(),o.beginPath(),o.arc(l,a,i*.7,0,Math.PI*2),o.strokeStyle="rgba(255,255,100,0.3)",o.lineWidth=Math.max(1,i*.08),o.stroke();else if(s>=4){o.save(),o.beginPath(),o.arc(l,a,i,0,Math.PI*2),o.clip(),o.strokeStyle="rgba(255,100,0,0.3)",o.lineWidth=2.5,o.beginPath();const h=12;for(let r=0;r<=h;r++){const f=r/h*Math.PI*2,c=i*.75,g=Math.sin(r*1.5)*i*.15,u=c+g,p=l+Math.cos(f)*u,m=a+Math.sin(f)*u;r===0?o.moveTo(p,m):o.lineTo(p,m)}o.closePath(),o.stroke(),o.strokeStyle="rgba(255,150,0,0.2)",o.lineWidth=1,o.beginPath(),o.arc(l,a,i*.6,0,Math.PI*2),o.stroke(),o.restore()}return n}function ne(t,e){const s=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),l=Math.round(s*e),a=Math.round(n*e),i=Math.round(o*e);return`rgb(${l},${a},${i})`}function dt(){const t=[0,1,2,3,4];for(let e=0;e<Z.length;e++){const s=Z[e];for(let n=0;n<se.length;n++){const o=se[n];for(const l of t){const a=l>0?`_e${l}`:"";Se.set(`${e}_${n}${a}`,Ne(s,o,l)),Se.set(`${e}_${n}_s${a}`,rt(s,o,l))}}}}function ht(t){const e=Math.round((t-4)/2);return Math.max(0,Math.min(se.length-1,e))}function ft(t,e,s,n=0){const o=ht(e),l=n>=1?`_e${Math.min(n,4)}`:"",a=s?`${t}_${o}_s${l}`:`${t}_${o}${l}`;return{sprite:Se.get(a),spriteRadius:se[o]}}function ct(t){let e=0;for(let s=G.length-1;s>=0;s--)if(t>=G[s].minScore){e=s;break}return e}function gt(t){const e=ct(t.score);if(e!==t.evolutionStage){const s=t.evolutionStage;return t.evolutionStage=e,{evolved:!0,from:s,to:e,stage:G[e]}}return{evolved:!1}}function ut(t){const e=G[t]||G[0];return{turnMod:e.turnMod,eatMod:e.eatMod}}class ze{constructor(e,s,n=0){this._factory=e,this._reset=s,this._pool=[];for(let o=0;o<n;o++)this._pool.push(this._factory())}acquire(...e){const s=this._pool.length>0?this._pool.pop():this._factory();return this._reset(s,...e),s}release(e){this._pool.push(e)}get poolSize(){return this._pool.length}}class mt{constructor(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.color="",this.size=3,this.life=0,this.decay=0}reset(e,s,n,o=3){return this.x=e,this.y=s,this.vx=A(-3,3),this.vy=A(-3,3),this.color=n,this.size=o,this.life=1,this.decay=A(.02,.05),this}update(e){return this.x+=this.vx*e*60,this.y+=this.vy*e*60,this.vx*=.96,this.vy*=.96,this.life-=this.decay*e*60,this.life>0}draw(e,s){const{W:n,H:o}=d,l=this.x-s.x+n/2,a=this.y-s.y+o/2;l<-10||l>n+10||a<-10||a>o+10||(e.beginPath(),e.arc(l,a,this.size*this.life,0,Math.PI*2),e.fillStyle=this.color,e.globalAlpha=this.life*.7,e.fill(),e.globalAlpha=1)}}const K=new ze(()=>new mt,(t,e,s,n,o)=>t.reset(e,s,n,o),200);class ue{constructor(e,s,n,o,l=!1,a=!1){this.segments=[],this.colorIdx=n,this.color=Z[n],this.name=o,this.isPlayer=l,this.isMinion=a,this.alive=!0,this.length=P.INITIAL_LENGTH,this.score=0,this.angle=Math.random()*Math.PI*2,this.targetAngle=this.angle,this.speed=P.BASE_SPEED,this.boosting=!1,this.shielded=!1,this.magnetized=!1,this.frozen=!1,this.frozenTimer=0,this.speedBoosted=!1,this.wobble=Math.random()*100,this.eyeBlink=0,this.minionOwner=null,this.minionTimer=0,this.kills=0,this.evolutionStage=0,this.isBoss=!1,this._flameTimer=0,this.aiTimer=0,this.aiTarget=null,this.aiState="wander";for(let i=0;i<this.length;i++)this.segments.push({x:e-i*P.SEGMENT_DIST*Math.cos(this.angle),y:s-i*P.SEGMENT_DIST*Math.sin(this.angle)})}get head(){return this.segments[0]}get radius(){const e=G[this.evolutionStage]||G[0];return(P.HEAD_RADIUS_BASE+Math.min(this.length*.12,20))*(e.headScale||1)}bodyRadius(e){const s=this.radius,n=e/this.segments.length;if(n<.08)return s*oe(.85,1,n/.08);if(n>.65){const l=(n-.65)/.35;return s*oe(.95,.25,l*l)}const o=Math.sin(this.wobble*10+e*.5)*.02;return s*(.95+o)}update(e){if(!this.alive)return;this.wobble+=e*3,this.eyeBlink=(this.eyeBlink+e)%4,this.frozenTimer>0&&(this.frozenTimer-=e*1e3,this.frozen=this.frozenTimer>0);const s=this.isPlayer?d.skillModifiers||{}:{},n=1+(s.speedMult||0),o=Math.max(.1,1+(s.boostDrainMult||0)),l=this.frozen?.4:this.speedBoosted?1.4:1,a=this.boosting?P.BOOST_SPEED:P.BASE_SPEED;if(this.speed=a*l*n,this.boosting&&this.length>8){const y=1+(this.length>100?(this.length-100)*.002:0);this.length-=P.BOOST_DRAIN*o*y*e,this.length<8&&(this.length=8,this.boosting=!1)}this.isPlayer&&s.regenPerSec&&(this.length+=s.regenPerSec*e);let i=this.targetAngle-this.angle;for(;i>Math.PI;)i-=Math.PI*2;for(;i<-Math.PI;)i+=Math.PI*2;const h=ut(this.evolutionStage),r=(this.isMinion?.15:.1)*h.turnMod;this.angle+=i*r;const f=this.speed*e*60,c=this.head.x+Math.cos(this.angle)*f,g=this.head.y+Math.sin(this.angle)*f,u=P.BORDER_MARGIN;this.head.x=Ae(c,u,P.WORLD_W-u),this.head.y=Ae(g,u,P.WORLD_H-u);for(let y=1;y<this.segments.length;y++){const C=this.segments[y-1],v=this.segments[y],S=z(v,C);_(v,C)>P.SEGMENT_DIST&&(v.x=C.x-Math.cos(S)*P.SEGMENT_DIST,v.y=C.y-Math.sin(S)*P.SEGMENT_DIST)}const p=Math.floor(this.length);for(;this.segments.length<p;){const y=this.segments[this.segments.length-1];this.segments.push({x:y.x,y:y.y})}for(;this.segments.length>p+5;)this.segments.pop();if((this.head.x<=u||this.head.x>=P.WORLD_W-u||this.head.y<=u||this.head.y>=P.WORLD_H-u)&&(this.targetAngle=z(this.head,{x:P.WORLD_W/2,y:P.WORLD_H/2})),this.isMinion&&(this.minionTimer-=e*1e3,this.minionTimer<=0&&(this.alive=!1)),(G[this.evolutionStage]||G[0]).trailParticles&&this.segments.length>5&&(this._flameTimer+=e,this._flameTimer>.1&&d.particles.length<200)){this._flameTimer=0;const y=this.segments[Math.min(4,this.segments.length-1)],C=["#ff4400","#ff6600","#ff8800","#ffaa00","#ffcc00"],v=C[Math.random()*C.length|0],S=K.acquire(y.x+(Math.random()-.5)*10,y.y+(Math.random()-.5)*10,v,3+Math.random()*4);d.particles.push(S)}}draw(e,s){if(!this.alive)return;const{W:n,H:o}=d,l=-s.x+n/2,a=-s.y+o/2,i=this.head.x+l,h=this.head.y+a;if(i<-250||i>n+250||h<-250||h>o+250)return;const r=G[this.evolutionStage]||G[0],f=this.evolutionStage,c=-l-20,g=-l+n+20,u=-a-20,p=-a+o+20;if(f>=2&&r.aura){const v=r.aura.color,S=f>=4?.25:f>=3?.18:.12,T=f>=4?6:f>=3?4:3;for(let b=this.segments.length-1;b>=0;b-=5){const I=this.segments[b];if(I.x<c||I.x>g||I.y<u||I.y>p)continue;const w=I.x+l,O=I.y+a,R=this.bodyRadius(b),E=Math.sin(this.wobble*2+b*.15)*.3+1;e.beginPath(),e.arc(w,O,R+T*E,0,Math.PI*2),e.fillStyle=`rgba(${v},${S*E})`,e.fill()}}if(this.isBoss)for(let v=this.segments.length-1;v>=0;v-=4){const S=this.segments[v];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const T=S.x+l,b=S.y+a,I=this.bodyRadius(v);e.beginPath(),e.arc(T,b,I+3,0,Math.PI*2),e.fillStyle=`rgba(255,50,50,${.15+Math.sin(this.wobble*2+v*.3)*.1})`,e.fill()}e.lineCap="round";for(let v=this.segments.length-1;v>=2;v-=2){const S=this.segments[v],T=this.segments[v-1];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const b=S.x+l,I=S.y+a,w=T.x+l,O=T.y+a,R=this.bodyRadius(v);e.beginPath(),e.moveTo(b,I),e.lineTo(w,O),e.strokeStyle=this.color.h,e.lineWidth=R*1.7,e.stroke()}const m=n/2,y=o/2,C=this.segments.length>50;for(let v=this.segments.length-1;v>=1;v--){const S=this.segments[v];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const T=S.x+l,b=S.y+a,I=this.bodyRadius(v);if(C&&Math.abs(T-m)+Math.abs(b-y)>Math.min(n,o)*.4){e.beginPath(),e.arc(T,b,I,0,Math.PI*2),e.fillStyle=this.color.h,e.fill();continue}const w=v%4===0,{sprite:O,spriteRadius:R}=ft(this.colorIdx,I,w,f);if(O){const E=I/R,L=O.width*E;e.drawImage(O,T-L/2,b-L/2,L,L)}}if(this.shielded){const v=this.head.x+l,S=this.head.y+a;e.beginPath(),e.arc(v,S,this.radius+12+Math.sin(this.wobble)*3,0,Math.PI*2),e.strokeStyle=`rgba(68, 221, 255, ${.4+Math.sin(this.wobble*2)*.2})`,e.lineWidth=3,e.stroke(),e.fillStyle="rgba(68, 221, 255, 0.08)",e.fill()}if(this.drawHead(e,l,a),this.segments.length>10&&this.drawTailEffect(e,l,a,f),!this.isMinion){const v=this.head.x+l,S=this.head.y+a-this.radius-16;if(e.font='bold 13px "Segoe UI", sans-serif',e.textAlign="center",this.isBoss){const T=`ðŸ’€ ${this.name}`,b=e.measureText(T).width,I=v-b/2-6,w=S-12,O=b+12,R=18,E=6;e.fillStyle="rgba(180,20,20,0.7)",e.beginPath(),e.moveTo(I+E,w),e.lineTo(I+O-E,w),e.arcTo(I+O,w,I+O,w+E,E),e.lineTo(I+O,w+R-E),e.arcTo(I+O,w+R,I+O-E,w+R,E),e.lineTo(I+E,w+R),e.arcTo(I,w+R,I,w+R-E,E),e.lineTo(I,w+E),e.arcTo(I,w,I+E,w,E),e.closePath(),e.fill(),e.fillStyle="#ff8888",e.fillText(T,v,S)}else e.fillStyle="rgba(0,0,0,0.4)",e.fillText(this.name,v,S+1),e.fillStyle="#fff",e.fillText(this.name,v,S)}}drawHead(e,s,n){const o=this.head.x+s,l=this.head.y+n,a=this.radius,i=G[this.evolutionStage]||G[0],h=this.evolutionStage;h===0?this.drawBabyWormHead(e,o,l,a,i):h===1?this.drawWormHead(e,o,l,a,i):h===2?this.drawSnakeHead(e,o,l,a,i):h===3?this.drawKingSnakeHead(e,o,l,a,i):h>=4&&this.drawDragonHead(e,o,l,a,i)}drawBabyWormHead(e,s,n,o,l){this.drawBodyConnector(e,s,n,o),this.drawAuraAndBossEffects(e,s,n,o,l),e.shadowColor="rgba(0,0,0,0.2)",e.shadowOffsetX=1,e.shadowOffsetY=2,e.shadowBlur=4;const a=e.createRadialGradient(s-o*.3,n-o*.3,0,s,n,o);a.addColorStop(0,"#ffffff"),a.addColorStop(.3,this.color.l),a.addColorStop(.7,this.color.h),a.addColorStop(1,this.color.b),e.beginPath(),e.arc(s,n,o,0,Math.PI*2),e.fillStyle=a,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.beginPath(),e.arc(s-o*.2,n-o*.2,o*.4,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.6)",e.fill();const i=o*.3,h=o*.35,r=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,s+Math.cos(this.angle-.5)*i,n+Math.sin(this.angle-.5)*i,h,r,"baby"),this.drawEye(e,s+Math.cos(this.angle+.5)*i,n+Math.sin(this.angle+.5)*i,h,r,"baby");const f=o*.6;e.fillStyle="rgba(255, 150, 170, 0.4)";for(const g of[this.angle-1.2,this.angle+1.2])e.beginPath(),e.arc(s+Math.cos(g)*f,n+Math.sin(g)*f,o*.25,0,Math.PI*2),e.fill();e.beginPath();const c=o*.4;e.arc(s+Math.cos(this.angle)*c,n+Math.sin(this.angle)*c,o*.2,this.angle+.2,this.angle+Math.PI-.2),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=2,e.lineCap="round",e.stroke()}drawWormHead(e,s,n,o,l){this.drawBodyConnector(e,s,n,o),this.drawAuraAndBossEffects(e,s,n,o,l),e.shadowColor="rgba(0,0,0,0.25)",e.shadowOffsetX=1,e.shadowOffsetY=2,e.shadowBlur=4;const a=e.createRadialGradient(s-o*.3,n-o*.3,0,s,n,o);a.addColorStop(0,this.color.l),a.addColorStop(.4,this.color.h),a.addColorStop(.8,this.color.b),a.addColorStop(1,this.darkenColor(this.color.b,.7)),e.beginPath(),e.ellipse(s,n,o*1.1,o*.9,this.angle,0,Math.PI*2),e.fillStyle=a,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.beginPath(),e.ellipse(s-o*.15,n-o*.25,o*.5,o*.3,this.angle-.3,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.3)",e.fill();const i=o*.35,h=o*.3,r=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,s+Math.cos(this.angle-.4)*i,n+Math.sin(this.angle-.4)*i,h,r,"alert"),this.drawEye(e,s+Math.cos(this.angle+.4)*i,n+Math.sin(this.angle+.4)*i,h,r,"alert"),this.drawMouthAndTongue(e,s,n,o,!1)}drawSnakeHead(e,s,n,o,l){this.drawBodyConnector(e,s,n,o),this.drawAuraAndBossEffects(e,s,n,o,l),e.save(),e.translate(s,n),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.4)",e.shadowOffsetX=2.5,e.shadowOffsetY=4,e.shadowBlur=8;const a=o*1.6,i=o*1.1,h=o*.85,r=e.createRadialGradient(-a*.2,-i*.15,0,0,0,a*.8);r.addColorStop(0,this.lightenColor(this.color.h,1.5)),r.addColorStop(.2,this.lightenColor(this.color.h,1.2)),r.addColorStop(.45,this.color.h),r.addColorStop(.75,this.color.b),r.addColorStop(1,this.darkenColor(this.color.b,.7)),e.beginPath(),e.moveTo(a*.65,0),e.bezierCurveTo(a*.4,-i*.25,a*.1,-i*.45,-a*.1,-i*.4),e.bezierCurveTo(-a*.3,-h*.35,-a*.5,-h*.15,-a*.6,0),e.bezierCurveTo(-a*.5,h*.15,-a*.3,h*.35,-a*.1,i*.4),e.bezierCurveTo(a*.1,i*.45,a*.4,i*.25,a*.65,0),e.closePath(),e.fillStyle=r,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip();const f=4,c=6;for(let T=0;T<f;T++)for(let b=0;b<c;b++){const I=T/(f-1),w=-a*.4+I*a*.8,O=i*(.3+.4*Math.sin(I*Math.PI)),R=-O+b/(c-1)*O*2,E=o*(.15+I*.1),L=e.createRadialGradient(w-E*.2,R-E*.2,0,w,R,E);L.addColorStop(0,"rgba(255,255,255,0.2)"),L.addColorStop(.5,"rgba(255,255,255,0.08)"),L.addColorStop(1,"rgba(0,0,0,0.15)"),e.beginPath(),e.ellipse(w,R,E*.8,E*.5,Math.PI*(.1+I*.1),0,Math.PI*2),e.fillStyle=L,e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.3,e.stroke()}e.restore(),e.beginPath(),e.ellipse(-a*.1,-i*.2,a*.4,i*.15,-.1,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.25)",e.fill(),e.restore();const g=o*.35,u=o*.22,p=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1,m=o*.1,y=s+Math.cos(this.angle-.35)*g-Math.cos(this.angle)*m,C=n+Math.sin(this.angle-.35)*g-Math.sin(this.angle)*m,v=s+Math.cos(this.angle+.35)*g-Math.cos(this.angle)*m,S=n+Math.sin(this.angle+.35)*g-Math.sin(this.angle)*m;this.drawEye(e,y,C,u,p,"fierce"),this.drawEye(e,v,S,u,p,"fierce"),this.drawSnakeTongue(e,s,n,o),this.drawNostrils(e,s,n,o)}drawKingSnakeHead(e,s,n,o,l){this.drawBodyConnector(e,s,n,o),this.drawAuraAndBossEffects(e,s,n,o,l),e.save(),e.translate(s,n),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.4)",e.shadowOffsetX=2,e.shadowOffsetY=4,e.shadowBlur=6;const a=o*1.5,i=o*1.3,h=e.createRadialGradient(-a*.3,-i*.2,0,0,0,a);h.addColorStop(0,"#ffe066"),h.addColorStop(.3,this.color.h),h.addColorStop(.7,this.color.b),h.addColorStop(1,this.darkenColor(this.color.b,.5)),e.beginPath(),e.moveTo(a*.6,0),e.quadraticCurveTo(a*.2,-i*.55,-a*.3,-i*.45),e.quadraticCurveTo(-a*.7,0,-a*.3,i*.45),e.quadraticCurveTo(a*.2,i*.55,a*.6,0),e.closePath(),e.fillStyle=h,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip(),e.strokeStyle="rgba(180,140,0,0.4)",e.fillStyle="rgba(255,215,0,0.2)",e.lineWidth=1;for(let g=0;g<4;g++){const u=-a*.3+g*a*.15,p=g%2*i*.2-i*.1;e.beginPath();for(let m=0;m<6;m++){const y=m*Math.PI/3,C=u+Math.cos(y)*a*.08,v=p+Math.sin(y)*i*.08;m===0?e.moveTo(C,v):e.lineTo(C,v)}e.closePath(),e.fill(),e.stroke()}e.restore(),e.restore(),this.drawCrown(e,s,n,o);const r=o*.45,f=o*.28,c=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,s+Math.cos(this.angle-.25)*r,n+Math.sin(this.angle-.25)*r,f,c,"regal"),this.drawEye(e,s+Math.cos(this.angle+.25)*r,n+Math.sin(this.angle+.25)*r,f,c,"regal"),this.drawSnakeTongue(e,s,n,o),this.drawNostrils(e,s,n,o)}drawDragonHead(e,s,n,o,l){this.drawBodyConnector(e,s,n,o),this.drawAuraAndBossEffects(e,s,n,o,l),this.drawDragonWings(e,s,n,o),e.save(),e.translate(s,n),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.7)",e.shadowOffsetX=4,e.shadowOffsetY=6,e.shadowBlur=12;const a=o*2,i=o*1.3,h=o*1.1,r=o*.9,f=e.createRadialGradient(-a*.15,-i*.25,0,0,0,a*.9);f.addColorStop(0,this.lightenColor(this.color.h,2)),f.addColorStop(.1,this.lightenColor(this.color.h,1.6)),f.addColorStop(.25,this.lightenColor(this.color.h,1.3)),f.addColorStop(.4,this.color.h),f.addColorStop(.55,this.color.b),f.addColorStop(.7,this.darkenColor(this.color.b,.8)),f.addColorStop(.85,"#3d2517"),f.addColorStop(1,"#1a0d06"),e.beginPath(),e.moveTo(a*.75,0),e.bezierCurveTo(a*.6,-i*.15,a*.4,-i*.35,a*.1,-i*.45),e.bezierCurveTo(-a*.1,-i*.5,-a*.3,-i*.35,-a*.5,-i*.2),e.bezierCurveTo(-a*.7,-r*.15,-a*.8,-r*.05,-a*.85,0),e.bezierCurveTo(-a*.8,r*.05,-a*.7,r*.15,-a*.5,i*.25),e.bezierCurveTo(-a*.3,h*.4,-a*.1,h*.5,a*.15,h*.45),e.bezierCurveTo(a*.4,h*.35,a*.6,h*.15,a*.75,0),e.closePath(),e.fillStyle=f,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip();const c=6,g=8;for(let I=0;I<c;I++)for(let w=0;w<g;w++){const O=I/(c-1),R=(w-g/2)/(g/2),E=-a*.6+O*a*.9,L=i*(.2+.6*Math.sin(O*Math.PI*.8)),W=R*L*.8,N=o*(.12+O*.08),M=e.createRadialGradient(E-N*.3,W-N*.3,0,E,W,N*.8);M.addColorStop(0,"rgba(255,240,200,0.4)"),M.addColorStop(.3,"rgba(255,150,50,0.25)"),M.addColorStop(.7,"rgba(200,80,20,0.2)"),M.addColorStop(1,"rgba(100,30,10,0.3)"),e.beginPath();for(let k=0;k<5;k++){const H=k*2*Math.PI/5-Math.PI/2+I*.15,le=N*(.6+Math.sin(k*1.5)*.1),re=E+Math.cos(H)*le,de=W+Math.sin(H)*le;k===0?e.moveTo(re,de):e.lineTo(re,de)}e.closePath(),e.fillStyle=M,e.fill(),e.strokeStyle="rgba(255,100,30,0.5)",e.lineWidth=.8,e.stroke(),e.beginPath(),e.arc(E,W,1.5,0,Math.PI*2),e.fillStyle=`rgba(255,${150+Math.sin(this.wobble*5+I+w)*50},0,0.9)`,e.fill()}e.restore();const u=e.createRadialGradient(-a*.1,-i*.3,0,a*.1,-i*.2,a*.4);u.addColorStop(0,"rgba(255,255,255,0.5)"),u.addColorStop(.3,"rgba(255,220,150,0.3)"),u.addColorStop(.7,"rgba(255,150,50,0.2)"),u.addColorStop(1,"rgba(255,100,0,0.1)"),e.beginPath(),e.ellipse(0,-i*.25,a*.35,i*.2,-.05,0,Math.PI*2),e.fillStyle=u,e.fill(),e.restore(),this.drawDragonHorns(e,s,n,o),this.drawDragonWhiskers(e,s,n,o);const p=o*.45,m=o*.28,y=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1,C=o*.15,v=s+Math.cos(this.angle-.25)*p-Math.cos(this.angle)*C,S=n+Math.sin(this.angle-.25)*p-Math.sin(this.angle)*C,T=s+Math.cos(this.angle+.25)*p-Math.cos(this.angle)*C,b=n+Math.sin(this.angle+.25)*p-Math.sin(this.angle)*C;this.drawEye(e,v,S,m,y,"dragon"),this.drawEye(e,T,b,m,y,"dragon"),this.boosting&&this.drawDragonFire(e,s,n,o),this.drawDragonNostrils(e,s,n,o)}drawBodyConnector(e,s,n,o){if(this.segments.length>1){const l=this.segments[1],{W:a,H:i}=d,h=-d.camera.x+a/2,r=-d.camera.y+i/2,f=l.x+h,c=l.y+r;e.beginPath(),e.moveTo(s,n),e.lineTo(f,c),e.strokeStyle=this.color.h,e.lineWidth=o*1.5,e.lineCap="round",e.stroke()}}drawAuraAndBossEffects(e,s,n,o,l){if(l.aura){const a=l.aura,i=Math.sin(this.wobble*a.pulse)*.2+1,h=o*a.radius*i,r=e.createRadialGradient(s,n,o*.2,s,n,h);r.addColorStop(0,`rgba(${a.color},${a.alpha})`),r.addColorStop(.5,`rgba(${a.color},${a.alpha*.5})`),r.addColorStop(1,`rgba(${a.color},0)`),e.beginPath(),e.arc(s,n,h,0,Math.PI*2),e.fillStyle=r,e.fill()}if(this.isBoss){const a=o+12+Math.sin(this.wobble*2)*5,i=e.createRadialGradient(s,n,o*.3,s,n,a);i.addColorStop(0,"rgba(255,40,40,0.25)"),i.addColorStop(.5,"rgba(255,40,40,0.12)"),i.addColorStop(1,"rgba(255,40,40,0)"),e.beginPath(),e.arc(s,n,a,0,Math.PI*2),e.fillStyle=i,e.fill(),e.beginPath(),e.arc(s,n,o+8+Math.sin(this.wobble*3)*4,0,Math.PI*2),e.strokeStyle=`rgba(255,60,60,${.4+Math.sin(this.wobble*3)*.2})`,e.lineWidth=2.5,e.stroke()}}drawMouthAndTongue(e,s,n,o,l=!1){const a=o*.55,i=s+Math.cos(this.angle)*a,h=n+Math.sin(this.angle)*a,r=this.boosting?.6:.35;if(e.beginPath(),e.arc(i,h,o*r,this.angle+Math.PI*.6,this.angle+Math.PI*1.4),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=Math.max(1,o*.07),e.lineCap="round",e.stroke(),this.boosting||l){const f=o*.65,c=o*.8,g=s+Math.cos(this.angle)*f,u=n+Math.sin(this.angle)*f,p=Math.sin(this.wobble*15)*.2,m=this.angle+Math.PI/2;e.strokeStyle="#cc2222",e.lineWidth=Math.max(1,o*.06),e.lineCap="round",e.beginPath(),e.moveTo(g,u);const y=g+Math.cos(this.angle+p-.15)*c,C=u+Math.sin(this.angle+p-.15)*c,v=g+Math.cos(this.angle)*c*.5+Math.cos(m)*o*.05,S=u+Math.sin(this.angle)*c*.5+Math.sin(m)*o*.05;e.quadraticCurveTo(v,S,y,C),e.stroke(),e.beginPath(),e.moveTo(g,u);const T=g+Math.cos(this.angle+p+.15)*c,b=u+Math.sin(this.angle+p+.15)*c,I=g+Math.cos(this.angle)*c*.5-Math.cos(m)*o*.05,w=u+Math.sin(this.angle)*c*.5-Math.sin(m)*o*.05;e.quadraticCurveTo(I,w,T,b),e.stroke()}}drawSnakeTongue(e,s,n,o){const l=o*.9,a=o*1.4,i=s+Math.cos(this.angle)*l,h=n+Math.sin(this.angle)*l,r=Math.sin(this.wobble*25+Math.sin(this.wobble*8))*.4,f=this.angle+Math.PI/2;e.strokeStyle="#cc1818",e.lineWidth=Math.max(2,o*.1),e.lineCap="round",e.beginPath(),e.moveTo(s+Math.cos(this.angle)*o*.6,n+Math.sin(this.angle)*o*.6),e.lineTo(i,h),e.stroke(),e.lineWidth=Math.max(1.2,o*.06);for(const c of[-.3,.3]){const g=r+c*.5,u=i+Math.cos(this.angle+g)*a,p=h+Math.sin(this.angle+g)*a,m=i+Math.cos(this.angle)*a*.6,y=h+Math.sin(this.angle)*a*.6,C=Math.cos(f)*o*c*.4,v=Math.sin(f)*o*c*.4,S=e.createLinearGradient(i,h,u,p);S.addColorStop(0,"#ee2222"),S.addColorStop(.7,"#cc1818"),S.addColorStop(1,"#aa1111"),e.strokeStyle=S,e.beginPath(),e.moveTo(i,h),e.quadraticCurveTo(m+C,y+v,u,p),e.stroke(),e.beginPath(),e.arc(u,p,1,0,Math.PI*2),e.fillStyle="#ff3333",e.fill()}}drawNostrils(e,s,n,o){const l=o*.45,a=.25,i=Math.max(.8,o*.05);e.fillStyle="rgba(0,0,0,0.4)";for(const h of[-a,a]){const r=s+Math.cos(this.angle+h)*l,f=n+Math.sin(this.angle+h)*l;e.beginPath(),e.arc(r,f,i,0,Math.PI*2),e.fill()}}drawCrown(e,s,n,o){e.save(),e.translate(s,n),e.rotate(this.angle-Math.PI/2);const l=e.createLinearGradient(0,-o*.3,0,-o*1.2);l.addColorStop(0,"#bb8800"),l.addColorStop(.4,"#ffdd44"),l.addColorStop(1,"#ffee88"),e.fillStyle=l,e.beginPath(),e.moveTo(-o*.5,-o*.3),e.lineTo(-o*.4,-o*1.1),e.lineTo(-o*.15,-o*.7),e.lineTo(0,-o*1.2),e.lineTo(o*.15,-o*.7),e.lineTo(o*.4,-o*1.1),e.lineTo(o*.5,-o*.3),e.closePath(),e.fill(),e.strokeStyle="#996600",e.lineWidth=1.5,e.stroke(),e.fillStyle="#ddaa00",e.fillRect(-o*.5,-o*.4,o*1,o*.12),e.strokeRect(-o*.5,-o*.4,o*1,o*.12);const a=[[-o*.4,-o*1],[0,-o*1.15],[o*.4,-o*1]];for(const[i,h]of a)e.beginPath(),e.arc(i,h,o*.08,0,Math.PI*2),e.fillStyle="#ff2233",e.fill(),e.strokeStyle="#cc0022",e.lineWidth=.8,e.stroke(),e.beginPath(),e.arc(i-o*.02,h-o*.02,o*.03,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill();e.restore()}drawDragonWings(e,s,n,o){const l=Math.sin(this.wobble*3)*.5,a=this.boosting?2:1;for(const i of[-1,1]){e.save(),e.translate(s,n),e.rotate(this.angle-Math.PI/2),e.scale(i,1),e.rotate(l*i*a);const h=o*3.5,r=o*2.8,f=e.createLinearGradient(0,0,-h,0);f.addColorStop(0,this.lightenColor(this.color.h,1.2)),f.addColorStop(.2,this.color.h),f.addColorStop(.4,this.color.l),f.addColorStop(.6,this.color.b),f.addColorStop(.8,this.darkenColor(this.color.b,.7)),f.addColorStop(1,"#2d1810"),e.globalAlpha=.85,e.fillStyle=f,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.8,-r*.9,-h*.7,-r*.6,-h,-o*.3),e.bezierCurveTo(-h*.9,o*.1,-h*.8,o*.5,-h*.6,r*.5),e.bezierCurveTo(-h*.5,r*.7,-o*1.5,r*.8,-o*.8,r*.6),e.bezierCurveTo(-o*.4,r*.4,-o*.2,o*.3,o*.15,o*.2),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=2.5;const c=[[o*.1,-o*.1,-h*.7,-r*.5],[o*.1,0,-h*.9,-o*.1],[o*.1,0,-h*.8,o*.3],[o*.1,o*.1,-h*.6,r*.4],[o*.1,o*.1,-o*.8,r*.55]];for(const[u,p,m,y]of c)e.beginPath(),e.moveTo(u,p),e.lineTo(m,y),e.stroke();e.strokeStyle="rgba(0,0,0,0.25)",e.lineWidth=1.5;const g=[[-o*.5,-r*.4,-h*.5,-r*.3],[-o*.8,-o*.05,-h*.7,o*.1],[-o*.7,r*.25,-h*.4,r*.35]];for(const[u,p,m,y]of g)e.beginPath(),e.moveTo(u,p),e.lineTo(m,y),e.stroke();e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.6,-r*.7,-h*.5,-r*.4,-h*.8,-o*.2),e.stroke(),this.boosting&&(e.strokeStyle="rgba(255,120,0,0.6)",e.lineWidth=3,e.shadowColor="rgba(255,100,0,0.8)",e.shadowBlur=8,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.8,-r*.9,-h*.7,-r*.6,-h,-o*.3),e.stroke(),e.shadowBlur=0),e.globalAlpha=1,e.restore()}}drawDragonHorns(e,s,n,o){for(const l of[-1,1]){e.save(),e.translate(s,n),e.rotate(this.angle-Math.PI/2),e.scale(l,1);const a=e.createLinearGradient(0,-o*.3,0,-o*1.8);a.addColorStop(0,this.color.b),a.addColorStop(.5,this.color.l),a.addColorStop(1,"#ffffff"),e.fillStyle=a,e.beginPath(),e.moveTo(o*.2,-o*.3),e.quadraticCurveTo(o*.8,-o*1.6,o*.3,-o*1.7),e.quadraticCurveTo(o*.1,-o*1.2,o*.05,-o*.4),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.6)",e.lineWidth=1.5,e.beginPath(),e.moveTo(o*.15,-o*.4),e.quadraticCurveTo(o*.6,-o*1.4,o*.28,-o*1.6),e.stroke(),e.restore()}}drawDragonWhiskers(e,s,n,o){const l=o*1.5,a=Math.sin(this.wobble*3)*.3;for(const i of[-1,1]){e.strokeStyle=this.lightenColor(this.color.h,1.2),e.lineWidth=Math.max(2,o*.08),e.lineCap="round",e.beginPath();const h=s+Math.cos(this.angle+i*1.2)*o*.6,r=n+Math.sin(this.angle+i*1.2)*o*.6,f=h+Math.cos(this.angle+i*.3+a)*l,c=r+Math.sin(this.angle+i*.3+a)*l;e.moveTo(h,r),e.quadraticCurveTo(h+Math.cos(this.angle)*l*.3,r+Math.sin(this.angle)*l*.3,f,c),e.stroke()}}drawDragonFire(e,s,n,o){const l=o*2.5,a=s+Math.cos(this.angle)*o*.9,i=n+Math.sin(this.angle)*o*.9,h=.8,r=e.createRadialGradient(a,i,0,a,i,o*.8);r.addColorStop(0,"rgba(255,255,255,0.9)"),r.addColorStop(.3,"rgba(255,200,100,0.8)"),r.addColorStop(.7,"rgba(255,100,0,0.6)"),r.addColorStop(1,"rgba(200,50,0,0.3)"),e.beginPath(),e.arc(a,i,o*.6,0,Math.PI*2),e.fillStyle=r,e.fill(),[{count:8,sizeMin:4,sizeMax:8,colors:["#ffffff","#fff8dc","#fffacd"]},{count:12,sizeMin:3,sizeMax:6,colors:["#ffd700","#ffa500","#ff8c00"]},{count:15,sizeMin:2,sizeMax:5,colors:["#ff4500","#ff0000","#dc143c"]}].forEach((g,u)=>{for(let p=0;p<g.count;p++){p/g.count;const m=this.angle+(Math.random()-.5)*h*(1+u*.3),y=l*(.3+Math.random()*.7)*(1+u*.2),C=a+Math.cos(m)*y,v=i+Math.sin(m)*y,S=g.sizeMin+Math.random()*(g.sizeMax-g.sizeMin),T=g.colors[Math.floor(Math.random()*g.colors.length)],b=e.createRadialGradient(C,v,0,C,v,S);b.addColorStop(0,T),b.addColorStop(1,T+"00"),e.beginPath(),e.arc(C,v,S,0,Math.PI*2),e.fillStyle=b,e.globalAlpha=(.6+Math.random()*.4)*(1-u*.2),e.fill()}});for(let g=0;g<6;g++){const u=this.angle+(Math.random()-.5)*h*1.5,p=l*(.8+Math.random()*.4),m=a+Math.cos(u)*p,y=i+Math.sin(u)*p;e.beginPath(),e.arc(m,y,1+Math.random()*2,0,Math.PI*2),e.fillStyle="#ffff00",e.globalAlpha=.8+Math.random()*.2,e.fill()}const c=e.createLinearGradient(a,i,a+Math.cos(this.angle)*l,i+Math.sin(this.angle)*l);c.addColorStop(0,"rgba(255,255,255,0.4)"),c.addColorStop(.3,"rgba(255,150,0,0.3)"),c.addColorStop(.7,"rgba(255,50,0,0.2)"),c.addColorStop(1,"rgba(100,0,0,0.1)"),e.beginPath(),e.ellipse(a+Math.cos(this.angle)*l*.4,i+Math.sin(this.angle)*l*.4,l*.6,o*.3,this.angle,0,Math.PI*2),e.fillStyle=c,e.globalAlpha=.5,e.fill(),e.globalAlpha=1}lightenColor(e,s){const n=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16),a=Math.min(255,Math.round(n*s)),i=Math.min(255,Math.round(o*s)),h=Math.min(255,Math.round(l*s));return`rgb(${a},${i},${h})`}darkenColor(e,s){const n=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16),a=Math.round(n*s),i=Math.round(o*s),h=Math.round(l*s);return`rgb(${a},${i},${h})`}drawTailEffect(e,s,n,o){o>=4?this.drawDragonTail(e,s,n):o>=2&&this.drawSnakeTail(e,s,n)}drawDragonTail(e,s,n){if(this.segments.length<5)return;const o=this.segments[this.segments.length-1],l=o.x+s,a=o.y+n,i=this.bodyRadius(this.segments.length-1),h=this.segments[this.segments.length-2],r=Math.atan2(o.y-h.y,o.x-h.x);e.save(),e.translate(l,a),e.rotate(r);const f=i*1.5,c=i*.8,g=e.createLinearGradient(0,0,f,0);g.addColorStop(0,this.color.h),g.addColorStop(.3,"#ff6600"),g.addColorStop(.7,"#ff4400"),g.addColorStop(1,"#ff2200"),e.beginPath(),e.moveTo(0,0),e.lineTo(f,-c*.3),e.lineTo(f*.8,0),e.lineTo(f,c*.3),e.closePath(),e.fillStyle=g,e.fill();const u=3+Math.floor(Math.random()*3);for(let p=0;p<u;p++){const m=f*(.7+Math.random()*.4),y=(Math.random()-.5)*c*.6,C=2+Math.random()*3;e.beginPath(),e.arc(m,y,C,0,Math.PI*2),e.fillStyle=["#ff8800","#ffaa00","#ffcc00"][Math.floor(Math.random()*3)],e.globalAlpha=.8,e.fill()}e.globalAlpha=1,e.restore()}drawSnakeTail(e,s,n){if(this.segments.length<5)return;const o=this.segments[this.segments.length-1],l=o.x+s,a=o.y+n,i=this.bodyRadius(this.segments.length-1),h=this.segments[this.segments.length-2],r=Math.atan2(o.y-h.y,o.x-h.x);e.save(),e.translate(l,a),e.rotate(r);const f=i*.8,c=i*.3,g=e.createLinearGradient(0,0,f,0);g.addColorStop(0,this.color.h),g.addColorStop(.6,this.color.b),g.addColorStop(1,this.darkenColor(this.color.b,.5)),e.beginPath(),e.moveTo(0,0),e.lineTo(f,0),e.lineTo(f*.7,-c),e.lineTo(0,-c*.5),e.lineTo(f*.7,c),e.lineTo(0,c*.5),e.closePath(),e.fillStyle=g,e.fill(),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(f*.3,0),e.lineTo(f,0),e.stroke(),e.restore()}drawEye(e,s,n,o,l,a="baby"){e.save(),e.translate(s,n),e.scale(1,l),e.beginPath(),e.arc(0,0,o,0,Math.PI*2),e.fillStyle="#fff",e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke();const i=Math.cos(this.angle)*o*.15,h=Math.sin(this.angle)*o*.15;if(a==="baby"){const r=o*.6;e.beginPath(),e.arc(i,h,r,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(i-r*.3,-r*.3,r*.4,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.85)",e.fill(),e.beginPath(),e.arc(i+r*.2,r*.2,r*.15,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.5)",e.fill()}else if(a==="alert"){const r=o*.5;e.beginPath(),e.arc(i,h,r,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(i-r*.3,-r*.3,r*.38,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.9)",e.fill()}else if(a==="fierce"){const r=o*.6;e.beginPath(),e.arc(i,h,r,0,Math.PI*2),e.fillStyle="#cc3322",e.fill();const f=o*.35;e.beginPath(),e.arc(i,h,f,0,Math.PI*2),e.fillStyle="#1a0a0a",e.fill(),e.beginPath(),e.arc(i-f*.4,-f*.4,f*.25,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.6)",e.fill()}else if(a==="regal"){const r=o*.6;e.beginPath(),e.arc(i,h,r,0,Math.PI*2),e.fillStyle="#ccaa22",e.fill(),e.beginPath(),e.arc(i,h,r*.7,0,Math.PI*2),e.fillStyle="#4422aa",e.fill();const f=o*.25;e.beginPath(),e.arc(i,h,f,0,Math.PI*2),e.fillStyle="#0a0020",e.fill(),e.beginPath(),e.arc(i-f*.5,-f*.5,f*.35,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill()}else if(a==="dragon"){const r=o*.65,f=e.createRadialGradient(i,h,0,i,h,r);f.addColorStop(0,"#ffaa00"),f.addColorStop(.6,"#dd4400"),f.addColorStop(1,"#881100"),e.beginPath(),e.arc(i,h,r,0,Math.PI*2),e.fillStyle=f,e.fill(),e.beginPath(),e.ellipse(i,h,o*.1,o*.5,0,0,Math.PI*2),e.fillStyle="#0a0000",e.fill(),e.beginPath(),e.arc(0,0,o+2,0,Math.PI*2),e.strokeStyle=`rgba(255,100,0,${.3+Math.sin(this.wobble*3)*.15})`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(i-o*.15,-o*.18,o*.12,0,Math.PI*2),e.fillStyle="rgba(255,220,150,0.7)",e.fill()}e.restore()}drawDragonNostrils(e,s,n,o){const l=o*.6,a=.4,i=Math.max(2,o*.08);e.fillStyle="rgba(0,0,0,0.6)";for(const h of[-a,a]){const r=s+Math.cos(this.angle+h)*l,f=n+Math.sin(this.angle+h)*l;if(e.save(),e.translate(r,f),e.rotate(this.angle),e.beginPath(),e.ellipse(0,0,i*1.5,i*.8,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(-i*.3,-i*.2,i*.4,i*.2,0,0,Math.PI*2),e.fillStyle="rgba(255,100,50,0.3)",e.fill(),Math.random()<.3){const c=this.boosting?3:1;for(let g=0;g<c;g++){const u=i*(1+Math.random()*2),p=(Math.random()-.5)*i*.5,m=1+Math.random()*2;e.beginPath(),e.arc(u,p,m,0,Math.PI*2),e.fillStyle=this.boosting?`rgba(255,${100+Math.random()*100},0,${.4+Math.random()*.4})`:`rgba(150,150,150,${.2+Math.random()*.3})`,e.fill()}}e.restore()}}}class pt{constructor(){this.x=0,this.y=0,this.radius=5,this.color="",this.glow="",this.phase=0,this.alive=!1,this.tier=V[0]}reset(e,s,n){if(this.tier=n||ot(),this.x=e??A(100,P.WORLD_W-100),this.y=s??A(100,P.WORLD_H-100),this.radius=A(this.tier.radiusMin,this.tier.radiusMax),this.phase=Math.random()*Math.PI*2,this.alive=!0,this.tier.golden)this.color="hsl(45, 90%, 65%)",this.glow="hsl(45, 95%, 75%)";else{const o=A(0,360);this.color=`hsl(${o}, 80%, 65%)`,this.glow=`hsl(${o}, 80%, 75%)`}return this}draw(e,s){const{W:n,H:o,frameCount:l}=d,a=this.x-s.x+n/2,i=this.y-s.y+o/2;if(a<-20||a>n+20||i<-20||i>o+20)return;const h=1+Math.sin(this.phase+l*.04)*.15,r=this.radius*h,f=this.tier.id==="large",c=this.tier.golden;if(c){const m=1+Math.sin(l*.06+this.phase)*.3,y=1+Math.sin(l*.08+this.phase+1)*.25;e.beginPath(),e.arc(a,i,r+6*m,0,Math.PI*2),e.strokeStyle=`rgba(255,215,0,${.25+Math.sin(l*.05)*.12})`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(a,i,r+2*y,0,Math.PI*2),e.strokeStyle=`rgba(255,255,100,${.4+Math.sin(l*.07)*.2})`,e.lineWidth=1,e.stroke()}const g=c?8:f?6:4,u=c?.25:f?.2:.15;e.beginPath(),e.arc(a,i,r+g,0,Math.PI*2),e.fillStyle=this.glow,e.globalAlpha=u,e.fill(),e.globalAlpha=1;const p=e.createRadialGradient(a-r*.3,i-r*.3,0,a,i,r);if(p.addColorStop(0,"#fff"),p.addColorStop(.4,this.color),p.addColorStop(1,this.glow),e.beginPath(),e.arc(a,i,r,0,Math.PI*2),e.fillStyle=p,e.fill(),f||c){const m=l*.03+this.phase,y=r*.35,C=a+Math.cos(m)*y,v=i+Math.sin(m)*y,S=r*.2;e.beginPath(),e.arc(C,v,S,0,Math.PI*2),e.fillStyle=`rgba(255,255,255,${.5+Math.sin(l*.08)*.3})`,e.fill()}}}const me=new ze(()=>new pt,(t,e,s,n)=>t.reset(e,s,n),P.FOOD_COUNT);class He{constructor(){const e=ke();this.x=e.x,this.y=e.y,this.type=Oe[Q(0,Oe.length-1)],this.alive=!0,this.phase=Math.random()*Math.PI*2,this.spawnTime=Date.now()}draw(e,s){const{W:n,H:o,frameCount:l}=d,a=this.x-s.x+n/2,i=this.y-s.y+o/2;if(a<-40||a>n+40||i<-40||i>o+40)return;const h=Math.sin(this.phase+l*.03)*4,r=1+Math.sin(this.phase+l*.05)*.1,f=P.ITEM_RADIUS*r,c=.15+Math.sin(l*.04+this.phase)*.08;e.beginPath(),e.arc(a,i+h,f+12*r,0,Math.PI*2),e.fillStyle=this.type.color,e.globalAlpha=c*.6,e.fill(),e.beginPath(),e.arc(a,i+h,f+6*r,0,Math.PI*2),e.fillStyle=this.type.color,e.globalAlpha=c,e.fill(),e.globalAlpha=1,e.beginPath(),e.arc(a,i+h,f,0,Math.PI*2);const g=e.createRadialGradient(a,i+h-3,0,a,i+h,f);g.addColorStop(0,"#fff"),g.addColorStop(.5,this.type.color),g.addColorStop(1,this.type.color),e.fillStyle=g,e.fill(),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1.5,e.stroke(),e.font=`${f*1.2}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.type.icon,a,i+h+1)}}class Xe{constructor(e){this.cellSize=e,this.cells=new Map}_key(e,s){return e*73856093^s*19349663}clear(){this.cells.clear()}insert(e,s,n){const o=Math.floor(s/this.cellSize),l=Math.floor(n/this.cellSize),a=this._key(o,l);let i=this.cells.get(a);i||(i=[],this.cells.set(a,i)),i.push(e)}insertCircle(e,s,n,o){const l=Math.floor((s-o)/this.cellSize),a=Math.floor((s+o)/this.cellSize),i=Math.floor((n-o)/this.cellSize),h=Math.floor((n+o)/this.cellSize);for(let r=l;r<=a;r++)for(let f=i;f<=h;f++){const c=this._key(r,f);let g=this.cells.get(c);g||(g=[],this.cells.set(c,g)),g.push(e)}}query(e,s,n){const o=[],l=Math.floor((e-n)/this.cellSize),a=Math.floor((e+n)/this.cellSize),i=Math.floor((s-n)/this.cellSize),h=Math.floor((s+n)/this.cellSize);for(let r=l;r<=a;r++)for(let f=i;f<=h;f++){const c=this._key(r,f),g=this.cells.get(c);if(g)for(let u=0;u<g.length;u++)o.push(g[u])}return o}}function bt(t,e){if(t.isPlayer||!t.alive)return;if(t.aiTimer-=e*1e3,t.isMinion){Mt(t);return}if(t.isBoss){yt(t,e);return}const{foods:s,items:n,worms:o,foodGrid:l}=d;if(t.aiTimer<=0){t.aiTimer=A(500,2e3),t.aiState="wander",t.aiTarget=null;let a=null,i=300;const h=l.query(t.head.x,t.head.y,300);for(const m of h){if(!m.alive)continue;const y=_(t.head,m);y<i&&(a=m,i=y)}let r=null,f=400;for(const m of n){if(!m.alive)continue;const y=_(t.head,m);y<f&&(r=m,f=y)}let c=null,g=250;for(const m of o)if(!(m===t||!m.alive||m.isMinion)&&m.length<t.length*.7){const y=_(t.head,m.head);y<g&&(c=m,g=y)}let u=null,p=200;for(const m of o)if(!(m===t||!m.alive)&&m.length>t.length*1.3){const y=_(t.head,m.head);y<p&&(u=m,p=y)}if(d.obstacles){for(const m of d.obstacles)if(_(t.head,m)<m.radius+80){t.aiState="flee",t.aiTarget=m;break}}if(d.dangerZone&&d.dangerZone.active){const m=P.WORLD_W/2,y=P.WORLD_H/2;_(t.head,{x:m,y})>d.dangerZone.radius-100&&(t.aiState="flee",t.aiTarget={head:{x:m,y}},t.targetAngle=z(t.head,{x:m,y}))}t.aiState==="wander"&&(u&&p<150?(t.aiState="flee",t.aiTarget=u):c&&Math.random()>.3?(t.aiState="chase",t.aiTarget=c):r&&Math.random()>.4?(t.aiState="item",t.aiTarget=r):a&&(t.aiState="food",t.aiTarget=a))}switch(t.aiState){case"flee":t.aiTarget&&t.aiTarget.alive&&(t.targetAngle=z(t.aiTarget.head,t.head),t.boosting=t.length>15);break;case"chase":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget.head),t.boosting=_(t.head,t.aiTarget.head)<100&&t.length>15):t.aiState="wander";break;case"food":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;case"item":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;default:t.aiTimer<=0&&(t.targetAngle=t.angle+A(-.8,.8)),t.boosting=!1;break}}function yt(t,e){const{worms:s,foodGrid:n}=d;if(t.aiTimer-=e*1e3,!(t.aiTimer>0&&t.aiTarget&&t.aiTarget.alive)){t.aiTimer=A(300,1e3),t.aiTarget=null,t.aiState="wander";let o=null,l=400;for(const a of s){if(a===t||!a.alive||a.isMinion||a.isBoss)continue;const i=_(t.head,a.head);if(a.isPlayer&&i<500){o=a,l=i;break}i<l&&(o=a,l=i)}if(o)t.aiState="chase",t.aiTarget=o;else{const a=n.query(t.head.x,t.head.y,400);let i=null,h=400;for(const r of a){if(!r.alive)continue;const f=_(t.head,r);f<h&&(i=r,h=f)}i&&(t.aiState="food",t.aiTarget=i)}}switch(t.aiState){case"chase":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget.head),t.boosting=_(t.head,t.aiTarget.head)<200&&t.length>30):t.aiState="wander";break;case"food":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;default:t.targetAngle=t.angle+A(-.5,.5),t.boosting=!1;break}}function Mt(t,e){if(!t.minionOwner||!t.minionOwner.alive){t.alive=!1;return}const{worms:s,foodGrid:n}=d;let o=null,l=250;const a=n.query(t.head.x,t.head.y,250);for(const r of a){if(!r.alive)continue;const f=_(t.head,r);f<l&&(o=r,l=f)}let i=null,h=200;for(const r of s)if(!(r===t||!r.alive||r===t.minionOwner||r.isMinion)&&r.length<t.length*.8){const f=_(t.head,r.head);f<h&&(i=r,h=f)}i?(t.targetAngle=z(t.head,i.head),t.boosting=h<80):o?t.targetAngle=z(t.head,o):_(t.head,t.minionOwner.head)>200?t.targetAngle=z(t.head,t.minionOwner.head):t.targetAngle+=A(-.1,.1)}function St(){const{player:t,worms:e,killCount:s,minionCooldown:n,activeItemEffects:o,wave:l,waveTimer:a}=d;if(!t)return;const i=G[t.evolutionStage]||G[0];document.getElementById("score-value").textContent=Math.floor(t.score);const h=document.getElementById("evo-badge");h&&(h.textContent=i.icon,h.className="evo-badge"+(t.evolutionStage>=2?" pulse":"")),document.getElementById("score-length").textContent=`${i.name} | ê¸¸ì´: ${Math.floor(t.length)} | í‚¬: ${s}`;const r=document.getElementById("wave-info");if(r){const b=Math.min(a,Y.DURATION)/Y.DURATION*100;if(l>0)r.innerHTML=`<span class="wave-label">ðŸŒŠ ${l}</span><div class="wave-bar"><div class="wave-bar-fill" id="wave-bar-fill" style="width:${b}%"></div></div>`,r.style.display="flex";else{const I=Math.max(0,Math.ceil(Y.DURATION-a));r.innerHTML=`<span class="wave-label">ë‹¤ìŒ ì›¨ì´ë¸Œ: ${I}s</span>`,r.style.display="flex"}}const f=e.filter(T=>T.alive&&!T.isMinion).sort((T,b)=>b.score-T.score),c=f.slice(0,8);!c.some(T=>T.isPlayer)&&t&&t.alive&&c.push(t);const u=document.getElementById("leaderboard");let p='<div class="lb-title">ìˆœìœ„</div>';for(const T of c){const b=f.indexOf(T)+1,I=T.isPlayer?" me":"";p+=`<div class="lb-entry${I}"><span><span class="lb-rank">${b}.</span>${T.name}</span><span>${Math.floor(T.score)}</span></div>`}u.innerHTML=p;const m=document.getElementById("minion-btn"),y=document.querySelector("#minion-cd circle");if(n>0){m.disabled=!0;const T=n/P.MINION_COOLDOWN;y.style.strokeDashoffset=(1-T)*226,y.style.stroke="rgba(255,150,50,0.5)"}else m.disabled=!1,y.style.strokeDashoffset=0,y.style.stroke="rgba(255,255,255,0.3)";const C=document.getElementById("active-items"),v=Date.now();d.activeItemEffects=o.filter(T=>v-T.start<T.duration),C.innerHTML=d.activeItemEffects.map(T=>{const b=1-(v-T.start)/T.duration;return`<div class="active-item">
      <span class="item-icon">${T.type.icon}</span>
      <span>${T.type.name}</span>
      <div class="item-bar"><div class="item-bar-fill" style="width:${b*100}%;background:${T.type.color}"></div></div>
    </div>`}).join("");const S=document.getElementById("damage-vignette");S&&(S.style.opacity=d.damageVignette)}function q(t,e,s="normal"){const n=document.createElement("div");n.className="kill-notify"+(s==="large"?" kill-notify-large":""),n.style.color=e,s==="large"&&(n.style.textShadow=`0 0 20px ${e}, 0 0 40px ${e}`),n.textContent=t,document.body.appendChild(n),setTimeout(()=>n.remove(),s==="large"?2200:1600)}function ve(t,e,s,n="#fff",o=18){d.floatTexts.push({x:t,y:e,text:s,color:n,size:o,life:1,vy:-1.5})}function vt(t,e,s){const{W:n,H:o}=d,l=[];for(const a of d.floatTexts){if(a.y+=a.vy*s*60,a.vy*=.98,a.life-=s*.8,a.life<=0)continue;const i=a.x-e.x+n/2,h=a.y-e.y+o/2;if(i<-100||i>n+100||h<-100||h>o+100){l.push(a);continue}t.save(),t.globalAlpha=a.life,t.font=`bold ${a.size}px "Segoe UI", sans-serif`,t.textAlign="center",t.fillStyle="rgba(0,0,0,0.5)",t.fillText(a.text,i,h+2),t.fillStyle=a.color,t.fillText(a.text,i,h),t.restore(),l.push(a)}d.floatTexts=l}function Pt(t,e,s,n,o,l){d.foodAbsorbs.push({fx:t,fy:e,tx:s,ty:n,color:o,radius:l,t:0})}function Ct(t,e,s){const{W:n,H:o}=d,l=[];for(const a of d.foodAbsorbs){if(a.t+=s*5,a.t>=1)continue;const i=a.t*a.t,h=a.fx+(a.tx-a.fx)*i,r=a.fy+(a.ty-a.fy)*i,f=a.radius*(1-i),c=h-e.x+n/2,g=r-e.y+o/2;if(c<-20||c>n+20||g<-20||g>o+20){l.push(a);continue}t.globalAlpha=1-i,t.beginPath(),t.arc(c,g,Math.max(1,f),0,Math.PI*2),t.fillStyle=a.color,t.fill(),t.globalAlpha=1,l.push(a)}d.foodAbsorbs=l}function Tt(t,e,s,n){const o=d.isMobile?8:15;t.save(),t.globalAlpha=.12,t.strokeStyle="rgba(200, 220, 255, 0.8)",t.lineWidth=1.5;for(let l=0;l<o;l++){const a=Math.random()*e,i=Math.random()*s,h=30+Math.random()*60,r=Math.atan2(i-s/2,a-e/2);t.beginPath(),t.moveTo(a,i),t.lineTo(a+Math.cos(r)*h,i+Math.sin(r)*h),t.stroke()}t.restore()}let x=null,j=!1,ie=!1;function pe(){return x||(x=new(window.AudioContext||window.webkitAudioContext)),x.state==="suspended"&&x.resume(),x}function It(){ie||(ie=!0,pe())}function D(t,e,s="sine",n=.3,o=null){if(j||!ie)return;const l=pe(),a=l.createOscillator(),i=l.createGain();a.type=s,a.frequency.setValueAtTime(t,l.currentTime),o!=null&&a.frequency.exponentialRampToValueAtTime(Math.max(o,20),l.currentTime+e),i.gain.setValueAtTime(n,l.currentTime),i.gain.exponentialRampToValueAtTime(.001,l.currentTime+e),a.connect(i),i.connect(l.destination),a.start(l.currentTime),a.stop(l.currentTime+e)}function Ye(t,e=.1){if(j||!ie)return;const s=pe(),n=s.sampleRate*t,o=s.createBuffer(1,n,s.sampleRate),l=o.getChannelData(0);for(let r=0;r<n;r++)l[r]=Math.random()*2-1;const a=s.createBufferSource();a.buffer=o;const i=s.createGain();i.gain.setValueAtTime(e,s.currentTime),i.gain.exponentialRampToValueAtTime(.001,s.currentTime+t);const h=s.createBiquadFilter();h.type="bandpass",h.frequency.value=1e3,h.Q.value=.5,a.connect(h),h.connect(i),i.connect(s.destination),a.start()}function kt(){D(600+Math.random()*400,.08,"sine",.15)}function wt(){D(300,.3,"square",.15,100),setTimeout(()=>D(500,.2,"sine",.12),100)}function Ot(){D(400,.5,"sawtooth",.2,80),setTimeout(()=>Ye(.3,.08),100)}function Et(){D(800,.1,"sine",.15,1200),setTimeout(()=>D(1200,.1,"sine",.12,1600),80)}function At(){D(500,.2,"triangle",.1,800)}function Rt(){D(2e3,.3,"sine",.1,500)}function _t(){for(let t=0;t<3;t++)setTimeout(()=>D(400+t*200,.1,"triangle",.1),t*60)}function Lt(){D(600,.15,"sine",.12,900),setTimeout(()=>D(900,.15,"sine",.12,1200),100),setTimeout(()=>D(1200,.2,"triangle",.1,1600),200)}function Dt(){for(let t=0;t<4;t++)setTimeout(()=>D(300+t*150,.15,"triangle",.12),t*80);setTimeout(()=>D(900,.3,"sine",.15,1200),350)}function Wt(){D(200,.2,"square",.08,400),setTimeout(()=>D(400,.2,"square",.08,600),150)}function Bt(){D(100,.4,"sawtooth",.15,60),setTimeout(()=>D(80,.3,"square",.1,120),200),setTimeout(()=>Ye(.2,.06),300)}function Re(){D(500,.1,"sine",.1,700),setTimeout(()=>D(700,.15,"triangle",.1,900),80)}function _e(){D(1e3,.2,"sine",.1,500),setTimeout(()=>D(500,.15,"sine",.08,1e3),100)}let U=null,te=null;function Gt(){if(j||!ie||U)return;const t=pe();te=t.createGain(),te.gain.value=.03,te.connect(t.destination),U=t.createOscillator(),U.type="sine",U.frequency.value=80,U.connect(te),U.start();const e=t.createOscillator(),s=t.createGain();e.frequency.value=.2,s.gain.value=10,e.connect(s),s.connect(U.frequency),e.start()}function Fe(){U&&(U.stop(),U=null,te=null)}function $t(){return j=!j,j&&Fe(),j}function Nt(){const{worms:t,foods:e,items:s,particles:n,foodGrid:o,segmentGrid:l}=d;for(const a of t){if(!a.alive)continue;const i=a.isPlayer?d.skillModifiers||{}:{},h=1+(i.eatRadiusMult||0),r=1+(i.scoreMult||0),f=a.radius*P.EAT_DISTANCE*h;if(a.magnetized||a.isPlayer&&i.autoMagnet){const u=a.magnetized?200:120,p=o.query(a.head.x,a.head.y,u);for(const m of p){if(!m.alive)continue;if(_(a.head,m)<u){const C=z(m,a.head);m.x+=Math.cos(C)*4,m.y+=Math.sin(C)*4}}}if(a.isPlayer&&i.freezeAura)for(const u of t)u===a||!u.alive||u.isMinion||u.isMinion&&u.minionOwner===a||_(a.head,u.head)<150&&(u.frozen||(u.frozenTimer=Math.max(u.frozenTimer,500),u.frozen=!0));const c=a.isPlayer&&{0:1,1:1.05,2:1.1,3:1.2,4:1.3}[a.evolutionStage]||1,g=o.query(a.head.x,a.head.y,f);for(const u of g)if(u.alive&&_(a.head,u)<f){u.alive=!1;const p=u.tier||V[0];if(a.length+=p.growValue*c,a.score+=Math.floor(p.scoreValue*r),a.isMinion&&a.minionOwner&&a.minionOwner.alive){const y=Math.floor(p.scoreValue*r*.5);a.minionOwner.score+=y,a.minionOwner.length+=p.growValue*.3}(a.isPlayer||a.isMinion&&a.minionOwner&&a.minionOwner.isPlayer)&&kt(),Pt(u.x,u.y,a.head.x,a.head.y,u.color,u.radius);const m=p.golden?5:p.growValue>2?4:3;n.push(K.acquire(u.x,u.y,u.color,m))}for(const u of s)if(u.alive&&_(a.head,u)<f+P.ITEM_RADIUS){u.alive=!1,zt(a,u.type);for(let p=0;p<12;p++)n.push(K.acquire(u.x,u.y,u.type.color,4))}}for(const a of t){if(!a.alive)continue;for(const r of t){if(r===a||!r.alive||a.isMinion&&r===a.minionOwner||r.isMinion&&r.minionOwner===a||a.isMinion&&r.isMinion&&a.minionOwner===r.minionOwner)continue;const f=_(a.head,r.head),c=(a.radius+r.radius)*.8;f<c&&(a.shielded&&!r.shielded?ee(r,a):r.shielded&&!a.shielded?ee(a,r):a.length>r.length*1.1?ee(r,a):r.length>a.length*1.1&&ee(a,r))}if(!a.alive)continue;const i=a.radius+40,h=l.query(a.head.x,a.head.y,i);for(const r of h){const f=r.worm;if(f===a||!f.alive||a.isMinion&&f===a.minionOwner||f.isMinion&&f.minionOwner===a||a.isMinion&&f.isMinion&&a.minionOwner===f.minionOwner||a.length>=f.length||a.shielded)continue;const c=f.bodyRadius(r.segIndex);if(_(a.head,r)<(a.radius+c)*.6){ee(a,f);break}}}}function ee(t,e){if(!t.alive)return;t.alive=!1;const{foods:s,particles:n}=d,o=V[1],l=V[2],a=Math.min(Math.floor(t.length/2),30);for(let r=0;r<a;r++){const f=t.segments[Math.min(r*2,t.segments.length-1)],c=r%4===0?l:o,g=me.acquire(f.x+A(-15,15),f.y+A(-15,15),c);g.color=t.color.h,g.glow=t.color.l,s.push(g)}const i=Math.min(40+Math.floor(t.length/8),60);for(let r=0;r<i;r++){const f=t.segments[Q(0,t.segments.length-1)],c=[t.color.l,t.color.h,"#ffffff","#ffdd44"],g=c[Q(0,c.length-1)],u=A(2,9);n.push(K.acquire(f.x+A(-25,25),f.y+A(-25,25),g,u))}const h=Math.floor(t.score*.5)+50;e.length+=t.length*.2,e.score+=h,e.isMinion&&e.minionOwner&&(e.minionOwner.score+=30,e.minionOwner.length+=t.length*.15),t.isBoss&&(d.bossesAlive=Math.max(0,d.bossesAlive-1)),(e.isPlayer||e.isMinion&&e.minionOwner&&e.minionOwner.isPlayer)&&(d.killCount++,ve(t.head.x,t.head.y-20,`+${h}`,"#ffdd44",22),t.isBoss?(d._bossKilled=!0,q(`ðŸ’€ ë³´ìŠ¤ ì²˜ì¹˜! +${h}ì `,"#ff4444","large"),ve(t.head.x,t.head.y-50,"ðŸ’€ BOSS KILL!","#ff4444",28)):q(`ðŸ´ ${t.name} ì²˜ì¹˜!`,e.color.l),wt()),t.isPlayer&&(d.damageVignette=1,d.onGameOver&&d.onGameOver())}function zt(t,e){const{worms:s}=d,n=t.isPlayer||t.isMinion&&t.minionOwner&&t.minionOwner.isPlayer;switch(e.id){case"speed":t.speedBoosted=!0,setTimeout(()=>{t.speedBoosted=!1},P.ITEM_DURATION),n&&he(e);break;case"shield":t.shielded=!0,n&&At(),setTimeout(()=>{t.shielded=!1},P.ITEM_DURATION),n&&he(e);break;case"magnet":t.magnetized=!0,setTimeout(()=>{t.magnetized=!1},P.ITEM_DURATION),n&&he(e);break;case"growth":t.length+=15,t.score+=30,n&&ve(t.head.x,t.head.y-20,"+15 ê¸¸ì´","#44dd88",18);break;case"freeze":for(const o of s)o===t||!o.alive||t.isMinion&&o===t.minionOwner||_(t.head,o.head)<250&&(o.frozenTimer=P.ITEM_DURATION,o.frozen=!0);n&&(Rt(),he(e));break}n&&(e.id!=="shield"&&e.id!=="freeze"&&Et(),q(`${e.icon} ${e.name} íšë“!`,e.color))}function he(t){const e=Date.now()+"_"+t.id;d.activeItemEffects.push({id:e,type:t,start:Date.now(),duration:P.ITEM_DURATION})}function Ht(){const{player:t,camera:e}=d;if(t&&t.alive){e.targetX=t.head.x,e.targetY=t.head.y;const s=t.length;s<50?e.targetZoom=1:s<120?e.targetZoom=1-(s-50)*.002:s<300?e.targetZoom=.86-(s-120)*.001:e.targetZoom=Math.max(.45,.68-(s-300)*5e-4)}if(e.x=oe(e.x,e.targetX,P.CAMERA_SMOOTH),e.y=oe(e.y,e.targetY,P.CAMERA_SMOOTH),e.zoom=oe(e.zoom,e.targetZoom,.03),d.screenShake>0){const s=d.screenShake*15;d.screenShakeX=(Math.random()-.5)*s,d.screenShakeY=(Math.random()-.5)*s,d.screenShake-=.02,d.screenShake<0&&(d.screenShake=0,d.screenShakeX=0,d.screenShakeY=0)}}class Xt{constructor(){this.x=A(300,P.WORLD_W-300),this.y=A(300,P.WORLD_H-300),this.radius=A($.OBSTACLE_RADIUS_MIN,$.OBSTACLE_RADIUS_MAX)}draw(e,s,n,o){const l=this.x-s.x+n/2,a=this.y-s.y+o/2;if(l<-100||l>n+100||a<-100||a>o+100)return;const i=e.createRadialGradient(l-this.radius*.2,a-this.radius*.2,0,l,a,this.radius);i.addColorStop(0,"#3a3a50"),i.addColorStop(.7,"#252535"),i.addColorStop(1,"#1a1a28"),e.beginPath(),e.arc(l,a,this.radius,0,Math.PI*2),e.fillStyle=i,e.fill(),e.beginPath(),e.ellipse(l-this.radius*.2,a-this.radius*.3,this.radius*.5,this.radius*.25,-.3,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.06)",e.fill()}}class Yt{constructor(){const s=A(0,360);this.a={x:A(400,P.WORLD_W/2-200),y:A(400,P.WORLD_H-400),cooldown:0},this.b={x:A(P.WORLD_W/2+200,P.WORLD_W-400),y:A(400,P.WORLD_H-400),cooldown:0},this.radius=$.PORTAL_RADIUS,this.hue=s,this.phase=A(0,Math.PI*2)}update(e){this.phase+=e*3,this.a.cooldown>0&&(this.a.cooldown-=e*1e3),this.b.cooldown>0&&(this.b.cooldown-=e*1e3)}drawPortal(e,s,n,o,l){const a=s.x-n.x+o/2,i=s.y-n.y+l/2;if(a<-60||a>o+60||i<-60||i>l+60)return;const h=this.radius,r=s.cooldown>0;e.save(),e.translate(a,i),e.rotate(this.phase),e.beginPath(),e.arc(0,0,h+4,0,Math.PI*2),e.strokeStyle=`hsla(${this.hue}, 80%, ${r?30:60}%, ${r?.3:.7})`,e.lineWidth=3,e.setLineDash([8,6]),e.stroke(),e.setLineDash([]);const f=e.createRadialGradient(0,0,0,0,0,h);if(f.addColorStop(0,`hsla(${this.hue}, 80%, 70%, ${r?.1:.3})`),f.addColorStop(1,`hsla(${this.hue}, 80%, 50%, 0)`),e.beginPath(),e.arc(0,0,h,0,Math.PI*2),e.fillStyle=f,e.fill(),!r)for(let c=0;c<3;c++){const g=this.phase+c*Math.PI*2/3;e.beginPath(),e.arc(0,0,h*.6,g,g+1),e.strokeStyle=`hsla(${this.hue+30}, 80%, 70%, 0.5)`,e.lineWidth=2,e.stroke()}e.restore()}draw(e,s,n,o){this.drawPortal(e,this.a,s,n,o),this.drawPortal(e,this.b,s,n,o)}}function Ft(t){const e=Math.min(t*$.OBSTACLES_PER_WAVE,$.MAX_OBSTACLES);for(;d.obstacles.length<e;)d.obstacles.push(new Xt);if(t>0&&t%$.PORTALS_EVERY_N_WAVES===0){const s=Math.min(Math.floor(t/$.PORTALS_EVERY_N_WAVES),$.MAX_PORTAL_PAIRS);for(;d.portals.length<s;)d.portals.push(new Yt)}t>=$.DANGER_ZONE_START_WAVE&&!d.dangerZone.active&&(d.dangerZone.active=!0,d.dangerZone.radius=Math.max(P.WORLD_W,P.WORLD_H)/2)}function Ut(t){for(const e of d.portals)e.update(t)}function Vt(t){if(!d.dangerZone.active)return;d.dangerZone.radius=Math.max($.DANGER_ZONE_MIN_RADIUS,d.dangerZone.radius-$.DANGER_ZONE_SHRINK_RATE*t);const e=P.WORLD_W/2,s=P.WORLD_H/2,n=d.dangerZone.radius;for(const o of d.worms){if(!o.alive)continue;_(o.head,{x:e,y:s})>n&&(o.length-=$.DANGER_ZONE_DAMAGE*t,o.length<5&&(o.alive=!1,o.isPlayer&&d.onGameOver&&d.onGameOver()))}}function qt(){for(const t of d.worms)if(t.alive)for(const e of d.obstacles){const s=_(t.head,e),n=t.radius+e.radius;if(s<n){const o=z(e,t.head),l=n-s;t.head.x+=Math.cos(o)*l,t.head.y+=Math.sin(o)*l,t.targetAngle=o,t.boosting&&t.length>10&&(t.length-=2)}}}function jt(){for(const t of d.portals)for(const e of d.worms)if(e.alive){if(t.a.cooldown<=0&&_(e.head,t.a)<t.radius){e.head.x=t.b.x+Math.cos(e.angle)*(t.radius+10),e.head.y=t.b.y+Math.sin(e.angle)*(t.radius+10),t.a.cooldown=$.PORTAL_COOLDOWN,t.b.cooldown=$.PORTAL_COOLDOWN,e.isPlayer&&_e();break}if(t.b.cooldown<=0&&_(e.head,t.b)<t.radius){e.head.x=t.a.x+Math.cos(e.angle)*(t.radius+10),e.head.y=t.a.y+Math.sin(e.angle)*(t.radius+10),t.a.cooldown=$.PORTAL_COOLDOWN,t.b.cooldown=$.PORTAL_COOLDOWN,e.isPlayer&&_e();break}}}function Zt(t){d.waveTimer+=t,d.waveTimer>=Y.DURATION&&(d.waveTimer-=Y.DURATION,d.wave++,Ft(d.wave),d.player&&d.player.alive&&(d.player.score+=d.wave*Y.WAVE_BONUS_MULT),q(`ðŸŒŠ ì›¨ì´ë¸Œ ${d.wave} ì‹œìž‘!`,"#88bbff","large"),Wt(),Y.BOSS_WAVES.includes(d.wave)&&(d._spawnBoss=!0,setTimeout(()=>{q("ðŸ’€ ë³´ìŠ¤ ì¶œí˜„!","#ff4444","large"),Bt()},1500)))}function be(){const t=d.wave;return{foodCount:P.FOOD_COUNT+t*Y.FOOD_PER_WAVE,aiCount:P.AI_COUNT+t*Y.AI_PER_WAVE,aiInitialLength:{min:15+t*Y.AI_LENGTH_PER_WAVE,max:60+t*Y.AI_LENGTH_PER_WAVE}}}function Ue(){const t=be(),e=ke(),s=Q(0,Z.length-1),n=Ee[Q(0,Ee.length-1)],o=new ue(e.x,e.y,s,n,!1);o.length=A(t.aiInitialLength.min,t.aiInitialLength.max),d.worms.push(o)}function Kt(){const t=be(),e=ke(),s=Q(0,Z.length-1),n="ðŸ”¥ ë³´ìŠ¤",o=new ue(e.x,e.y,s,n,!1);o.length=t.aiInitialLength.max*Y.BOSS_LENGTH_MULT,o.score=d.wave*200,o.isBoss=!0,d.worms.push(o),d.bossesAlive++}function Jt(){const{player:t,particles:e,worms:s}=d;if(d.gameState!=="playing"||!t||!t.alive||d.minionCooldown>0)return;const n=d.skillModifiers||{},o=Math.max(.1,1+(n.minionCdMult||0));d.minionCooldown=P.MINION_COOLDOWN*o;const l=P.MINION_COUNT+(n.minionCountBonus||0);for(let a=0;a<l;a++){const i=Math.PI*2/l*a,h=t.head.x+Math.cos(i)*60,r=t.head.y+Math.sin(i)*60,f=new ue(h,r,d.selectedColor,"ë¶€í•˜",!1,!0);f.length=Math.max(10,t.length*.25),f.minionOwner=t,f.minionTimer=P.MINION_DURATION,s.push(f);for(let c=0;c<8;c++)e.push(K.acquire(h,r,t.color.l,4))}_t(),q(`ðŸ‘¥ ë¶€í•˜ ${l}ëª… ì†Œí™˜!`,"#ff9944")}function Qt(){const t=be(),{foods:e}=d,s=e.filter(o=>o.alive).length,n=t.foodCount;if(s<n)for(let o=0;o<n-s;o++)e.push(me.acquire())}function xt(){const{items:t}=d;t.filter(s=>s.alive).length<P.ITEM_COUNT&&t.push(new He)}function eo(){const t=be(),{worms:e,player:s}=d,n=e.filter(l=>l.alive&&!l.isPlayer&&!l.isMinion&&!l.isBoss).length;let o=t.aiCount;s&&s.alive&&(s.length>150?o=Math.max(3,Math.floor(t.aiCount*.7)):s.length>100&&(o=Math.max(4,Math.floor(t.aiCount*.85)))),n<o&&Ue(),d._spawnBoss&&(d._spawnBoss=!1,Kt())}const to=120,Ve=[];for(let t=0;t<to;t++)Ve.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,size:.5+Math.random()*2,brightness:.3+Math.random()*.7,twinkleSpeed:.02+Math.random()*.04,depth:.3+Math.random()*.4});const oo=35,qe=[];for(let t=0;t<oo;t++)qe.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,r:15+Math.random()*25,alpha:.02+Math.random()*.02,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.2});const Pe=80,je=[],Le=["grass","stone","flower","moss","pebble"];for(let t=0;t<Pe;t++){const e=Le[Math.floor(Math.random()*Le.length)];je.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,type:e,size:4+Math.random()*12,rotation:Math.random()*Math.PI*2,hue:Math.random()*30-15,alpha:.15+Math.random()*.15})}function ao(t,e,s,n,o,l){const a=e.x+s,i=e.y+n;if(a<-30||a>o+30||i<-30||i>l+30)return;const h=e.size;switch(t.globalAlpha=e.alpha,e.type){case"grass":{t.strokeStyle=`hsl(${120+e.hue}, 40%, 30%)`,t.lineWidth=1,t.lineCap="round";for(let r=0;r<3;r++){const f=e.rotation+(r-1)*.4;t.beginPath(),t.moveTo(a+(r-1)*2,i),t.lineTo(a+(r-1)*2+Math.cos(f)*h,i-Math.sin(f+.5)*h),t.stroke()}break}case"stone":{const r=t.createRadialGradient(a-h*.2,i-h*.2,0,a,i,h);r.addColorStop(0,`hsla(220, 10%, 45%, ${e.alpha})`),r.addColorStop(1,`hsla(220, 10%, 25%, ${e.alpha*.5})`),t.beginPath(),t.ellipse(a,i,h,h*.7,e.rotation,0,Math.PI*2),t.fillStyle=r,t.fill();break}case"flower":{const r=(e.hue+200+Math.abs(e.x)*.1)%360;t.fillStyle=`hsla(${r}, 70%, 60%, ${e.alpha})`;for(let f=0;f<5;f++){const c=e.rotation+f/5*Math.PI*2;t.beginPath(),t.ellipse(a+Math.cos(c)*h*.4,i+Math.sin(c)*h*.4,h*.3,h*.15,c,0,Math.PI*2),t.fill()}t.beginPath(),t.arc(a,i,h*.15,0,Math.PI*2),t.fillStyle=`hsla(45, 80%, 60%, ${e.alpha})`,t.fill();break}case"moss":{t.fillStyle=`hsla(${140+e.hue}, 35%, 28%, ${e.alpha*.7})`,t.beginPath(),t.arc(a,i,h*.8,0,Math.PI*2),t.fill();break}case"pebble":{t.fillStyle=`hsla(30, 8%, 35%, ${e.alpha*.6})`,t.beginPath(),t.ellipse(a,i,h*.5,h*.35,e.rotation,0,Math.PI*2),t.fill();break}}t.globalAlpha=1}function so(t=null){const{ctx:e,camera:s,W:n,H:o,frameCount:l}=d,a=t||s,i=a.zoom||1,h=-a.x+n/2,r=-a.y+o/2,f=n/i+200,c=o/i+200,g=(n-f)/2,u=(o-c)/2,p=l*.001,m=Math.sin(p)*.02+.98,y=e.createRadialGradient(n/2,o/2,0,n/2,o/2,Math.max(f,c)*.7*m);y.addColorStop(0,`hsl(240, 60%, ${8+Math.sin(p*.5)*2}%)`),y.addColorStop(.6,"#0c0c2d"),y.addColorStop(1,"#040412"),e.fillStyle=y,e.fillRect(g,u,f,c);const C=d.wave||0;if(C>0){const M=C*30%360,k=(.03+Math.min(C*.005,.05))*(1+Math.sin(l*.02)*.3),H=M+Math.sin(l*.01)*10;e.fillStyle=`hsla(${H}, 70%, 45%, ${k})`,e.fillRect(g,u,f,c)}for(const M of Ve){const k=M.x-a.x*M.depth+n/2,H=M.y-a.y*M.depth+o/2,le=(k%n+n)%n,re=(H%o+o)%o,de=Math.sin(l*M.twinkleSpeed+M.x)*.3+.7,et=M.brightness*de;e.beginPath(),e.arc(le,re,M.size,0,Math.PI*2),e.fillStyle=`rgba(200,210,255,${et})`,e.fill()}const v=60,S=300,T=n/2/i,b=o/2/i,I=Math.floor((a.x-T)/v)*v,w=Math.floor((a.y-b)/v)*v;e.strokeStyle="rgba(40, 40, 100, 0.12)",e.lineWidth=.5,e.beginPath();for(let M=I;M<a.x+T+v;M+=v){if(M%S===0)continue;const k=M+h;e.moveTo(k,u),e.lineTo(k,u+c)}for(let M=w;M<a.y+b+v;M+=v){if(M%S===0)continue;const k=M+r;e.moveTo(g,k),e.lineTo(g+f,k)}e.stroke();const O=Math.floor((a.x-T)/S)*S,R=Math.floor((a.y-b)/S)*S;e.strokeStyle="rgba(50, 50, 120, 0.2)",e.lineWidth=1,e.beginPath();for(let M=O;M<a.x+T+S;M+=S){const k=M+h;e.moveTo(k,u),e.lineTo(k,u+c)}for(let M=R;M<a.y+b+S;M+=S){const k=M+r;e.moveTo(g,k),e.lineTo(g+f,k)}e.stroke();const E=d.isMobile?Math.floor(Pe/2):Pe;for(let M=0;M<E;M++)ao(e,je[M],h,r,n,o);for(const M of qe){M.x+=M.vx,M.y+=M.vy,M.x<0&&(M.x+=P.WORLD_W),M.x>P.WORLD_W&&(M.x-=P.WORLD_W),M.y<0&&(M.y+=P.WORLD_H),M.y>P.WORLD_H&&(M.y-=P.WORLD_H);const k=M.x+h,H=M.y+r;k<-50||k>n+50||H<-50||H>o+50||(e.beginPath(),e.arc(k,H,M.r,0,Math.PI*2),e.fillStyle=`rgba(160,170,220,${M.alpha})`,e.fill())}if(d.dangerZone&&d.dangerZone.active){const M=P.WORLD_W/2+h,k=P.WORLD_H/2+r,H=d.dangerZone.radius;e.save(),e.beginPath(),e.rect(0,0,n,o),e.arc(M,k,H,0,Math.PI*2,!0),e.fillStyle="rgba(200, 30, 30, 0.15)",e.fill(),e.beginPath(),e.arc(M,k,H,0,Math.PI*2),e.strokeStyle="rgba(255, 60, 60, 0.5)",e.lineWidth=3,e.setLineDash([12,8]),e.stroke(),e.setLineDash([]),e.restore()}for(const M of d.obstacles)M.draw(e,s,n,o);for(const M of d.portals)M.draw(e,s,n,o);const L=P.BORDER_MARGIN,W=150,N=.25+Math.sin(l*.03)*.1;if(a.x-n/2<L+100){const M=L+h;e.strokeStyle=`rgba(255, 80, 120, ${N})`,e.lineWidth=2,e.shadowColor="rgba(255, 80, 120, 0.6)",e.shadowBlur=15,e.beginPath(),e.moveTo(M,0),e.lineTo(M,o),e.stroke(),e.shadowBlur=0;const k=e.createLinearGradient(M-30,0,M+W,0);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),e.fillStyle=k,e.fillRect(M-30,0,W+30,o)}if(a.x+n/2>P.WORLD_W-L-100){const M=P.WORLD_W-L+h;e.strokeStyle=`rgba(255, 80, 120, ${N})`,e.lineWidth=2,e.shadowColor="rgba(255, 80, 120, 0.6)",e.shadowBlur=15,e.beginPath(),e.moveTo(M,0),e.lineTo(M,o),e.stroke(),e.shadowBlur=0;const k=e.createLinearGradient(M+30,0,M-W,0);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),e.fillStyle=k,e.fillRect(M-W,0,W+30,o)}if(a.y-o/2<L+100){const M=L+r;e.strokeStyle=`rgba(255, 80, 120, ${N})`,e.lineWidth=2,e.shadowColor="rgba(255, 80, 120, 0.6)",e.shadowBlur=15,e.beginPath(),e.moveTo(0,M),e.lineTo(n,M),e.stroke(),e.shadowBlur=0;const k=e.createLinearGradient(0,M-30,0,M+W);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),e.fillStyle=k,e.fillRect(0,M-30,n,W+30)}if(a.y+o/2>P.WORLD_H-L-100){const M=P.WORLD_H-L+r;e.strokeStyle=`rgba(255, 80, 120, ${N})`,e.lineWidth=2,e.shadowColor="rgba(255, 80, 120, 0.6)",e.shadowBlur=15,e.beginPath(),e.moveTo(0,M),e.lineTo(n,M),e.stroke(),e.shadowBlur=0;const k=e.createLinearGradient(0,M+30,0,M-W);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),e.fillStyle=k,e.fillRect(0,M-W,n,W+30)}}function no(){const{mmCtx:t,camera:e,foods:s,worms:n,W:o,H:l}=d,a=document.getElementById("minimap-container"),i=Math.round(parseFloat(getComputedStyle(a).width))||140,h=i;t.clearRect(0,0,i,h),t.fillStyle="rgba(10, 10, 40, 0.5)",t.fillRect(0,0,i,h);const r=i/P.WORLD_W,f=h/P.WORLD_H;if(d.dangerZone&&d.dangerZone.active){const m=P.WORLD_W/2*r,y=P.WORLD_H/2*f,C=d.dangerZone.radius*r;t.save(),t.beginPath(),t.rect(0,0,i,h),t.arc(m,y,C,0,Math.PI*2,!0),t.fillStyle="rgba(200, 30, 30, 0.3)",t.fill(),t.beginPath(),t.arc(m,y,C,0,Math.PI*2),t.strokeStyle="rgba(255, 60, 60, 0.6)",t.lineWidth=1,t.stroke(),t.restore()}t.fillStyle="rgba(100, 200, 100, 0.3)";for(const m of s)m.alive&&t.fillRect(m.x*r,m.y*f,1,1);t.fillStyle="rgba(120, 120, 140, 0.5)";for(const m of d.obstacles){const y=Math.max(1.5,m.radius*r);t.beginPath(),t.arc(m.x*r,m.y*f,y,0,Math.PI*2),t.fill()}for(const m of d.portals){const y=`hsl(${m.hue}, 80%, 60%)`;for(const C of[m.a,m.b])t.beginPath(),t.arc(C.x*r,C.y*f,2.5,0,Math.PI*2),t.fillStyle=y,t.fill()}for(const m of n){if(!m.alive||m.isMinion)continue;const y=Math.max(2,m.radius*r*2);t.beginPath(),t.arc(m.head.x*r,m.head.y*f,y,0,Math.PI*2),m.isBoss?t.fillStyle="#ff4444":t.fillStyle=m.isPlayer?"#ffdd44":m.color.h,t.globalAlpha=m.isPlayer?1:.7,t.fill(),t.globalAlpha=1}const c=(e.x-o/2)*r,g=(e.y-l/2)*f,u=o*r,p=l*f;t.strokeStyle="rgba(255, 255, 255, 0.4)",t.lineWidth=1,t.strokeRect(c,g,u,p)}const Ze="wormy_records",Me={highScore:0,maxLength:0,maxKills:0,longestSurvival:0,totalGames:0};let B=null,F=[];function ye(){try{const t=localStorage.getItem(Ze);B=t?{...Me,...JSON.parse(t)}:{...Me}}catch{B={...Me}}return F=[],B}function Ke(){if(B)try{localStorage.setItem(Ze,JSON.stringify(B))}catch{}}function io(){return B||ye(),B}function lo(){return F}function ro(){F=[]}function Je(t){if(!B)return!1;const{player:e,killCount:s}=t;if(!e)return!1;let n=!1;const o=Math.floor(e.score),l=Math.floor(e.length),a=t.survivalTime||0;return o>B.highScore&&(B.highScore=o,F.includes("highScore")||(F.push("highScore"),n=!0)),l>B.maxLength&&(B.maxLength=l,F.includes("maxLength")||(F.push("maxLength"),n=!0)),s>B.maxKills&&(B.maxKills=s,F.includes("maxKills")||(F.push("maxKills"),n=!0)),a>B.longestSurvival&&(B.longestSurvival=a,F.includes("longestSurvival")||(F.push("longestSurvival"),n=!0)),n}function ho(){B||ye(),B.totalGames++,Ke()}function Ce(t){const e=Math.floor(t/60),s=Math.floor(t%60);return`${e}:${s.toString().padStart(2,"0")}`}const Qe="wormy_achievements";let J={},ge=[];function fo(){try{const t=localStorage.getItem(Qe);J=t?JSON.parse(t):{}}catch{J={}}return ge=[],J}function co(){try{localStorage.setItem(Qe,JSON.stringify(J))}catch{}}function go(){const t=[...ge];return ge=[],t}function uo(t){const{player:e,killCount:s,survivalTime:n,wave:o,bossesAlive:l}=t;if(e)for(const a of fe)J[a.id]||a.check(t)&&(J[a.id]=!0,ge.push(a),co())}function mo(){const t=Ie.filter(s=>{const n=d.selectedSkills.find(o=>o.id===s.id);return!n||n.level<s.maxLevel});if(t.length===0)return null;const e=[...t].sort(()=>Math.random()-.5);return e.slice(0,Math.min(3,e.length))}function De(t){const e=Ie.find(n=>n.id===t);if(!e)return;let s=d.selectedSkills.find(n=>n.id===t);if(s){if(s.level>=e.maxLevel)return;s.level++}else d.selectedSkills.push({id:t,level:1});po()}function po(){const t={};for(const e of d.selectedSkills){const s=Ie.find(n=>n.id===e.id);if(s)for(const[n,o]of Object.entries(s.effect))typeof o=="boolean"?t[n]=o:t[n]=(t[n]||0)+o*e.level}d.skillModifiers=t}function bo(){if(!d.player||!d.player.alive||d.skillChoices)return!1;if(d.player.score>=d.nextSkillScore){const t=mo();if(t&&t.length>0)return d.skillChoices=t,d.nextSkillScore+=500,!0;d.nextSkillScore+=500}return!1}let X=null;function yo(t){X&&ce(),X=document.createElement("div"),X.id="skill-overlay",X.className="skill-overlay";let e='<div class="skill-title">ìŠ¤í‚¬ ì„ íƒ</div>';e+='<div class="skill-cards">';for(const s of t){const n=d.selectedSkills.find(i=>i.id===s.id),l=(n?n.level:0)+1,a=Array.from({length:s.maxLevel},(i,h)=>`<span class="skill-dot${h<l?" filled":""}"></span>`).join("");e+=`
      <button class="skill-card" data-skill="${s.id}">
        <div class="skill-card-icon">${s.icon}</div>
        <div class="skill-card-name">${s.name}</div>
        <div class="skill-card-desc">${s.desc}</div>
        <div class="skill-card-level">${a} Lv.${l}</div>
      </button>
    `}e+="</div>",X.innerHTML=e,document.body.appendChild(X),X.querySelectorAll(".skill-card").forEach(s=>{s.addEventListener("click",n=>{n.stopPropagation();const o=s.dataset.skill;De(o),Re(),ce(),d.skillChoices=null}),s.addEventListener("touchend",n=>{n.preventDefault(),n.stopPropagation();const o=s.dataset.skill;De(o),Re(),ce(),d.skillChoices=null})}),requestAnimationFrame(()=>X.classList.add("active"))}function ce(){X&&(X.remove(),X=null)}function Mo(){return X!==null}d.foodGrid=new Xe(100);d.segmentGrid=new Xe(100);d.onGameOver=()=>vo();function So(){if(d.playerName=document.getElementById("nickname").value.trim()||"ë‚˜",document.getElementById("menu-screen").classList.add("hidden"),document.getElementById("hud").classList.add("active"),document.getElementById("minion-wrap").style.display="block",document.getElementById("boost-wrap").style.display="block",document.getElementById("minimap-container").style.display="block",d.isMobile){const s=document.getElementById("joystick-area");s&&(s.style.display="block")}d.killCount=0,d.minionCooldown=0,d.activeItemEffects=[],d.notifications=[],d.survivalTime=0,d.damageVignette=0,d.floatTexts=[],d.foodAbsorbs=[],d.wave=0,d.waveTimer=0,d.skillChoices=null,d.selectedSkills=[],d.skillModifiers={},d.nextSkillScore=500,d.obstacles=[],d.portals=[],d.dangerZone={active:!1,radius:0},d.bossesAlive=0,d.evolutionFlash=0,ye(),ro(),ho(),fo(),d._bossKilled=!1;const t=P.WORLD_W/2,e=P.WORLD_H/2;d.player=new ue(t,e,d.selectedColor,d.playerName,!0),d.worms=[d.player];for(let s=0;s<P.AI_COUNT;s++)Ue();d.foods=[];for(let s=0;s<P.FOOD_COUNT;s++)d.foods.push(me.acquire());d.items=[];for(let s=0;s<P.ITEM_COUNT;s++)d.items.push(new He);d.particles=[],d.camera.x=t,d.camera.y=e,d.camera.targetX=t,d.camera.targetY=e,d.gameState="playing",It(),Gt(),document.getElementById("mute-btn").style.display="block"}function vo(){const{player:t,killCount:e}=d;d.gameState="gameover",Fe(),Ot(),ce(),d.skillChoices=null,d.screenShake=1,Je(d),Ke();const s=io(),n=lo();document.getElementById("mute-btn").style.display="none";const o=document.getElementById("joystick-area");o&&(o.style.display="none");const l=G[t.evolutionStage]||G[0];document.getElementById("go-evo-icon").textContent=l.icon;const a=document.getElementById("go-wave");a&&(a.textContent=d.wave>0?`ðŸŒŠ ì›¨ì´ë¸Œ ${d.wave} ë„ë‹¬`:"");const i=document.getElementById("go-score-val"),h=document.getElementById("go-length-val"),r=document.getElementById("go-kills-val"),f=document.getElementById("go-time-val");i&&(i.textContent=Math.floor(t.score)),h&&(h.textContent=Math.floor(t.length)),r&&(r.textContent=e),f&&(f.textContent=Ce(d.survivalTime));const c=document.getElementById("go-records");if(c){let g="";n.length>0&&(g+='<div class="go-new-record">ðŸ† ìƒˆ ê¸°ë¡!</div>'),g+='<div class="go-record-list">',g+=`<span>ìµœê³  ${s.highScore}ì </span>`,g+=`<span>ìµœëŒ€ ê¸¸ì´ ${s.maxLength}</span>`,g+=`<span>ìµœë‹¤ í‚¬ ${s.maxKills}</span>`,g+=`<span>ìµœìž¥ ìƒì¡´ ${Ce(s.longestSurvival)}</span>`,g+="</div>",c.innerHTML=g}document.getElementById("game-over").classList.add("active"),document.getElementById("hud").classList.remove("active"),document.getElementById("minion-wrap").style.display="none",document.getElementById("boost-wrap").style.display="none",document.getElementById("minimap-container").style.display="none"}function xe(t){if(requestAnimationFrame(xe),d.gameState!=="playing"||Mo())return;const e=Math.min((t-d.lastTime)/1e3,.05);d.lastTime=t,d.frameCount++;const{player:s,worms:n,foods:o,items:l,particles:a,ctx:i,camera:h,mouse:r,W:f,H:c}=d;if(s&&s.alive){const b=r.x-f/2,I=r.y-c/2;s.targetAngle=Math.atan2(I,b),s.boosting=d.boosting}for(const b of n)if(b.alive&&(b.isPlayer||bt(b,e),b.update(e),!b.isMinion)){const I=gt(b);if(I.evolved&&b.isPlayer){q(`âœ¨ ${I.stage.icon} ${I.stage.name}(ìœ¼)ë¡œ ì§„í™”!`,"#ffdd44","large"),Dt();for(let w=0;w<50;w++){const O=["#ffdd44","#ff8844","#ffaa00","#ffffff","#ff66ff","#66ffff"],R=O[Math.random()*O.length|0],E=40+w*.5,L=Math.PI*2/50*w+Math.random()*.5,W=Math.random()*E,N=b.head.x+Math.cos(L)*W,M=b.head.y+Math.sin(L)*W,k=K.acquire(N,M,R,4+Math.random()*4);d.particles.push(k)}d.evolutionFlash=1}}d.foodGrid.clear();for(const b of o)b.alive&&d.foodGrid.insert(b,b.x,b.y);d.segmentGrid.clear();for(const b of n){if(!b.alive)continue;let I=3;b.length>100?I=Math.max(5,Math.floor(b.length/30)):b.length>50&&(I=5);for(let w=5;w<b.segments.length;w+=I){const O=b.segments[w];d.segmentGrid.insert({worm:b,segIndex:w,x:O.x,y:O.y},O.x,O.y)}}Nt(),qt(),jt(),Ut(e),Vt(e),Qt(),xt(),eo();const g=[];for(const b of o)b.alive?g.push(b):me.release(b);d.foods=g,d.items=l.filter(b=>b.alive),d.worms=n.filter(b=>b.alive||b.isPlayer);const u=[];for(const b of a)b.update(e)?u.push(b):K.release(b);if(d.particles=u,Ht(),d.minionCooldown>0&&(d.minionCooldown-=e*1e3),d.survivalTime+=e,Zt(e),d.frameCount%60===0&&Je(d)&&q("ðŸ† ìƒˆ ê¸°ë¡!","#ffdd44"),d.frameCount%30===0){uo(d);const b=go();for(const I of b)q(`ðŸ… ì—…ì  ë‹¬ì„±: ${I.name}!`,"#44ddff"),Lt()}if(bo()){yo(d.skillChoices);return}d.damageVignette>0&&(d.damageVignette-=e*2,d.damageVignette<0&&(d.damageVignette=0));const p={x:h.x+d.screenShakeX,y:h.y+d.screenShakeY,zoom:h.zoom},m=h.zoom,y=f/m,C=c/m;i.save(),i.translate(f/2,c/2),i.scale(m,m),i.translate(-f/2,-c/2),so(p);for(const b of d.foods)b.draw(i,p);for(const b of d.items)b.draw(i,p);for(const b of d.particles)b.draw(i,p);Ct(i,p,e);const v=[...d.worms].filter(b=>b.alive).sort((b,I)=>b.length-I.length),S=500/m,T={left:h.x-y/2-S,right:h.x+y/2+S,top:h.y-C/2-S,bottom:h.y+C/2+S};for(const b of v)!b.isPlayer&&(b.head.x<T.left||b.head.x>T.right||b.head.y<T.top||b.head.y>T.bottom)||b.draw(i,p);vt(i,p,e),i.restore(),s&&s.alive&&s.boosting&&Tt(i,f,c),d.evolutionFlash>0&&(i.fillStyle=`rgba(255,240,180,${d.evolutionFlash*.35})`,i.fillRect(0,0,f,c),d.evolutionFlash-=e*3,d.evolutionFlash<0&&(d.evolutionFlash=0)),d.frameCount%10===0&&St(),d.frameCount%20===0&&no()}let Te=null;function Po(){const t=document.getElementById("color-grid");Z.forEach((e,s)=>{const n=document.createElement("button");n.className="color-btn"+(s===0?" selected":""),n.style.background=`radial-gradient(circle at 40% 35%, ${e.l}, ${e.h}, ${e.b})`,n.addEventListener("click",()=>{document.querySelectorAll(".color-btn").forEach(o=>o.classList.remove("selected")),n.classList.add("selected"),d.selectedColor=s}),t.appendChild(n)}),document.getElementById("play-btn").addEventListener("click",()=>{Te&&cancelAnimationFrame(Te),So()}),document.getElementById("retry-btn").addEventListener("click",()=>{document.getElementById("game-over").classList.remove("active"),document.getElementById("menu-screen").classList.remove("hidden"),d.gameState="menu",Be(),Ge(),We()}),Co(),Be(),Ge(),We()}function Co(){const t=document.getElementById("menu-particles");if(!t)return;const e=15;for(let s=0;s<e;s++){const n=document.createElement("div");n.className="particle";const o=4+Math.random()*8,l=Math.random()*360;n.style.width=o+"px",n.style.height=o+"px",n.style.left=Math.random()*100+"%",n.style.top=Math.random()*100+"%",n.style.background=`hsla(${l}, 70%, 60%, 0.3)`,n.style.animationDelay=Math.random()*8+"s",n.style.animationDuration=6+Math.random()*6+"s",t.appendChild(n)}}function We(){const t=document.getElementById("preview-canvas");if(!t)return;const e=t.getContext("2d"),s=t.width,n=t.height;let o=0;function l(){Te=requestAnimationFrame(l),o+=.03,e.clearRect(0,0,s,n);const a=Z[d.selectedColor],i=12,h=6;for(let p=i-1;p>=0;p--){const m=p/i,y=s/2+Math.cos(o+p*.4)*20+(p-i/2)*6,C=n/2+Math.sin(o*2+p*.3)*8,v=h*(1-m*.4),S=e.createRadialGradient(y-v*.3,C-v*.3,0,y,C,v);S.addColorStop(0,a.l),S.addColorStop(.5,a.h),S.addColorStop(1,a.b),e.beginPath(),e.arc(y,C,v,0,Math.PI*2),e.fillStyle=S,e.fill()}const r=s/2+Math.cos(o)*20-i/2*6+i*3,f=n/2+Math.sin(o*2)*8,c=h*1.3,g=e.createRadialGradient(r-c*.3,f-c*.3,0,r,f,c);g.addColorStop(0,"#fff"),g.addColorStop(.3,a.l),g.addColorStop(.7,a.h),g.addColorStop(1,a.b),e.beginPath(),e.arc(r,f,c,0,Math.PI*2),e.fillStyle=g,e.fill();const u=Math.atan2(Math.sin(o*2)*.5,1);for(const p of[-1,1]){const m=r+Math.cos(u-p*.5)*c*.35,y=f+Math.sin(u-p*.5)*c*.35;e.beginPath(),e.arc(m,y,c*.3,0,Math.PI*2),e.fillStyle="#fff",e.fill(),e.beginPath(),e.arc(m+Math.cos(u)*c*.08,y+Math.sin(u)*c*.08,c*.18,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(m+Math.cos(u)*c*.04-c*.06,y-c*.06,c*.07,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill()}}l()}function Be(){const t=ye(),e=document.getElementById("menu-records");if(e){if(t.totalGames===0){e.innerHTML="";return}e.innerHTML=`
    <div class="records-title">ðŸ† ë‚´ ê¸°ë¡</div>
    <div class="records-grid">
      <div class="record-item"><span class="record-label">ìµœê³ ì ìˆ˜</span><span class="record-val">${t.highScore}</span></div>
      <div class="record-item"><span class="record-label">ìµœëŒ€ê¸¸ì´</span><span class="record-val">${t.maxLength}</span></div>
      <div class="record-item"><span class="record-label">ìµœë‹¤í‚¬</span><span class="record-val">${t.maxKills}</span></div>
      <div class="record-item"><span class="record-label">ìµœìž¥ìƒì¡´</span><span class="record-val">${Ce(t.longestSurvival)}</span></div>
      <div class="record-item"><span class="record-label">í”Œë ˆì´</span><span class="record-val">${t.totalGames}íšŒ</span></div>
    </div>
  `}}function Ge(){const t=document.getElementById("menu-achievements");if(!t)return;let e;try{const o=localStorage.getItem("wormy_achievements");e=o?JSON.parse(o):{}}catch{e={}}if(fe.length===0){t.innerHTML="";return}let n=`<div class="achieve-title">ðŸ… ì—…ì  (${Object.keys(e).length}/${fe.length})</div>`;n+='<div class="achieve-grid">';for(const o of fe){const l=!e[o.id];n+=`<div class="achieve-item${l?" locked":""}" title="${o.desc}">
      <span class="achieve-icon">${o.icon}</span>
      <span class="achieve-name">${o.name}</span>
    </div>`}n+="</div>",t.innerHTML=n}function To(){return/Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0}function Io(){const{canvas:t}=d;d.isMobile=To(),document.addEventListener("touchmove",s=>{d.gameState==="playing"&&s.preventDefault()},{passive:!1}),t.addEventListener("mousemove",s=>{d.mouse.x=s.clientX,d.mouse.y=s.clientY}),t.addEventListener("touchmove",s=>{s.preventDefault(),!d.joystick.active&&(d.mouse.x=s.touches[0].clientX,d.mouse.y=s.touches[0].clientY)},{passive:!1}),t.addEventListener("touchstart",s=>{s.preventDefault(),!d.joystick.active&&(d.mouse.x=s.touches[0].clientX,d.mouse.y=s.touches[0].clientY)},{passive:!1});const e=document.getElementById("boost-btn");e.addEventListener("mousedown",s=>{s.stopPropagation(),d.boosting=!0}),e.addEventListener("mouseup",()=>{d.boosting=!1}),e.addEventListener("mouseleave",()=>{d.boosting=!1}),e.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation(),d.boosting=!0}),e.addEventListener("touchend",s=>{s.preventDefault(),d.boosting=!1}),document.addEventListener("keydown",s=>{s.code==="Space"&&(d.boosting=!0)}),document.addEventListener("keyup",s=>{s.code==="Space"&&(d.boosting=!1)}),document.getElementById("minion-btn").addEventListener("click",Jt),document.getElementById("mute-btn").addEventListener("click",()=>{const s=$t();document.getElementById("mute-btn").textContent=s?"ðŸ”‡":"ðŸ”Š"}),d.isMobile&&ko()}function ko(){const t=document.getElementById("joystick-area"),e=document.getElementById("joystick-base"),s=document.getElementById("joystick-knob");if(!t)return;t.style.display="block";const n=50;t.addEventListener("touchstart",l=>{l.preventDefault(),l.stopPropagation();const a=l.touches[0],i=t.getBoundingClientRect();d.joystick.active=!0,d.joystick.id=a.identifier,d.joystick.startX=a.clientX,d.joystick.startY=a.clientY,d.joystick.currentX=a.clientX,d.joystick.currentY=a.clientY;const h=a.clientX-i.left,r=a.clientY-i.top;e.style.left=h+"px",e.style.top=r+"px",e.style.opacity="1",s.style.transform="translate(-50%, -50%)"},{passive:!1}),t.addEventListener("touchmove",l=>{l.preventDefault(),l.stopPropagation();for(const a of l.changedTouches)if(a.identifier===d.joystick.id){d.joystick.currentX=a.clientX,d.joystick.currentY=a.clientY;let i=a.clientX-d.joystick.startX,h=a.clientY-d.joystick.startY;const r=Math.hypot(i,h);r>n&&(i=i/r*n,h=h/r*n),s.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${h}px))`,r>5&&(d.mouse.x=d.W/2+i*5,d.mouse.y=d.H/2+h*5)}},{passive:!1});const o=l=>{for(const a of l.changedTouches)a.identifier===d.joystick.id&&(d.joystick.active=!1,d.joystick.id=null,e.style.opacity="0.4",s.style.transform="translate(-50%, -50%)")};t.addEventListener("touchend",o),t.addEventListener("touchcancel",o)}d.canvas=document.getElementById("game");d.ctx=d.canvas.getContext("2d");d.mmCanvas=document.getElementById("minimap");d.mmCtx=d.mmCanvas.getContext("2d");function we(){d.dpr=Math.min(window.devicePixelRatio||1,2),d.W=window.innerWidth,d.H=window.innerHeight;const{canvas:t,ctx:e,mmCanvas:s,mmCtx:n,dpr:o,W:l,H:a}=d;t.width=l*o,t.height=a*o,t.style.width=l+"px",t.style.height=a+"px",e.setTransform(o,0,0,o,0,0);const i=document.getElementById("minimap-container"),h=Math.round(parseFloat(getComputedStyle(i).width))||140;s.width=h*o,s.height=h*o,s.style.width=h+"px",s.style.height=h+"px",n.setTransform(o,0,0,o,0,0)}window.addEventListener("resize",we);window.addEventListener("orientationchange",()=>setTimeout(we,150));we();dt();Po();Io();requestAnimationFrame(xe);
