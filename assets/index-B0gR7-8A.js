(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const s of l.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function a(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(o){if(o.ep)return;o.ep=!0;const l=a(o);fetch(o.href,l)}})();const r={gameState:"menu",selectedColor:0,playerName:"",player:null,worms:[],foods:[],items:[],particles:[],camera:{x:0,y:0,targetX:0,targetY:0,zoom:1,targetZoom:1},mouse:{x:0,y:0},boosting:!1,killCount:0,minionCooldown:0,frameCount:0,notifications:[],activeItemEffects:[],lastTime:0,survivalTime:0,wave:0,waveTimer:0,skillChoices:null,selectedSkills:[],skillModifiers:{},nextSkillScore:500,achievements:{},obstacles:[],portals:[],dangerZone:{active:!1,radius:0},bossesAlive:0,evolutionFlash:0,screenShake:0,screenShakeX:0,screenShakeY:0,foodGrid:null,segmentGrid:null,canvas:null,ctx:null,mmCanvas:null,mmCtx:null,W:0,H:0,dpr:1,damageVignette:0,speedLines:!1,floatTexts:[],foodAbsorbs:[],isMobile:!1,joystick:{active:!1,startX:0,startY:0,currentX:0,currentY:0,id:null}},P={WORLD_W:5e3,WORLD_H:5e3,FOOD_COUNT:400,ITEM_COUNT:15,AI_COUNT:12,SEGMENT_DIST:6,BASE_SPEED:2.8,BOOST_SPEED:5.2,BOOST_DRAIN:.15,INITIAL_LENGTH:20,HEAD_RADIUS_BASE:14,ITEM_RADIUS:12,MINION_COUNT:5,MINION_DURATION:12e3,MINION_COOLDOWN:25e3,ITEM_DURATION:8e3,EAT_DISTANCE:1.3,BORDER_MARGIN:80,CAMERA_SMOOTH:.08},Z=[{name:"í•‘í¬",h:"#ff6b9d",b:"#ff4477",l:"#ffaac8"},{name:"ë³´ë¼",h:"#c44dff",b:"#9933dd",l:"#dd88ff"},{name:"íŒŒëž‘",h:"#4d8bff",b:"#2266dd",l:"#88bbff"},{name:"í•˜ëŠ˜",h:"#44ddff",b:"#22aadd",l:"#88eeff"},{name:"ì´ˆë¡",h:"#44dd88",b:"#22aa66",l:"#88ffbb"},{name:"ë…¸ëž‘",h:"#ffdd44",b:"#ddaa22",l:"#ffee88"},{name:"ì£¼í™©",h:"#ff8844",b:"#dd6622",l:"#ffbb88"},{name:"ë¹¨ê°•",h:"#ff4455",b:"#dd2233",l:"#ff8899"}],Oe=[{id:"speed",icon:"âš¡",name:"ê°€ì†",color:"#ffdd44",desc:"ì´ë™ ì†ë„ ì¦ê°€"},{id:"shield",icon:"ðŸ›¡ï¸",name:"ë°©ì–´ë§‰",color:"#44ddff",desc:"ì¼ì • ì‹œê°„ ë¬´ì "},{id:"magnet",icon:"ðŸ§²",name:"ìžì„",color:"#ff4455",desc:"ì£¼ë³€ ë¨¹ì´ í¡ìˆ˜"},{id:"growth",icon:"â­",name:"ì„±ìž¥",color:"#44dd88",desc:"ì¦‰ì‹œ ì„±ìž¥"},{id:"freeze",icon:"â„ï¸",name:"ë¹™ê²°",color:"#aaddff",desc:"ì£¼ë³€ ì  ê°ì†"}],Ee=["ë³„ì´","ë‹¬ì´","í•´í”¼","ëŸ­í‚¤","ì½”ì½”","ëª¨ëª¨","ë‘ë¶€","ì½©ì´","ë‚˜ë¹„","ë´„ì´","í•˜ë£¨","ì†Œë¼","êµ¬ë¦„","ë°”ë‹¤","í’€ìžŽ","ê½ƒìžŽ"],G=[{name:"ì•„ê¸° ì§€ë ì´",icon:"ðŸ›",minScore:0,turnMod:1,eatMod:1,decoration:null,headScale:1,colorIntensity:1,eyeStyle:"baby",aura:null,trailParticles:!1},{name:"ì§€ë ì´",icon:"ðŸª±",minScore:10,turnMod:1.05,eatMod:1.05,decoration:null,headScale:1.06,colorIntensity:1.1,eyeStyle:"alert",aura:{color:"255,220,100",radius:1.8,alpha:.18,pulse:1.5},trailParticles:!1},{name:"í° ì§€ë ì´",icon:"ðŸ",minScore:30,turnMod:1.1,eatMod:1.1,decoration:"horns",headScale:1.15,colorIntensity:1.2,eyeStyle:"fierce",aura:{color:"255,160,60",radius:2.2,alpha:.25,pulse:2},trailParticles:!1},{name:"ë±€",icon:"ðŸ‘‘",minScore:60,turnMod:1.2,eatMod:1.2,decoration:"crown",headScale:1.25,colorIntensity:1.35,eyeStyle:"regal",aura:{color:"200,120,255",radius:2.6,alpha:.3,pulse:2.5},trailParticles:!1},{name:"ìš©",icon:"ðŸ‰",minScore:120,turnMod:1.3,eatMod:1.3,decoration:"wings",headScale:1.35,colorIntensity:1.5,eyeStyle:"dragon",aura:{color:"255,80,30",radius:3,alpha:.35,pulse:3},trailParticles:!0}],Y={DURATION:60,FOOD_PER_WAVE:30,AI_PER_WAVE:2,AI_LENGTH_PER_WAVE:10,BOSS_WAVES:[3,6,9,12],BOSS_LENGTH_MULT:3,WAVE_BONUS_MULT:20},Ie=[{id:"speedUp",icon:"ðŸ’¨",name:"ì§€ì† ë¶€ìŠ¤íŠ¸",desc:"ê¸°ë³¸ ì´ë™ì†ë„ +10%",maxLevel:3,effect:{speedMult:.1}},{id:"fastMove",icon:"âš¡",name:"ë¹ ë¥¸ ì´ë™",desc:"ë¶€ìŠ¤íŠ¸ ë“œë ˆì¸ -20%",maxLevel:3,effect:{boostDrainMult:-.2}},{id:"wideEat",icon:"ðŸ‘„",name:"ë„“ì€ ìž…",desc:"ë¨¹ê¸° ë²”ìœ„ +15%",maxLevel:3,effect:{eatRadiusMult:.15}},{id:"moreMinions",icon:"ðŸ‘¥",name:"ë¶€í•˜ ì¦ì›",desc:"ì†Œí™˜ ë¶€í•˜ +2",maxLevel:2,effect:{minionCountBonus:2}},{id:"fastSummon",icon:"ðŸ”„",name:"ë¹ ë¥¸ ì†Œí™˜",desc:"ì†Œí™˜ ì¿¨ë‹¤ìš´ -25%",maxLevel:2,effect:{minionCdMult:-.25}},{id:"autoMagnet",icon:"ðŸ§²",name:"ìžë™ í¡ìˆ˜",desc:"ê·¼ì²˜ ë¨¹ì´ ìžë™ í¡ìˆ˜",maxLevel:1,effect:{autoMagnet:!0}},{id:"regen",icon:"ðŸ’š",name:"ìž¬ìƒ",desc:"ì´ˆë‹¹ ê¸¸ì´ +0.5 ìž¬ìƒ",maxLevel:3,effect:{regenPerSec:.5}},{id:"shield",icon:"ðŸ›¡ï¸",name:"ë³´í˜¸ë§‰",desc:"ë¶€í™œ 1íšŒ (ê¸¸ì´ 50%)",maxLevel:1,effect:{revive:!0}},{id:"scoreBoost",icon:"ðŸ’°",name:"ì ìˆ˜ ë¶€ìŠ¤íŠ¸",desc:"ì ìˆ˜ íšë“ +20%",maxLevel:3,effect:{scoreMult:.2}},{id:"freezeAura",icon:"â„ï¸",name:"ëƒ‰ê¸° ì˜¤ë¼",desc:"ê·¼ì²˜ ì  10% ê°ì†",maxLevel:2,effect:{freezeAura:.1}}],fe=[{id:"firstKill",icon:"ðŸ—¡ï¸",name:"ì²« ì‚¬ëƒ¥",desc:"ì²˜ìŒìœ¼ë¡œ ì ì„ ì²˜ì¹˜",check:t=>t.killCount>=1},{id:"kill10",icon:"âš”ï¸",name:"ì‚¬ëƒ¥ê¾¼",desc:"í•œ ê²Œìž„ì—ì„œ 10í‚¬",check:t=>t.killCount>=10},{id:"length100",icon:"ðŸ“",name:"ê¸´ ëª¸",desc:"ê¸¸ì´ 100 ë„ë‹¬",check:t=>t.player&&t.player.length>=100},{id:"length300",icon:"ðŸ²",name:"ëŒ€ìž¥ ì§€ë ì´",desc:"ê¸¸ì´ 300 ë„ë‹¬",check:t=>t.player&&t.player.length>=300},{id:"survive3m",icon:"â±ï¸",name:"3ë¶„ ìƒì¡´",desc:"3ë¶„ê°„ ìƒì¡´",check:t=>t.survivalTime>=180},{id:"survive5m",icon:"ðŸ•",name:"5ë¶„ ìƒì¡´",desc:"5ë¶„ê°„ ìƒì¡´",check:t=>t.survivalTime>=300},{id:"score1000",icon:"â­",name:"ì²œì ",desc:"ì ìˆ˜ 1000 ë„ë‹¬",check:t=>t.player&&t.player.score>=1e3},{id:"score5000",icon:"ðŸŒŸ",name:"ë§Œì ì™•",desc:"ì ìˆ˜ 5000 ë„ë‹¬",check:t=>t.player&&t.player.score>=5e3},{id:"evolveDragon",icon:"ðŸ‰",name:"ìš© ì§„í™”",desc:"ìš©ìœ¼ë¡œ ì§„í™”",check:t=>t.player&&t.player.evolutionStage>=4},{id:"wave5",icon:"ðŸŒŠ",name:"ì›¨ì´ë¸Œ 5",desc:"ì›¨ì´ë¸Œ 5 ë„ë‹¬",check:t=>t.wave>=5},{id:"bossKill",icon:"ðŸ’€",name:"ë³´ìŠ¤ ì²˜ì¹˜",desc:"ë³´ìŠ¤ë¥¼ ì²˜ì¹˜",check:t=>t._bossKilled},{id:"skillMaster",icon:"ðŸŽ“",name:"ìŠ¤í‚¬ ë§ˆìŠ¤í„°",desc:"ìŠ¤í‚¬ 5ê°œ ì´ìƒ ì„ íƒ",check:t=>t.selectedSkills&&t.selectedSkills.length>=5}],V=[{id:"small",weight:60,radiusMin:2.5,radiusMax:4,scoreValue:5,growValue:1,golden:!1},{id:"medium",weight:25,radiusMin:4.5,radiusMax:6.5,scoreValue:10,growValue:2,golden:!1},{id:"large",weight:10,radiusMin:7,radiusMax:9,scoreValue:25,growValue:4,golden:!1},{id:"golden",weight:5,radiusMin:5,radiusMax:7,scoreValue:50,growValue:6,golden:!0}],tt=V.reduce((t,e)=>t+e.weight,0),$e=[];{let t=0;for(const e of V)t+=e.weight,$e.push(t)}function ot(){const t=Math.random()*tt;for(let e=0;e<V.length;e++)if(t<$e[e])return V[e];return V[0]}const $={OBSTACLES_PER_WAVE:3,MAX_OBSTACLES:30,OBSTACLE_RADIUS_MIN:20,OBSTACLE_RADIUS_MAX:60,PORTALS_EVERY_N_WAVES:2,MAX_PORTAL_PAIRS:5,PORTAL_RADIUS:25,PORTAL_COOLDOWN:3e3,DANGER_ZONE_START_WAVE:5,DANGER_ZONE_SHRINK_RATE:2,DANGER_ZONE_MIN_RADIUS:800,DANGER_ZONE_DAMAGE:.5};function _(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}function oe(t,e,a){return t+(e-t)*a}function z(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function A(t,e){return t+Math.random()*(e-t)}function Q(t,e){return Math.floor(A(t,e+1))}function Ae(t,e,a){return Math.max(e,Math.min(a,t))}function ke(){return{x:A(200,P.WORLD_W-200),y:A(200,P.WORLD_H-200)}}const se=[];for(let t=4;t<=45;t+=2)se.push(t);const Se=new Map;function Ne(t,e,a=0){const o=Math.ceil((e+6)*2),l=document.createElement("canvas");l.width=o,l.height=o;const s=l.getContext("2d"),n=o/2,h=o/2,d=e;return a===0?at(s,n,h,d,t):a===1?st(s,n,h,d,t):a===2?nt(s,n,h,d,t):a===3?it(s,n,h,d,t):a>=4?lt(s,n,h,d,t):l}function at(t,e,a,i,o){t.shadowColor="rgba(0,0,0,0.2)",t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=3,t.beginPath(),t.arc(e,a,i,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const l=t.createRadialGradient(e-i*.3,a-i*.3,0,e,a,i);return l.addColorStop(0,"#ffffff"),l.addColorStop(.3,o.l),l.addColorStop(.7,o.h),l.addColorStop(1,o.b),t.beginPath(),t.arc(e,a,i,0,Math.PI*2),t.fillStyle=l,t.fill(),t.beginPath(),t.ellipse(e-i*.2,a-i*.2,i*.4,i*.3,0,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.4)",t.fill(),t.canvas}function st(t,e,a,i,o){t.shadowColor="rgba(0,0,0,0.25)",t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=3,t.beginPath(),t.ellipse(e,a,i*1.1,i*.9,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const l=t.createRadialGradient(e-i*.3,a-i*.3,0,e,a,i);return l.addColorStop(0,o.l),l.addColorStop(.35,o.h),l.addColorStop(.7,o.b),l.addColorStop(1,ne(o.b,.7)),t.beginPath(),t.ellipse(e,a,i*1.1,i*.9,0,0,Math.PI*2),t.fillStyle=l,t.fill(),t.beginPath(),t.ellipse(e-i*.15,a-i*.35,i*.6,i*.25,-.3,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.25)",t.fill(),t.canvas}function nt(t,e,a,i,o){const l=i*1.15,s=i*.9;t.shadowColor="rgba(0,0,0,0.4)",t.shadowOffsetX=1.5,t.shadowOffsetY=3,t.shadowBlur=6,t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const n=t.createRadialGradient(e-l*.25,a-s*.35,0,e,a,l*1.1);n.addColorStop(0,ae(o.h,1.4)),n.addColorStop(.15,ae(o.h,1.15)),n.addColorStop(.4,o.h),n.addColorStop(.7,o.b),n.addColorStop(.85,ne(o.b,.8)),n.addColorStop(1,ne(o.b,.5)),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle=n,t.fill(),t.save(),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.clip();const h=Math.max(4,i*.25),d=Math.ceil(s*2/(h*.6)),f=Math.ceil(l*2/(h*.8));for(let g=0;g<d;g++)for(let u=0;u<f;u++){const p=g%2*h*.4,m=e-l+u*h*.8+p,y=a-s+g*h*.6,C=t.createRadialGradient(m-h*.1,y-h*.1,0,m,y,h*.4);C.addColorStop(0,"rgba(255,255,255,0.15)"),C.addColorStop(.5,"rgba(255,255,255,0.05)"),C.addColorStop(1,"rgba(0,0,0,0.1)"),t.beginPath(),t.ellipse(m,y,h*.35,h*.25,Math.PI*.1,0,Math.PI*2),t.fillStyle=C,t.fill(),t.strokeStyle="rgba(0,0,0,0.08)",t.lineWidth=.3,t.stroke()}t.restore();const c=t.createLinearGradient(e,a-s*.2,e,a+s*.6);return c.addColorStop(0,"rgba(255,255,255,0)"),c.addColorStop(.3,"rgba(255,255,255,0.12)"),c.addColorStop(.7,"rgba(255,255,255,0.08)"),c.addColorStop(1,"rgba(255,255,255,0)"),t.beginPath(),t.ellipse(e,a+s*.1,l*.6,s*.4,0,0,Math.PI*2),t.fillStyle=c,t.fill(),t.beginPath(),t.ellipse(e-l*.15,a-s*.25,l*.5,s*.15,-.2,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.2)",t.fill(),t.canvas}function it(t,e,a,i,o){const l=i*1.25,s=i*.95;t.shadowColor="rgba(0,0,0,0.5)",t.shadowOffsetX=2,t.shadowOffsetY=4,t.shadowBlur=8,t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const n=t.createRadialGradient(e-l*.2,a-s*.3,0,e,a,l*1.2);n.addColorStop(0,"#fffacd"),n.addColorStop(.1,"#ffd700"),n.addColorStop(.25,"#ffed4e"),n.addColorStop(.4,o.h),n.addColorStop(.6,"#daa520"),n.addColorStop(.8,o.b),n.addColorStop(1,"#8b6914"),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle=n,t.fill(),t.save(),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.clip();const h=Math.max(5,i*.28),d=h*Math.sqrt(3)/2,f=Math.ceil(s*2/(d*1.5)),c=Math.ceil(l*2/(h*1.5));for(let u=0;u<f;u++)for(let p=0;p<c;p++){const m=u%2*h*.75,y=e-l+p*h*1.5+m,C=a-s+u*d*1.5,v=t.createRadialGradient(y-h*.2,C-h*.2,0,y,C,h*.6);v.addColorStop(0,"rgba(255,255,200,0.4)"),v.addColorStop(.3,"rgba(255,215,0,0.25)"),v.addColorStop(.7,"rgba(218,165,32,0.15)"),v.addColorStop(1,"rgba(139,105,20,0.2)"),t.beginPath();for(let S=0;S<6;S++){const T=S*Math.PI/3,b=y+Math.cos(T)*h*.35,I=C+Math.sin(T)*h*.35;S===0?t.moveTo(b,I):t.lineTo(b,I)}t.closePath(),t.fillStyle=v,t.fill(),t.strokeStyle="rgba(184,134,11,0.4)",t.lineWidth=.8,t.stroke(),t.beginPath(),t.arc(y,C,1.5,0,Math.PI*2),t.fillStyle="rgba(255,255,100,0.9)",t.fill()}t.restore();const g=t.createLinearGradient(e,a-s*.3,e,a+s*.5);return g.addColorStop(0,"rgba(255,255,255,0)"),g.addColorStop(.2,"rgba(255,255,200,0.25)"),g.addColorStop(.5,"rgba(255,215,0,0.15)"),g.addColorStop(.8,"rgba(255,255,200,0.1)"),g.addColorStop(1,"rgba(255,255,255,0)"),t.beginPath(),t.ellipse(e,a+s*.05,l*.7,s*.5,0,0,Math.PI*2),t.fillStyle=g,t.fill(),t.beginPath(),t.ellipse(e-l*.1,a-s*.3,l*.6,s*.2,-.15,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.3)",t.fill(),t.beginPath(),t.ellipse(e-l*.2,a-s*.15,l*.3,s*.1,-.2,0,Math.PI*2),t.fillStyle="rgba(255,215,0,0.2)",t.fill(),t.canvas}function lt(t,e,a,i,o){const l=i*1.35,s=i*1.05;t.shadowColor="rgba(0,0,0,0.6)",t.shadowOffsetX=3,t.shadowOffsetY=5,t.shadowBlur=10,t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle="rgba(0,0,0,0)",t.fill(),t.shadowColor="transparent",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0;const n=t.createRadialGradient(e-l*.25,a-s*.3,0,e,a,l*1.3);n.addColorStop(0,ae(o.h,1.8)),n.addColorStop(.08,ae(o.h,1.5)),n.addColorStop(.2,ae(o.h,1.2)),n.addColorStop(.35,o.h),n.addColorStop(.5,o.b),n.addColorStop(.65,ne(o.b,.8)),n.addColorStop(.8,ne(o.b,.6)),n.addColorStop(.92,"#2d1810"),n.addColorStop(1,"#0a0000"),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.fillStyle=n,t.fill(),t.save(),t.beginPath(),t.ellipse(e,a,l,s,0,0,Math.PI*2),t.clip();const h=Math.max(6,i*.3),d=Math.ceil(s*2/(h*.7)),f=Math.ceil(l*2/(h*.9));for(let p=0;p<d;p++)for(let m=0;m<f;m++){const y=p%2*h*.45,C=e-l+m*h*.9+y,v=a-s+p*h*.7,S=t.createRadialGradient(C-h*.15,v-h*.2,0,C,v,h*.5);S.addColorStop(0,"rgba(255,200,100,0.3)"),S.addColorStop(.3,"rgba(255,120,0,0.2)"),S.addColorStop(.7,"rgba(200,60,0,0.15)"),S.addColorStop(1,"rgba(100,20,0,0.25)"),t.beginPath();for(let b=0;b<5;b++){const I=b*2*Math.PI/5-Math.PI/2+p*.1,w=h*(.35+Math.sin(b*1.2)*.05),O=C+Math.cos(I)*w,R=v+Math.sin(I)*w;b===0?t.moveTo(O,R):t.lineTo(O,R)}t.closePath(),t.fillStyle=S,t.fill(),t.strokeStyle="rgba(255,80,20,0.4)",t.lineWidth=1.2,t.stroke();const T=t.createRadialGradient(C,v,0,C,v,2.5);T.addColorStop(0,"rgba(255,255,200,0.9)"),T.addColorStop(.5,"rgba(255,150,0,0.7)"),T.addColorStop(1,"rgba(200,50,0,0.3)"),t.beginPath(),t.arc(C,v,2,0,Math.PI*2),t.fillStyle=T,t.fill()}t.restore();const c=t.createLinearGradient(e,a-s*.4,e,a+s*.6);c.addColorStop(0,"rgba(255,100,0,0)"),c.addColorStop(.2,"rgba(255,180,50,0.15)"),c.addColorStop(.4,"rgba(255,120,0,0.25)"),c.addColorStop(.6,"rgba(255,180,50,0.2)"),c.addColorStop(.8,"rgba(255,100,0,0.1)"),c.addColorStop(1,"rgba(255,100,0,0)"),t.beginPath(),t.ellipse(e,a+s*.05,l*.8,s*.6,0,0,Math.PI*2),t.fillStyle=c,t.fill();const g=t.createRadialGradient(e-l*.2,a-s*.35,0,e,a-s*.2,l*.6);g.addColorStop(0,"rgba(255,255,255,0.4)"),g.addColorStop(.3,"rgba(255,200,100,0.25)"),g.addColorStop(.7,"rgba(255,150,50,0.15)"),g.addColorStop(1,"rgba(255,100,0,0.05)"),t.beginPath(),t.ellipse(e-l*.1,a-s*.3,l*.6,s*.25,-.1,0,Math.PI*2),t.fillStyle=g,t.fill();const u=t.createRadialGradient(e,a,s*.5,e,a,s*1.2);return u.addColorStop(0,"rgba(255,100,0,0)"),u.addColorStop(.6,"rgba(255,80,20,0.08)"),u.addColorStop(.8,"rgba(255,60,0,0.15)"),u.addColorStop(1,"rgba(200,40,0,0.08)"),t.beginPath(),t.ellipse(e,a,l*1.1,s*1.1,0,0,Math.PI*2),t.fillStyle=u,t.fill(),t.canvas}function ae(t,e){const a=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),l=Math.min(255,Math.round(a*e)),s=Math.min(255,Math.round(i*e)),n=Math.min(255,Math.round(o*e));return`rgb(${l},${s},${n})`}function rt(t,e,a=0){const i=Ne(t,e,a),o=i.getContext("2d"),l=i.width/2,s=i.height/2,n=e;if(a===0||a===1)o.beginPath(),o.arc(l,s,n*.82,0,Math.PI*2),o.strokeStyle="rgba(255,255,255,0.1)",o.lineWidth=Math.max(1.5,n*.12),o.stroke();else if(a===2){o.save(),o.beginPath(),o.arc(l,s,n,0,Math.PI*2),o.clip(),o.strokeStyle="rgba(255,255,255,0.15)",o.lineWidth=2,o.beginPath();const h=8;for(let d=0;d<=h;d++){const f=d/h*Math.PI*2,c=n*.7,g=n*.9,u=d%2===0?c:g,p=l+Math.cos(f)*u,m=s+Math.sin(f)*u;d===0?o.moveTo(p,m):o.lineTo(p,m)}o.closePath(),o.stroke(),o.restore()}else if(a===3)o.beginPath(),o.arc(l,s,n*.85,0,Math.PI*2),o.strokeStyle="rgba(255,215,0,0.4)",o.lineWidth=Math.max(2,n*.15),o.stroke(),o.beginPath(),o.arc(l,s,n*.7,0,Math.PI*2),o.strokeStyle="rgba(255,255,100,0.3)",o.lineWidth=Math.max(1,n*.08),o.stroke();else if(a>=4){o.save(),o.beginPath(),o.arc(l,s,n,0,Math.PI*2),o.clip(),o.strokeStyle="rgba(255,100,0,0.3)",o.lineWidth=2.5,o.beginPath();const h=12;for(let d=0;d<=h;d++){const f=d/h*Math.PI*2,c=n*.75,g=Math.sin(d*1.5)*n*.15,u=c+g,p=l+Math.cos(f)*u,m=s+Math.sin(f)*u;d===0?o.moveTo(p,m):o.lineTo(p,m)}o.closePath(),o.stroke(),o.strokeStyle="rgba(255,150,0,0.2)",o.lineWidth=1,o.beginPath(),o.arc(l,s,n*.6,0,Math.PI*2),o.stroke(),o.restore()}return i}function ne(t,e){const a=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),l=Math.round(a*e),s=Math.round(i*e),n=Math.round(o*e);return`rgb(${l},${s},${n})`}function dt(){const t=[0,1,2,3,4];for(let e=0;e<Z.length;e++){const a=Z[e];for(let i=0;i<se.length;i++){const o=se[i];for(const l of t){const s=l>0?`_e${l}`:"";Se.set(`${e}_${i}${s}`,Ne(a,o,l)),Se.set(`${e}_${i}_s${s}`,rt(a,o,l))}}}}function ht(t){const e=Math.round((t-4)/2);return Math.max(0,Math.min(se.length-1,e))}function ft(t,e,a,i=0){const o=ht(e),l=i>=1?`_e${Math.min(i,4)}`:"",s=a?`${t}_${o}_s${l}`:`${t}_${o}${l}`;return{sprite:Se.get(s),spriteRadius:se[o]}}function ct(t){let e=0;for(let a=G.length-1;a>=0;a--)if(t>=G[a].minScore){e=a;break}return e}function gt(t){const e=ct(t.score);if(e!==t.evolutionStage){const a=t.evolutionStage;return t.evolutionStage=e,{evolved:!0,from:a,to:e,stage:G[e]}}return{evolved:!1}}function ut(t){const e=G[t]||G[0];return{turnMod:e.turnMod,eatMod:e.eatMod}}class ze{constructor(e,a,i=0){this._factory=e,this._reset=a,this._pool=[];for(let o=0;o<i;o++)this._pool.push(this._factory())}acquire(...e){const a=this._pool.length>0?this._pool.pop():this._factory();return this._reset(a,...e),a}release(e){this._pool.push(e)}get poolSize(){return this._pool.length}}class mt{constructor(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.color="",this.size=3,this.life=0,this.decay=0}reset(e,a,i,o=3){return this.x=e,this.y=a,this.vx=A(-3,3),this.vy=A(-3,3),this.color=i,this.size=o,this.life=1,this.decay=A(.02,.05),this}update(e){return this.x+=this.vx*e*60,this.y+=this.vy*e*60,this.vx*=.96,this.vy*=.96,this.life-=this.decay*e*60,this.life>0}draw(e,a){const{W:i,H:o}=r,l=this.x-a.x+i/2,s=this.y-a.y+o/2;l<-10||l>i+10||s<-10||s>o+10||(e.beginPath(),e.arc(l,s,this.size*this.life,0,Math.PI*2),e.fillStyle=this.color,e.globalAlpha=this.life*.7,e.fill(),e.globalAlpha=1)}}const K=new ze(()=>new mt,(t,e,a,i,o)=>t.reset(e,a,i,o),200);class ue{constructor(e,a,i,o,l=!1,s=!1){this.segments=[],this.colorIdx=i,this.color=Z[i],this.name=o,this.isPlayer=l,this.isMinion=s,this.alive=!0,this.length=P.INITIAL_LENGTH,this.score=0,this.angle=Math.random()*Math.PI*2,this.targetAngle=this.angle,this.speed=P.BASE_SPEED,this.boosting=!1,this.shielded=!1,this.magnetized=!1,this.frozen=!1,this.frozenTimer=0,this.speedBoosted=!1,this.wobble=Math.random()*100,this.eyeBlink=0,this.minionOwner=null,this.minionTimer=0,this.kills=0,this.evolutionStage=0,this.isBoss=!1,this._flameTimer=0,this.aiTimer=0,this.aiTarget=null,this.aiState="wander";for(let n=0;n<this.length;n++)this.segments.push({x:e-n*P.SEGMENT_DIST*Math.cos(this.angle),y:a-n*P.SEGMENT_DIST*Math.sin(this.angle)})}get head(){return this.segments[0]}get radius(){const e=G[this.evolutionStage]||G[0];return(P.HEAD_RADIUS_BASE+Math.min(this.length*.12,20))*(e.headScale||1)}bodyRadius(e){const a=this.radius,i=e/this.segments.length;if(i<.08)return a*oe(.85,1,i/.08);if(i>.65){const l=(i-.65)/.35;return a*oe(.95,.25,l*l)}const o=Math.sin(this.wobble*10+e*.5)*.02;return a*(.95+o)}update(e){if(!this.alive)return;this.wobble+=e*3,this.eyeBlink=(this.eyeBlink+e)%4,this.frozenTimer>0&&(this.frozenTimer-=e*1e3,this.frozen=this.frozenTimer>0);const a=this.isPlayer?r.skillModifiers||{}:{},i=1+(a.speedMult||0),o=Math.max(.1,1+(a.boostDrainMult||0)),l=this.frozen?.4:this.speedBoosted?1.4:1,s=this.boosting?P.BOOST_SPEED:P.BASE_SPEED;if(this.speed=s*l*i,this.boosting&&this.length>8){const y=1+(this.length>100?(this.length-100)*.002:0);this.length-=P.BOOST_DRAIN*o*y*e,this.length<8&&(this.length=8,this.boosting=!1)}this.isPlayer&&a.regenPerSec&&(this.length+=a.regenPerSec*e);let n=this.targetAngle-this.angle;for(;n>Math.PI;)n-=Math.PI*2;for(;n<-Math.PI;)n+=Math.PI*2;const h=ut(this.evolutionStage),d=(this.isMinion?.15:.1)*h.turnMod;this.angle+=n*d;const f=this.speed*e*60,c=this.head.x+Math.cos(this.angle)*f,g=this.head.y+Math.sin(this.angle)*f,u=P.BORDER_MARGIN;this.head.x=Ae(c,u,P.WORLD_W-u),this.head.y=Ae(g,u,P.WORLD_H-u);for(let y=1;y<this.segments.length;y++){const C=this.segments[y-1],v=this.segments[y],S=z(v,C);_(v,C)>P.SEGMENT_DIST&&(v.x=C.x-Math.cos(S)*P.SEGMENT_DIST,v.y=C.y-Math.sin(S)*P.SEGMENT_DIST)}const p=Math.floor(this.length);for(;this.segments.length<p;){const y=this.segments[this.segments.length-1];this.segments.push({x:y.x,y:y.y})}for(;this.segments.length>p+5;)this.segments.pop();if((this.head.x<=u||this.head.x>=P.WORLD_W-u||this.head.y<=u||this.head.y>=P.WORLD_H-u)&&(this.targetAngle=z(this.head,{x:P.WORLD_W/2,y:P.WORLD_H/2})),this.isMinion&&(this.minionTimer-=e*1e3,this.minionTimer<=0&&(this.alive=!1)),(G[this.evolutionStage]||G[0]).trailParticles&&this.segments.length>5&&(this._flameTimer+=e,this._flameTimer>.1&&r.particles.length<200)){this._flameTimer=0;const y=this.segments[Math.min(4,this.segments.length-1)],C=["#ff4400","#ff6600","#ff8800","#ffaa00","#ffcc00"],v=C[Math.random()*C.length|0],S=K.acquire(y.x+(Math.random()-.5)*10,y.y+(Math.random()-.5)*10,v,3+Math.random()*4);r.particles.push(S)}}draw(e,a){if(!this.alive)return;const{W:i,H:o}=r,l=-a.x+i/2,s=-a.y+o/2,n=this.head.x+l,h=this.head.y+s;if(n<-250||n>i+250||h<-250||h>o+250)return;const d=G[this.evolutionStage]||G[0],f=this.evolutionStage,c=-l-20,g=-l+i+20,u=-s-20,p=-s+o+20;if(f>=2&&d.aura){const v=d.aura.color,S=f>=4?.25:f>=3?.18:.12,T=f>=4?6:f>=3?4:3;for(let b=this.segments.length-1;b>=0;b-=5){const I=this.segments[b];if(I.x<c||I.x>g||I.y<u||I.y>p)continue;const w=I.x+l,O=I.y+s,R=this.bodyRadius(b),E=Math.sin(this.wobble*2+b*.15)*.3+1;e.beginPath(),e.arc(w,O,R+T*E,0,Math.PI*2),e.fillStyle=`rgba(${v},${S*E})`,e.fill()}}if(this.isBoss)for(let v=this.segments.length-1;v>=0;v-=4){const S=this.segments[v];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const T=S.x+l,b=S.y+s,I=this.bodyRadius(v);e.beginPath(),e.arc(T,b,I+3,0,Math.PI*2),e.fillStyle=`rgba(255,50,50,${.15+Math.sin(this.wobble*2+v*.3)*.1})`,e.fill()}e.lineCap="round";for(let v=this.segments.length-1;v>=2;v-=2){const S=this.segments[v],T=this.segments[v-1];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const b=S.x+l,I=S.y+s,w=T.x+l,O=T.y+s,R=this.bodyRadius(v);e.beginPath(),e.moveTo(b,I),e.lineTo(w,O),e.strokeStyle=this.color.h,e.lineWidth=R*1.7,e.stroke()}const m=i/2,y=o/2,C=this.segments.length>50;for(let v=this.segments.length-1;v>=1;v--){const S=this.segments[v];if(S.x<c||S.x>g||S.y<u||S.y>p)continue;const T=S.x+l,b=S.y+s,I=this.bodyRadius(v);if(C&&Math.abs(T-m)+Math.abs(b-y)>Math.min(i,o)*.4){e.beginPath(),e.arc(T,b,I,0,Math.PI*2),e.fillStyle=this.color.h,e.fill();continue}const w=v%4===0,{sprite:O,spriteRadius:R}=ft(this.colorIdx,I,w,f);if(O){const E=I/R,L=O.width*E;e.drawImage(O,T-L/2,b-L/2,L,L)}}if(this.shielded){const v=this.head.x+l,S=this.head.y+s;e.beginPath(),e.arc(v,S,this.radius+12+Math.sin(this.wobble)*3,0,Math.PI*2),e.strokeStyle=`rgba(68, 221, 255, ${.4+Math.sin(this.wobble*2)*.2})`,e.lineWidth=3,e.stroke(),e.fillStyle="rgba(68, 221, 255, 0.08)",e.fill()}if(this.drawHead(e,l,s),this.segments.length>10&&this.drawTailEffect(e,l,s,f),!this.isMinion){const v=this.head.x+l,S=this.head.y+s-this.radius-16;if(e.font='bold 13px "Segoe UI", sans-serif',e.textAlign="center",this.isBoss){const T=`ðŸ’€ ${this.name}`,b=e.measureText(T).width,I=v-b/2-6,w=S-12,O=b+12,R=18,E=6;e.fillStyle="rgba(180,20,20,0.7)",e.beginPath(),e.moveTo(I+E,w),e.lineTo(I+O-E,w),e.arcTo(I+O,w,I+O,w+E,E),e.lineTo(I+O,w+R-E),e.arcTo(I+O,w+R,I+O-E,w+R,E),e.lineTo(I+E,w+R),e.arcTo(I,w+R,I,w+R-E,E),e.lineTo(I,w+E),e.arcTo(I,w,I+E,w,E),e.closePath(),e.fill(),e.fillStyle="#ff8888",e.fillText(T,v,S)}else e.fillStyle="rgba(0,0,0,0.4)",e.fillText(this.name,v,S+1),e.fillStyle="#fff",e.fillText(this.name,v,S)}}drawHead(e,a,i){const o=this.head.x+a,l=this.head.y+i,s=this.radius,n=G[this.evolutionStage]||G[0],h=this.evolutionStage;h===0?this.drawBabyWormHead(e,o,l,s,n):h===1?this.drawWormHead(e,o,l,s,n):h===2?this.drawSnakeHead(e,o,l,s,n):h===3?this.drawKingSnakeHead(e,o,l,s,n):h>=4&&this.drawDragonHead(e,o,l,s,n)}drawBabyWormHead(e,a,i,o,l){this.drawBodyConnector(e,a,i,o),this.drawAuraAndBossEffects(e,a,i,o,l),e.shadowColor="rgba(0,0,0,0.2)",e.shadowOffsetX=1,e.shadowOffsetY=2,e.shadowBlur=4;const s=e.createRadialGradient(a-o*.3,i-o*.3,0,a,i,o);s.addColorStop(0,"#ffffff"),s.addColorStop(.3,this.color.l),s.addColorStop(.7,this.color.h),s.addColorStop(1,this.color.b),e.beginPath(),e.arc(a,i,o,0,Math.PI*2),e.fillStyle=s,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.beginPath(),e.arc(a-o*.2,i-o*.2,o*.4,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.6)",e.fill();const n=o*.3,h=o*.35,d=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,a+Math.cos(this.angle-.5)*n,i+Math.sin(this.angle-.5)*n,h,d,"baby"),this.drawEye(e,a+Math.cos(this.angle+.5)*n,i+Math.sin(this.angle+.5)*n,h,d,"baby");const f=o*.6;e.fillStyle="rgba(255, 150, 170, 0.4)";for(const g of[this.angle-1.2,this.angle+1.2])e.beginPath(),e.arc(a+Math.cos(g)*f,i+Math.sin(g)*f,o*.25,0,Math.PI*2),e.fill();e.beginPath();const c=o*.4;e.arc(a+Math.cos(this.angle)*c,i+Math.sin(this.angle)*c,o*.2,this.angle+.2,this.angle+Math.PI-.2),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=2,e.lineCap="round",e.stroke()}drawWormHead(e,a,i,o,l){this.drawBodyConnector(e,a,i,o),this.drawAuraAndBossEffects(e,a,i,o,l),e.shadowColor="rgba(0,0,0,0.25)",e.shadowOffsetX=1,e.shadowOffsetY=2,e.shadowBlur=4;const s=e.createRadialGradient(a-o*.3,i-o*.3,0,a,i,o);s.addColorStop(0,this.color.l),s.addColorStop(.4,this.color.h),s.addColorStop(.8,this.color.b),s.addColorStop(1,this.darkenColor(this.color.b,.7)),e.beginPath(),e.ellipse(a,i,o*1.1,o*.9,this.angle,0,Math.PI*2),e.fillStyle=s,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.beginPath(),e.ellipse(a-o*.15,i-o*.25,o*.5,o*.3,this.angle-.3,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.3)",e.fill();const n=o*.35,h=o*.3,d=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,a+Math.cos(this.angle-.4)*n,i+Math.sin(this.angle-.4)*n,h,d,"alert"),this.drawEye(e,a+Math.cos(this.angle+.4)*n,i+Math.sin(this.angle+.4)*n,h,d,"alert"),this.drawMouthAndTongue(e,a,i,o,!1)}drawSnakeHead(e,a,i,o,l){this.drawBodyConnector(e,a,i,o),this.drawAuraAndBossEffects(e,a,i,o,l),e.save(),e.translate(a,i),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.4)",e.shadowOffsetX=2.5,e.shadowOffsetY=4,e.shadowBlur=8;const s=o*1.6,n=o*1.1,h=o*.85,d=e.createRadialGradient(-s*.2,-n*.15,0,0,0,s*.8);d.addColorStop(0,this.lightenColor(this.color.h,1.5)),d.addColorStop(.2,this.lightenColor(this.color.h,1.2)),d.addColorStop(.45,this.color.h),d.addColorStop(.75,this.color.b),d.addColorStop(1,this.darkenColor(this.color.b,.7)),e.beginPath(),e.moveTo(s*.65,0),e.bezierCurveTo(s*.4,-n*.25,s*.1,-n*.45,-s*.1,-n*.4),e.bezierCurveTo(-s*.3,-h*.35,-s*.5,-h*.15,-s*.6,0),e.bezierCurveTo(-s*.5,h*.15,-s*.3,h*.35,-s*.1,n*.4),e.bezierCurveTo(s*.1,n*.45,s*.4,n*.25,s*.65,0),e.closePath(),e.fillStyle=d,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip();const f=4,c=6;for(let T=0;T<f;T++)for(let b=0;b<c;b++){const I=T/(f-1),w=-s*.4+I*s*.8,O=n*(.3+.4*Math.sin(I*Math.PI)),R=-O+b/(c-1)*O*2,E=o*(.15+I*.1),L=e.createRadialGradient(w-E*.2,R-E*.2,0,w,R,E);L.addColorStop(0,"rgba(255,255,255,0.2)"),L.addColorStop(.5,"rgba(255,255,255,0.08)"),L.addColorStop(1,"rgba(0,0,0,0.15)"),e.beginPath(),e.ellipse(w,R,E*.8,E*.5,Math.PI*(.1+I*.1),0,Math.PI*2),e.fillStyle=L,e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.3,e.stroke()}e.restore(),e.beginPath(),e.ellipse(-s*.1,-n*.2,s*.4,n*.15,-.1,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.25)",e.fill(),e.restore();const g=o*.35,u=o*.22,p=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1,m=o*.1,y=a+Math.cos(this.angle-.35)*g-Math.cos(this.angle)*m,C=i+Math.sin(this.angle-.35)*g-Math.sin(this.angle)*m,v=a+Math.cos(this.angle+.35)*g-Math.cos(this.angle)*m,S=i+Math.sin(this.angle+.35)*g-Math.sin(this.angle)*m;this.drawEye(e,y,C,u,p,"fierce"),this.drawEye(e,v,S,u,p,"fierce"),this.drawSnakeTongue(e,a,i,o),this.drawNostrils(e,a,i,o)}drawKingSnakeHead(e,a,i,o,l){this.drawBodyConnector(e,a,i,o),this.drawAuraAndBossEffects(e,a,i,o,l),e.save(),e.translate(a,i),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.4)",e.shadowOffsetX=2,e.shadowOffsetY=4,e.shadowBlur=6;const s=o*1.5,n=o*1.3,h=e.createRadialGradient(-s*.3,-n*.2,0,0,0,s);h.addColorStop(0,"#ffe066"),h.addColorStop(.3,this.color.h),h.addColorStop(.7,this.color.b),h.addColorStop(1,this.darkenColor(this.color.b,.5)),e.beginPath(),e.moveTo(s*.6,0),e.quadraticCurveTo(s*.2,-n*.55,-s*.3,-n*.45),e.quadraticCurveTo(-s*.7,0,-s*.3,n*.45),e.quadraticCurveTo(s*.2,n*.55,s*.6,0),e.closePath(),e.fillStyle=h,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip(),e.strokeStyle="rgba(180,140,0,0.4)",e.fillStyle="rgba(255,215,0,0.2)",e.lineWidth=1;for(let g=0;g<4;g++){const u=-s*.3+g*s*.15,p=g%2*n*.2-n*.1;e.beginPath();for(let m=0;m<6;m++){const y=m*Math.PI/3,C=u+Math.cos(y)*s*.08,v=p+Math.sin(y)*n*.08;m===0?e.moveTo(C,v):e.lineTo(C,v)}e.closePath(),e.fill(),e.stroke()}e.restore(),e.restore(),this.drawCrown(e,a,i,o);const d=o*.45,f=o*.28,c=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1;this.drawEye(e,a+Math.cos(this.angle-.25)*d,i+Math.sin(this.angle-.25)*d,f,c,"regal"),this.drawEye(e,a+Math.cos(this.angle+.25)*d,i+Math.sin(this.angle+.25)*d,f,c,"regal"),this.drawSnakeTongue(e,a,i,o),this.drawNostrils(e,a,i,o)}drawDragonHead(e,a,i,o,l){this.drawBodyConnector(e,a,i,o),this.drawAuraAndBossEffects(e,a,i,o,l),this.drawDragonWings(e,a,i,o),e.save(),e.translate(a,i),e.rotate(this.angle),e.shadowColor="rgba(0,0,0,0.7)",e.shadowOffsetX=4,e.shadowOffsetY=6,e.shadowBlur=12;const s=o*2,n=o*1.3,h=o*1.1,d=o*.9,f=e.createRadialGradient(-s*.15,-n*.25,0,0,0,s*.9);f.addColorStop(0,this.lightenColor(this.color.h,2)),f.addColorStop(.1,this.lightenColor(this.color.h,1.6)),f.addColorStop(.25,this.lightenColor(this.color.h,1.3)),f.addColorStop(.4,this.color.h),f.addColorStop(.55,this.color.b),f.addColorStop(.7,this.darkenColor(this.color.b,.8)),f.addColorStop(.85,"#3d2517"),f.addColorStop(1,"#1a0d06"),e.beginPath(),e.moveTo(s*.75,0),e.bezierCurveTo(s*.6,-n*.15,s*.4,-n*.35,s*.1,-n*.45),e.bezierCurveTo(-s*.1,-n*.5,-s*.3,-n*.35,-s*.5,-n*.2),e.bezierCurveTo(-s*.7,-d*.15,-s*.8,-d*.05,-s*.85,0),e.bezierCurveTo(-s*.8,d*.05,-s*.7,d*.15,-s*.5,n*.25),e.bezierCurveTo(-s*.3,h*.4,-s*.1,h*.5,s*.15,h*.45),e.bezierCurveTo(s*.4,h*.35,s*.6,h*.15,s*.75,0),e.closePath(),e.fillStyle=f,e.fill(),e.shadowColor="transparent",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.save(),e.clip();const c=6,g=8;for(let I=0;I<c;I++)for(let w=0;w<g;w++){const O=I/(c-1),R=(w-g/2)/(g/2),E=-s*.6+O*s*.9,L=n*(.2+.6*Math.sin(O*Math.PI*.8)),W=R*L*.8,N=o*(.12+O*.08),M=e.createRadialGradient(E-N*.3,W-N*.3,0,E,W,N*.8);M.addColorStop(0,"rgba(255,240,200,0.4)"),M.addColorStop(.3,"rgba(255,150,50,0.25)"),M.addColorStop(.7,"rgba(200,80,20,0.2)"),M.addColorStop(1,"rgba(100,30,10,0.3)"),e.beginPath();for(let k=0;k<5;k++){const H=k*2*Math.PI/5-Math.PI/2+I*.15,le=N*(.6+Math.sin(k*1.5)*.1),re=E+Math.cos(H)*le,de=W+Math.sin(H)*le;k===0?e.moveTo(re,de):e.lineTo(re,de)}e.closePath(),e.fillStyle=M,e.fill(),e.strokeStyle="rgba(255,100,30,0.5)",e.lineWidth=.8,e.stroke(),e.beginPath(),e.arc(E,W,1.5,0,Math.PI*2),e.fillStyle=`rgba(255,${150+Math.sin(this.wobble*5+I+w)*50},0,0.9)`,e.fill()}e.restore();const u=e.createRadialGradient(-s*.1,-n*.3,0,s*.1,-n*.2,s*.4);u.addColorStop(0,"rgba(255,255,255,0.5)"),u.addColorStop(.3,"rgba(255,220,150,0.3)"),u.addColorStop(.7,"rgba(255,150,50,0.2)"),u.addColorStop(1,"rgba(255,100,0,0.1)"),e.beginPath(),e.ellipse(0,-n*.25,s*.35,n*.2,-.05,0,Math.PI*2),e.fillStyle=u,e.fill(),e.restore(),this.drawDragonHorns(e,a,i,o),this.drawDragonWhiskers(e,a,i,o);const p=o*.45,m=o*.28,y=this.eyeBlink>3.85?Math.max(.1,1-(this.eyeBlink-3.85)/.15*.9):1,C=o*.15,v=a+Math.cos(this.angle-.25)*p-Math.cos(this.angle)*C,S=i+Math.sin(this.angle-.25)*p-Math.sin(this.angle)*C,T=a+Math.cos(this.angle+.25)*p-Math.cos(this.angle)*C,b=i+Math.sin(this.angle+.25)*p-Math.sin(this.angle)*C;this.drawEye(e,v,S,m,y,"dragon"),this.drawEye(e,T,b,m,y,"dragon"),this.boosting&&this.drawDragonFire(e,a,i,o),this.drawDragonNostrils(e,a,i,o)}drawBodyConnector(e,a,i,o){if(this.segments.length>1){const l=this.segments[1],{W:s,H:n}=r,h=-r.camera.x+s/2,d=-r.camera.y+n/2,f=l.x+h,c=l.y+d;e.beginPath(),e.moveTo(a,i),e.lineTo(f,c),e.strokeStyle=this.color.h,e.lineWidth=o*1.5,e.lineCap="round",e.stroke()}}drawAuraAndBossEffects(e,a,i,o,l){if(l.aura){const s=l.aura,n=Math.sin(this.wobble*s.pulse)*.2+1,h=o*s.radius*n,d=e.createRadialGradient(a,i,o*.2,a,i,h);d.addColorStop(0,`rgba(${s.color},${s.alpha})`),d.addColorStop(.5,`rgba(${s.color},${s.alpha*.5})`),d.addColorStop(1,`rgba(${s.color},0)`),e.beginPath(),e.arc(a,i,h,0,Math.PI*2),e.fillStyle=d,e.fill()}if(this.isBoss){const s=o+12+Math.sin(this.wobble*2)*5,n=e.createRadialGradient(a,i,o*.3,a,i,s);n.addColorStop(0,"rgba(255,40,40,0.25)"),n.addColorStop(.5,"rgba(255,40,40,0.12)"),n.addColorStop(1,"rgba(255,40,40,0)"),e.beginPath(),e.arc(a,i,s,0,Math.PI*2),e.fillStyle=n,e.fill(),e.beginPath(),e.arc(a,i,o+8+Math.sin(this.wobble*3)*4,0,Math.PI*2),e.strokeStyle=`rgba(255,60,60,${.4+Math.sin(this.wobble*3)*.2})`,e.lineWidth=2.5,e.stroke()}}drawMouthAndTongue(e,a,i,o,l=!1){const s=o*.55,n=a+Math.cos(this.angle)*s,h=i+Math.sin(this.angle)*s,d=this.boosting?.6:.35;if(e.beginPath(),e.arc(n,h,o*d,this.angle+Math.PI*.6,this.angle+Math.PI*1.4),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=Math.max(1,o*.07),e.lineCap="round",e.stroke(),this.boosting||l){const f=o*.65,c=o*.8,g=a+Math.cos(this.angle)*f,u=i+Math.sin(this.angle)*f,p=Math.sin(this.wobble*15)*.2,m=this.angle+Math.PI/2;e.strokeStyle="#cc2222",e.lineWidth=Math.max(1,o*.06),e.lineCap="round",e.beginPath(),e.moveTo(g,u);const y=g+Math.cos(this.angle+p-.15)*c,C=u+Math.sin(this.angle+p-.15)*c,v=g+Math.cos(this.angle)*c*.5+Math.cos(m)*o*.05,S=u+Math.sin(this.angle)*c*.5+Math.sin(m)*o*.05;e.quadraticCurveTo(v,S,y,C),e.stroke(),e.beginPath(),e.moveTo(g,u);const T=g+Math.cos(this.angle+p+.15)*c,b=u+Math.sin(this.angle+p+.15)*c,I=g+Math.cos(this.angle)*c*.5-Math.cos(m)*o*.05,w=u+Math.sin(this.angle)*c*.5-Math.sin(m)*o*.05;e.quadraticCurveTo(I,w,T,b),e.stroke()}}drawSnakeTongue(e,a,i,o){const l=o*.9,s=o*1.4,n=a+Math.cos(this.angle)*l,h=i+Math.sin(this.angle)*l,d=Math.sin(this.wobble*25+Math.sin(this.wobble*8))*.4,f=this.angle+Math.PI/2;e.strokeStyle="#cc1818",e.lineWidth=Math.max(2,o*.1),e.lineCap="round",e.beginPath(),e.moveTo(a+Math.cos(this.angle)*o*.6,i+Math.sin(this.angle)*o*.6),e.lineTo(n,h),e.stroke(),e.lineWidth=Math.max(1.2,o*.06);for(const c of[-.3,.3]){const g=d+c*.5,u=n+Math.cos(this.angle+g)*s,p=h+Math.sin(this.angle+g)*s,m=n+Math.cos(this.angle)*s*.6,y=h+Math.sin(this.angle)*s*.6,C=Math.cos(f)*o*c*.4,v=Math.sin(f)*o*c*.4,S=e.createLinearGradient(n,h,u,p);S.addColorStop(0,"#ee2222"),S.addColorStop(.7,"#cc1818"),S.addColorStop(1,"#aa1111"),e.strokeStyle=S,e.beginPath(),e.moveTo(n,h),e.quadraticCurveTo(m+C,y+v,u,p),e.stroke(),e.beginPath(),e.arc(u,p,1,0,Math.PI*2),e.fillStyle="#ff3333",e.fill()}}drawNostrils(e,a,i,o){const l=o*.45,s=.25,n=Math.max(.8,o*.05);e.fillStyle="rgba(0,0,0,0.4)";for(const h of[-s,s]){const d=a+Math.cos(this.angle+h)*l,f=i+Math.sin(this.angle+h)*l;e.beginPath(),e.arc(d,f,n,0,Math.PI*2),e.fill()}}drawCrown(e,a,i,o){e.save(),e.translate(a,i),e.rotate(this.angle-Math.PI/2);const l=e.createLinearGradient(0,-o*.3,0,-o*1.2);l.addColorStop(0,"#bb8800"),l.addColorStop(.4,"#ffdd44"),l.addColorStop(1,"#ffee88"),e.fillStyle=l,e.beginPath(),e.moveTo(-o*.5,-o*.3),e.lineTo(-o*.4,-o*1.1),e.lineTo(-o*.15,-o*.7),e.lineTo(0,-o*1.2),e.lineTo(o*.15,-o*.7),e.lineTo(o*.4,-o*1.1),e.lineTo(o*.5,-o*.3),e.closePath(),e.fill(),e.strokeStyle="#996600",e.lineWidth=1.5,e.stroke(),e.fillStyle="#ddaa00",e.fillRect(-o*.5,-o*.4,o*1,o*.12),e.strokeRect(-o*.5,-o*.4,o*1,o*.12);const s=[[-o*.4,-o*1],[0,-o*1.15],[o*.4,-o*1]];for(const[n,h]of s)e.beginPath(),e.arc(n,h,o*.08,0,Math.PI*2),e.fillStyle="#ff2233",e.fill(),e.strokeStyle="#cc0022",e.lineWidth=.8,e.stroke(),e.beginPath(),e.arc(n-o*.02,h-o*.02,o*.03,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill();e.restore()}drawDragonWings(e,a,i,o){const l=Math.sin(this.wobble*3)*.5,s=this.boosting?2:1;for(const n of[-1,1]){e.save(),e.translate(a,i),e.rotate(this.angle-Math.PI/2),e.scale(n,1),e.rotate(l*n*s);const h=o*3.5,d=o*2.8,f=e.createLinearGradient(0,0,-h,0);f.addColorStop(0,this.lightenColor(this.color.h,1.2)),f.addColorStop(.2,this.color.h),f.addColorStop(.4,this.color.l),f.addColorStop(.6,this.color.b),f.addColorStop(.8,this.darkenColor(this.color.b,.7)),f.addColorStop(1,"#2d1810"),e.globalAlpha=.85,e.fillStyle=f,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.8,-d*.9,-h*.7,-d*.6,-h,-o*.3),e.bezierCurveTo(-h*.9,o*.1,-h*.8,o*.5,-h*.6,d*.5),e.bezierCurveTo(-h*.5,d*.7,-o*1.5,d*.8,-o*.8,d*.6),e.bezierCurveTo(-o*.4,d*.4,-o*.2,o*.3,o*.15,o*.2),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=2.5;const c=[[o*.1,-o*.1,-h*.7,-d*.5],[o*.1,0,-h*.9,-o*.1],[o*.1,0,-h*.8,o*.3],[o*.1,o*.1,-h*.6,d*.4],[o*.1,o*.1,-o*.8,d*.55]];for(const[u,p,m,y]of c)e.beginPath(),e.moveTo(u,p),e.lineTo(m,y),e.stroke();e.strokeStyle="rgba(0,0,0,0.25)",e.lineWidth=1.5;const g=[[-o*.5,-d*.4,-h*.5,-d*.3],[-o*.8,-o*.05,-h*.7,o*.1],[-o*.7,d*.25,-h*.4,d*.35]];for(const[u,p,m,y]of g)e.beginPath(),e.moveTo(u,p),e.lineTo(m,y),e.stroke();e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.6,-d*.7,-h*.5,-d*.4,-h*.8,-o*.2),e.stroke(),this.boosting&&(e.strokeStyle="rgba(255,120,0,0.6)",e.lineWidth=3,e.shadowColor="rgba(255,100,0,0.8)",e.shadowBlur=8,e.beginPath(),e.moveTo(o*.15,-o*.2),e.bezierCurveTo(-o*.8,-d*.9,-h*.7,-d*.6,-h,-o*.3),e.stroke(),e.shadowBlur=0),e.globalAlpha=1,e.restore()}}drawDragonHorns(e,a,i,o){for(const l of[-1,1]){e.save(),e.translate(a,i),e.rotate(this.angle-Math.PI/2),e.scale(l,1);const s=e.createLinearGradient(0,-o*.3,0,-o*1.8);s.addColorStop(0,this.color.b),s.addColorStop(.5,this.color.l),s.addColorStop(1,"#ffffff"),e.fillStyle=s,e.beginPath(),e.moveTo(o*.2,-o*.3),e.quadraticCurveTo(o*.8,-o*1.6,o*.3,-o*1.7),e.quadraticCurveTo(o*.1,-o*1.2,o*.05,-o*.4),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.6)",e.lineWidth=1.5,e.beginPath(),e.moveTo(o*.15,-o*.4),e.quadraticCurveTo(o*.6,-o*1.4,o*.28,-o*1.6),e.stroke(),e.restore()}}drawDragonWhiskers(e,a,i,o){const l=o*1.5,s=Math.sin(this.wobble*3)*.3;for(const n of[-1,1]){e.strokeStyle=this.lightenColor(this.color.h,1.2),e.lineWidth=Math.max(2,o*.08),e.lineCap="round",e.beginPath();const h=a+Math.cos(this.angle+n*1.2)*o*.6,d=i+Math.sin(this.angle+n*1.2)*o*.6,f=h+Math.cos(this.angle+n*.3+s)*l,c=d+Math.sin(this.angle+n*.3+s)*l;e.moveTo(h,d),e.quadraticCurveTo(h+Math.cos(this.angle)*l*.3,d+Math.sin(this.angle)*l*.3,f,c),e.stroke()}}drawDragonFire(e,a,i,o){const l=o*2.5,s=a+Math.cos(this.angle)*o*.9,n=i+Math.sin(this.angle)*o*.9,h=.8,d=e.createRadialGradient(s,n,0,s,n,o*.8);d.addColorStop(0,"rgba(255,255,255,0.9)"),d.addColorStop(.3,"rgba(255,200,100,0.8)"),d.addColorStop(.7,"rgba(255,100,0,0.6)"),d.addColorStop(1,"rgba(200,50,0,0.3)"),e.beginPath(),e.arc(s,n,o*.6,0,Math.PI*2),e.fillStyle=d,e.fill(),[{count:8,sizeMin:4,sizeMax:8,colors:["#ffffff","#fff8dc","#fffacd"]},{count:12,sizeMin:3,sizeMax:6,colors:["#ffd700","#ffa500","#ff8c00"]},{count:15,sizeMin:2,sizeMax:5,colors:["#ff4500","#ff0000","#dc143c"]}].forEach((g,u)=>{for(let p=0;p<g.count;p++){p/g.count;const m=this.angle+(Math.random()-.5)*h*(1+u*.3),y=l*(.3+Math.random()*.7)*(1+u*.2),C=s+Math.cos(m)*y,v=n+Math.sin(m)*y,S=g.sizeMin+Math.random()*(g.sizeMax-g.sizeMin),T=g.colors[Math.floor(Math.random()*g.colors.length)],b=e.createRadialGradient(C,v,0,C,v,S);b.addColorStop(0,T),b.addColorStop(1,T+"00"),e.beginPath(),e.arc(C,v,S,0,Math.PI*2),e.fillStyle=b,e.globalAlpha=(.6+Math.random()*.4)*(1-u*.2),e.fill()}});for(let g=0;g<6;g++){const u=this.angle+(Math.random()-.5)*h*1.5,p=l*(.8+Math.random()*.4),m=s+Math.cos(u)*p,y=n+Math.sin(u)*p;e.beginPath(),e.arc(m,y,1+Math.random()*2,0,Math.PI*2),e.fillStyle="#ffff00",e.globalAlpha=.8+Math.random()*.2,e.fill()}const c=e.createLinearGradient(s,n,s+Math.cos(this.angle)*l,n+Math.sin(this.angle)*l);c.addColorStop(0,"rgba(255,255,255,0.4)"),c.addColorStop(.3,"rgba(255,150,0,0.3)"),c.addColorStop(.7,"rgba(255,50,0,0.2)"),c.addColorStop(1,"rgba(100,0,0,0.1)"),e.beginPath(),e.ellipse(s+Math.cos(this.angle)*l*.4,n+Math.sin(this.angle)*l*.4,l*.6,o*.3,this.angle,0,Math.PI*2),e.fillStyle=c,e.globalAlpha=.5,e.fill(),e.globalAlpha=1}lightenColor(e,a){const i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16),s=Math.min(255,Math.round(i*a)),n=Math.min(255,Math.round(o*a)),h=Math.min(255,Math.round(l*a));return`rgb(${s},${n},${h})`}darkenColor(e,a){const i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16),s=Math.round(i*a),n=Math.round(o*a),h=Math.round(l*a);return`rgb(${s},${n},${h})`}drawTailEffect(e,a,i,o){o>=4?this.drawDragonTail(e,a,i):o>=2&&this.drawSnakeTail(e,a,i)}drawDragonTail(e,a,i){if(this.segments.length<5)return;const o=this.segments[this.segments.length-1],l=o.x+a,s=o.y+i,n=this.bodyRadius(this.segments.length-1),h=this.segments[this.segments.length-2],d=Math.atan2(o.y-h.y,o.x-h.x);e.save(),e.translate(l,s),e.rotate(d);const f=n*1.5,c=n*.8,g=e.createLinearGradient(0,0,f,0);g.addColorStop(0,this.color.h),g.addColorStop(.3,"#ff6600"),g.addColorStop(.7,"#ff4400"),g.addColorStop(1,"#ff2200"),e.beginPath(),e.moveTo(0,0),e.lineTo(f,-c*.3),e.lineTo(f*.8,0),e.lineTo(f,c*.3),e.closePath(),e.fillStyle=g,e.fill();const u=3+Math.floor(Math.random()*3);for(let p=0;p<u;p++){const m=f*(.7+Math.random()*.4),y=(Math.random()-.5)*c*.6,C=2+Math.random()*3;e.beginPath(),e.arc(m,y,C,0,Math.PI*2),e.fillStyle=["#ff8800","#ffaa00","#ffcc00"][Math.floor(Math.random()*3)],e.globalAlpha=.8,e.fill()}e.globalAlpha=1,e.restore()}drawSnakeTail(e,a,i){if(this.segments.length<5)return;const o=this.segments[this.segments.length-1],l=o.x+a,s=o.y+i,n=this.bodyRadius(this.segments.length-1),h=this.segments[this.segments.length-2],d=Math.atan2(o.y-h.y,o.x-h.x);e.save(),e.translate(l,s),e.rotate(d);const f=n*.8,c=n*.3,g=e.createLinearGradient(0,0,f,0);g.addColorStop(0,this.color.h),g.addColorStop(.6,this.color.b),g.addColorStop(1,this.darkenColor(this.color.b,.5)),e.beginPath(),e.moveTo(0,0),e.lineTo(f,0),e.lineTo(f*.7,-c),e.lineTo(0,-c*.5),e.lineTo(f*.7,c),e.lineTo(0,c*.5),e.closePath(),e.fillStyle=g,e.fill(),e.strokeStyle="rgba(255,255,255,0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(f*.3,0),e.lineTo(f,0),e.stroke(),e.restore()}drawEye(e,a,i,o,l,s="baby"){e.save(),e.translate(a,i),e.scale(1,l),e.beginPath(),e.arc(0,0,o,0,Math.PI*2),e.fillStyle="#fff",e.fill(),e.strokeStyle="rgba(0,0,0,0.1)",e.lineWidth=.5,e.stroke();const n=Math.cos(this.angle)*o*.15,h=Math.sin(this.angle)*o*.15;if(s==="baby"){const d=o*.6;e.beginPath(),e.arc(n,h,d,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(n-d*.3,-d*.3,d*.4,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.85)",e.fill(),e.beginPath(),e.arc(n+d*.2,d*.2,d*.15,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.5)",e.fill()}else if(s==="alert"){const d=o*.5;e.beginPath(),e.arc(n,h,d,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(n-d*.3,-d*.3,d*.38,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.9)",e.fill()}else if(s==="fierce"){const d=o*.6;e.beginPath(),e.arc(n,h,d,0,Math.PI*2),e.fillStyle="#cc3322",e.fill();const f=o*.35;e.beginPath(),e.arc(n,h,f,0,Math.PI*2),e.fillStyle="#1a0a0a",e.fill(),e.beginPath(),e.arc(n-f*.4,-f*.4,f*.25,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.6)",e.fill()}else if(s==="regal"){const d=o*.6;e.beginPath(),e.arc(n,h,d,0,Math.PI*2),e.fillStyle="#ccaa22",e.fill(),e.beginPath(),e.arc(n,h,d*.7,0,Math.PI*2),e.fillStyle="#4422aa",e.fill();const f=o*.25;e.beginPath(),e.arc(n,h,f,0,Math.PI*2),e.fillStyle="#0a0020",e.fill(),e.beginPath(),e.arc(n-f*.5,-f*.5,f*.35,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill()}else if(s==="dragon"){const d=o*.65,f=e.createRadialGradient(n,h,0,n,h,d);f.addColorStop(0,"#ffaa00"),f.addColorStop(.6,"#dd4400"),f.addColorStop(1,"#881100"),e.beginPath(),e.arc(n,h,d,0,Math.PI*2),e.fillStyle=f,e.fill(),e.beginPath(),e.ellipse(n,h,o*.1,o*.5,0,0,Math.PI*2),e.fillStyle="#0a0000",e.fill(),e.beginPath(),e.arc(0,0,o+2,0,Math.PI*2),e.strokeStyle=`rgba(255,100,0,${.3+Math.sin(this.wobble*3)*.15})`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(n-o*.15,-o*.18,o*.12,0,Math.PI*2),e.fillStyle="rgba(255,220,150,0.7)",e.fill()}e.restore()}drawDragonNostrils(e,a,i,o){const l=o*.6,s=.4,n=Math.max(2,o*.08);e.fillStyle="rgba(0,0,0,0.6)";for(const h of[-s,s]){const d=a+Math.cos(this.angle+h)*l,f=i+Math.sin(this.angle+h)*l;if(e.save(),e.translate(d,f),e.rotate(this.angle),e.beginPath(),e.ellipse(0,0,n*1.5,n*.8,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(-n*.3,-n*.2,n*.4,n*.2,0,0,Math.PI*2),e.fillStyle="rgba(255,100,50,0.3)",e.fill(),Math.random()<.3){const c=this.boosting?3:1;for(let g=0;g<c;g++){const u=n*(1+Math.random()*2),p=(Math.random()-.5)*n*.5,m=1+Math.random()*2;e.beginPath(),e.arc(u,p,m,0,Math.PI*2),e.fillStyle=this.boosting?`rgba(255,${100+Math.random()*100},0,${.4+Math.random()*.4})`:`rgba(150,150,150,${.2+Math.random()*.3})`,e.fill()}}e.restore()}}}class pt{constructor(){this.x=0,this.y=0,this.radius=5,this.color="",this.glow="",this.phase=0,this.alive=!1,this.tier=V[0]}reset(e,a,i){if(this.tier=i||ot(),this.x=e??A(100,P.WORLD_W-100),this.y=a??A(100,P.WORLD_H-100),this.radius=A(this.tier.radiusMin,this.tier.radiusMax),this.phase=Math.random()*Math.PI*2,this.alive=!0,this.tier.golden)this.color="hsl(45, 90%, 65%)",this.glow="hsl(45, 95%, 75%)";else{const o=A(0,360);this.color=`hsl(${o}, 80%, 65%)`,this.glow=`hsl(${o}, 80%, 75%)`}return this}draw(e,a){const{W:i,H:o,frameCount:l}=r,s=this.x-a.x+i/2,n=this.y-a.y+o/2;if(s<-20||s>i+20||n<-20||n>o+20)return;const h=1+Math.sin(this.phase+l*.04)*.15,d=this.radius*h,f=this.tier.id==="large",c=this.tier.golden;if(c){const m=1+Math.sin(l*.06+this.phase)*.3,y=1+Math.sin(l*.08+this.phase+1)*.25;e.beginPath(),e.arc(s,n,d+6*m,0,Math.PI*2),e.strokeStyle=`rgba(255,215,0,${.25+Math.sin(l*.05)*.12})`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(s,n,d+2*y,0,Math.PI*2),e.strokeStyle=`rgba(255,255,100,${.4+Math.sin(l*.07)*.2})`,e.lineWidth=1,e.stroke()}const g=c?8:f?6:4,u=c?.25:f?.2:.15;e.beginPath(),e.arc(s,n,d+g,0,Math.PI*2),e.fillStyle=this.glow,e.globalAlpha=u,e.fill(),e.globalAlpha=1;const p=e.createRadialGradient(s-d*.3,n-d*.3,0,s,n,d);if(p.addColorStop(0,"#fff"),p.addColorStop(.4,this.color),p.addColorStop(1,this.glow),e.beginPath(),e.arc(s,n,d,0,Math.PI*2),e.fillStyle=p,e.fill(),f||c){const m=l*.03+this.phase,y=d*.35,C=s+Math.cos(m)*y,v=n+Math.sin(m)*y,S=d*.2;e.beginPath(),e.arc(C,v,S,0,Math.PI*2),e.fillStyle=`rgba(255,255,255,${.5+Math.sin(l*.08)*.3})`,e.fill()}}}const me=new ze(()=>new pt,(t,e,a,i)=>t.reset(e,a,i),P.FOOD_COUNT);class He{constructor(){const e=ke();this.x=e.x,this.y=e.y,this.type=Oe[Q(0,Oe.length-1)],this.alive=!0,this.phase=Math.random()*Math.PI*2,this.spawnTime=Date.now()}draw(e,a){const{W:i,H:o,frameCount:l}=r,s=this.x-a.x+i/2,n=this.y-a.y+o/2;if(s<-40||s>i+40||n<-40||n>o+40)return;const h=Math.sin(this.phase+l*.03)*4,d=1+Math.sin(this.phase+l*.05)*.1,f=P.ITEM_RADIUS*d,c=.15+Math.sin(l*.04+this.phase)*.08;e.beginPath(),e.arc(s,n+h,f+12*d,0,Math.PI*2),e.fillStyle=this.type.color,e.globalAlpha=c*.6,e.fill(),e.beginPath(),e.arc(s,n+h,f+6*d,0,Math.PI*2),e.fillStyle=this.type.color,e.globalAlpha=c,e.fill(),e.globalAlpha=1,e.beginPath(),e.arc(s,n+h,f,0,Math.PI*2);const g=e.createRadialGradient(s,n+h-3,0,s,n+h,f);g.addColorStop(0,"#fff"),g.addColorStop(.5,this.type.color),g.addColorStop(1,this.type.color),e.fillStyle=g,e.fill(),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=1.5,e.stroke(),e.font=`${f*1.2}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.type.icon,s,n+h+1)}}class Xe{constructor(e){this.cellSize=e,this.cells=new Map}_key(e,a){return e*73856093^a*19349663}clear(){this.cells.clear()}insert(e,a,i){const o=Math.floor(a/this.cellSize),l=Math.floor(i/this.cellSize),s=this._key(o,l);let n=this.cells.get(s);n||(n=[],this.cells.set(s,n)),n.push(e)}insertCircle(e,a,i,o){const l=Math.floor((a-o)/this.cellSize),s=Math.floor((a+o)/this.cellSize),n=Math.floor((i-o)/this.cellSize),h=Math.floor((i+o)/this.cellSize);for(let d=l;d<=s;d++)for(let f=n;f<=h;f++){const c=this._key(d,f);let g=this.cells.get(c);g||(g=[],this.cells.set(c,g)),g.push(e)}}query(e,a,i){const o=[],l=Math.floor((e-i)/this.cellSize),s=Math.floor((e+i)/this.cellSize),n=Math.floor((a-i)/this.cellSize),h=Math.floor((a+i)/this.cellSize);for(let d=l;d<=s;d++)for(let f=n;f<=h;f++){const c=this._key(d,f),g=this.cells.get(c);if(g)for(let u=0;u<g.length;u++)o.push(g[u])}return o}}function bt(t,e){if(t.isPlayer||!t.alive)return;if(t.aiTimer-=e*1e3,t.isMinion){Mt(t);return}if(t.isBoss){yt(t,e);return}const{foods:a,items:i,worms:o,foodGrid:l}=r;if(t.aiTimer<=0){t.aiTimer=A(500,2e3),t.aiState="wander",t.aiTarget=null;let s=null,n=300;const h=l.query(t.head.x,t.head.y,300);for(const m of h){if(!m.alive)continue;const y=_(t.head,m);y<n&&(s=m,n=y)}let d=null,f=400;for(const m of i){if(!m.alive)continue;const y=_(t.head,m);y<f&&(d=m,f=y)}let c=null,g=250;for(const m of o)if(!(m===t||!m.alive||m.isMinion)&&m.length<t.length*.7){const y=_(t.head,m.head);y<g&&(c=m,g=y)}let u=null,p=200;for(const m of o)if(!(m===t||!m.alive)&&m.length>t.length*1.3){const y=_(t.head,m.head);y<p&&(u=m,p=y)}if(r.obstacles){for(const m of r.obstacles)if(_(t.head,m)<m.radius+80){t.aiState="flee",t.aiTarget=m;break}}if(r.dangerZone&&r.dangerZone.active){const m=P.WORLD_W/2,y=P.WORLD_H/2;_(t.head,{x:m,y})>r.dangerZone.radius-100&&(t.aiState="flee",t.aiTarget={head:{x:m,y}},t.targetAngle=z(t.head,{x:m,y}))}t.aiState==="wander"&&(u&&p<150?(t.aiState="flee",t.aiTarget=u):c&&Math.random()>.3?(t.aiState="chase",t.aiTarget=c):d&&Math.random()>.4?(t.aiState="item",t.aiTarget=d):s&&(t.aiState="food",t.aiTarget=s))}switch(t.aiState){case"flee":t.aiTarget&&t.aiTarget.alive&&(t.targetAngle=z(t.aiTarget.head,t.head),t.boosting=t.length>15);break;case"chase":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget.head),t.boosting=_(t.head,t.aiTarget.head)<100&&t.length>15):t.aiState="wander";break;case"food":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;case"item":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;default:t.aiTimer<=0&&(t.targetAngle=t.angle+A(-.8,.8)),t.boosting=!1;break}}function yt(t,e){const{worms:a,foodGrid:i}=r;if(t.aiTimer-=e*1e3,!(t.aiTimer>0&&t.aiTarget&&t.aiTarget.alive)){t.aiTimer=A(300,1e3),t.aiTarget=null,t.aiState="wander";let o=null,l=400;for(const s of a){if(s===t||!s.alive||s.isMinion||s.isBoss)continue;const n=_(t.head,s.head);if(s.isPlayer&&n<500){o=s,l=n;break}n<l&&(o=s,l=n)}if(o)t.aiState="chase",t.aiTarget=o;else{const s=i.query(t.head.x,t.head.y,400);let n=null,h=400;for(const d of s){if(!d.alive)continue;const f=_(t.head,d);f<h&&(n=d,h=f)}n&&(t.aiState="food",t.aiTarget=n)}}switch(t.aiState){case"chase":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget.head),t.boosting=_(t.head,t.aiTarget.head)<200&&t.length>30):t.aiState="wander";break;case"food":t.aiTarget&&t.aiTarget.alive?(t.targetAngle=z(t.head,t.aiTarget),t.boosting=!1):t.aiState="wander";break;default:t.targetAngle=t.angle+A(-.5,.5),t.boosting=!1;break}}function Mt(t,e){if(!t.minionOwner||!t.minionOwner.alive){t.alive=!1;return}const{worms:a,foodGrid:i}=r;let o=null,l=250;const s=i.query(t.head.x,t.head.y,250);for(const d of s){if(!d.alive)continue;const f=_(t.head,d);f<l&&(o=d,l=f)}let n=null,h=200;for(const d of a)if(!(d===t||!d.alive||d===t.minionOwner||d.isMinion)&&d.length<t.length*.8){const f=_(t.head,d.head);f<h&&(n=d,h=f)}n?(t.targetAngle=z(t.head,n.head),t.boosting=h<80):o?t.targetAngle=z(t.head,o):_(t.head,t.minionOwner.head)>200?t.targetAngle=z(t.head,t.minionOwner.head):t.targetAngle+=A(-.1,.1)}function St(){const{player:t,worms:e,killCount:a,minionCooldown:i,activeItemEffects:o,wave:l,waveTimer:s}=r;if(!t)return;const n=G[t.evolutionStage]||G[0];document.getElementById("score-value").textContent=Math.floor(t.score);const h=document.getElementById("evo-badge");h&&(h.textContent=n.icon,h.className="evo-badge"+(t.evolutionStage>=2?" pulse":"")),document.getElementById("score-length").textContent=`${n.name} | ê¸¸ì´: ${Math.floor(t.length)} | í‚¬: ${a}`;const d=document.getElementById("wave-info");if(d){const b=Math.min(s,Y.DURATION)/Y.DURATION*100;if(l>0)d.innerHTML=`<span class="wave-label">ðŸŒŠ ${l}</span><div class="wave-bar"><div class="wave-bar-fill" id="wave-bar-fill" style="width:${b}%"></div></div>`,d.style.display="flex";else{const I=Math.max(0,Math.ceil(Y.DURATION-s));d.innerHTML=`<span class="wave-label">ë‹¤ìŒ ì›¨ì´ë¸Œ: ${I}s</span>`,d.style.display="flex"}}const f=e.filter(T=>T.alive&&!T.isMinion).sort((T,b)=>b.score-T.score),c=f.slice(0,8);!c.some(T=>T.isPlayer)&&t&&t.alive&&c.push(t);const u=document.getElementById("leaderboard");let p='<div class="lb-title">ìˆœìœ„</div>';for(const T of c){const b=f.indexOf(T)+1,I=T.isPlayer?" me":"";p+=`<div class="lb-entry${I}"><span><span class="lb-rank">${b}.</span>${T.name}</span><span>${Math.floor(T.score)}</span></div>`}u.innerHTML=p;const m=document.getElementById("minion-btn"),y=document.querySelector("#minion-cd circle");if(i>0){m.disabled=!0;const T=i/P.MINION_COOLDOWN;y.style.strokeDashoffset=(1-T)*226,y.style.stroke="rgba(255,150,50,0.5)"}else m.disabled=!1,y.style.strokeDashoffset=0,y.style.stroke="rgba(255,255,255,0.3)";const C=document.getElementById("active-items"),v=Date.now();r.activeItemEffects=o.filter(T=>v-T.start<T.duration),C.innerHTML=r.activeItemEffects.map(T=>{const b=1-(v-T.start)/T.duration;return`<div class="active-item">
      <span class="item-icon">${T.type.icon}</span>
      <span>${T.type.name}</span>
      <div class="item-bar"><div class="item-bar-fill" style="width:${b*100}%;background:${T.type.color}"></div></div>
    </div>`}).join("");const S=document.getElementById("damage-vignette");S&&(S.style.opacity=r.damageVignette)}function q(t,e,a="normal"){const i=document.createElement("div");i.className="kill-notify"+(a==="large"?" kill-notify-large":""),i.style.color=e,a==="large"&&(i.style.textShadow=`0 0 20px ${e}, 0 0 40px ${e}`),i.textContent=t,document.body.appendChild(i),setTimeout(()=>i.remove(),a==="large"?2200:1600)}function ve(t,e,a,i="#fff",o=18){r.floatTexts.push({x:t,y:e,text:a,color:i,size:o,life:1,vy:-1.5})}function vt(t,e,a){const{W:i,H:o}=r,l=[];for(const s of r.floatTexts){if(s.y+=s.vy*a*60,s.vy*=.98,s.life-=a*.8,s.life<=0)continue;const n=s.x-e.x+i/2,h=s.y-e.y+o/2;if(n<-100||n>i+100||h<-100||h>o+100){l.push(s);continue}t.save(),t.globalAlpha=s.life,t.font=`bold ${s.size}px "Segoe UI", sans-serif`,t.textAlign="center",t.fillStyle="rgba(0,0,0,0.5)",t.fillText(s.text,n,h+2),t.fillStyle=s.color,t.fillText(s.text,n,h),t.restore(),l.push(s)}r.floatTexts=l}function Pt(t,e,a,i,o,l){r.foodAbsorbs.push({fx:t,fy:e,tx:a,ty:i,color:o,radius:l,t:0})}function Ct(t,e,a){const{W:i,H:o}=r,l=[];for(const s of r.foodAbsorbs){if(s.t+=a*5,s.t>=1)continue;const n=s.t*s.t,h=s.fx+(s.tx-s.fx)*n,d=s.fy+(s.ty-s.fy)*n,f=s.radius*(1-n),c=h-e.x+i/2,g=d-e.y+o/2;if(c<-20||c>i+20||g<-20||g>o+20){l.push(s);continue}t.globalAlpha=1-n,t.beginPath(),t.arc(c,g,Math.max(1,f),0,Math.PI*2),t.fillStyle=s.color,t.fill(),t.globalAlpha=1,l.push(s)}r.foodAbsorbs=l}function Tt(t,e,a,i){const o=r.isMobile?8:15;t.save(),t.globalAlpha=.12,t.strokeStyle="rgba(200, 220, 255, 0.8)",t.lineWidth=1.5;for(let l=0;l<o;l++){const s=Math.random()*e,n=Math.random()*a,h=30+Math.random()*60,d=Math.atan2(n-a/2,s-e/2);t.beginPath(),t.moveTo(s,n),t.lineTo(s+Math.cos(d)*h,n+Math.sin(d)*h),t.stroke()}t.restore()}let x=null,j=!1,ie=!1;function pe(){return x||(x=new(window.AudioContext||window.webkitAudioContext)),x.state==="suspended"&&x.resume(),x}function It(){ie||(ie=!0,pe())}function D(t,e,a="sine",i=.3,o=null){if(j||!ie)return;const l=pe(),s=l.createOscillator(),n=l.createGain();s.type=a,s.frequency.setValueAtTime(t,l.currentTime),o!=null&&s.frequency.exponentialRampToValueAtTime(Math.max(o,20),l.currentTime+e),n.gain.setValueAtTime(i,l.currentTime),n.gain.exponentialRampToValueAtTime(.001,l.currentTime+e),s.connect(n),n.connect(l.destination),s.start(l.currentTime),s.stop(l.currentTime+e)}function Ye(t,e=.1){if(j||!ie)return;const a=pe(),i=a.sampleRate*t,o=a.createBuffer(1,i,a.sampleRate),l=o.getChannelData(0);for(let d=0;d<i;d++)l[d]=Math.random()*2-1;const s=a.createBufferSource();s.buffer=o;const n=a.createGain();n.gain.setValueAtTime(e,a.currentTime),n.gain.exponentialRampToValueAtTime(.001,a.currentTime+t);const h=a.createBiquadFilter();h.type="bandpass",h.frequency.value=1e3,h.Q.value=.5,s.connect(h),h.connect(n),n.connect(a.destination),s.start()}function kt(){D(600+Math.random()*400,.08,"sine",.15)}function wt(){D(300,.3,"square",.15,100),setTimeout(()=>D(500,.2,"sine",.12),100)}function Ot(){D(400,.5,"sawtooth",.2,80),setTimeout(()=>Ye(.3,.08),100)}function Et(){D(800,.1,"sine",.15,1200),setTimeout(()=>D(1200,.1,"sine",.12,1600),80)}function At(){D(500,.2,"triangle",.1,800)}function Rt(){D(2e3,.3,"sine",.1,500)}function _t(){for(let t=0;t<3;t++)setTimeout(()=>D(400+t*200,.1,"triangle",.1),t*60)}function Lt(){D(600,.15,"sine",.12,900),setTimeout(()=>D(900,.15,"sine",.12,1200),100),setTimeout(()=>D(1200,.2,"triangle",.1,1600),200)}function Dt(){for(let t=0;t<4;t++)setTimeout(()=>D(300+t*150,.15,"triangle",.12),t*80);setTimeout(()=>D(900,.3,"sine",.15,1200),350)}function Wt(){D(200,.2,"square",.08,400),setTimeout(()=>D(400,.2,"square",.08,600),150)}function Bt(){D(100,.4,"sawtooth",.15,60),setTimeout(()=>D(80,.3,"square",.1,120),200),setTimeout(()=>Ye(.2,.06),300)}function Re(){D(500,.1,"sine",.1,700),setTimeout(()=>D(700,.15,"triangle",.1,900),80)}function _e(){D(1e3,.2,"sine",.1,500),setTimeout(()=>D(500,.15,"sine",.08,1e3),100)}let U=null,te=null;function Gt(){if(j||!ie||U)return;const t=pe();te=t.createGain(),te.gain.value=.03,te.connect(t.destination),U=t.createOscillator(),U.type="sine",U.frequency.value=80,U.connect(te),U.start();const e=t.createOscillator(),a=t.createGain();e.frequency.value=.2,a.gain.value=10,e.connect(a),a.connect(U.frequency),e.start()}function Fe(){U&&(U.stop(),U=null,te=null)}function $t(){return j=!j,j&&Fe(),j}function Nt(){const{worms:t,foods:e,items:a,particles:i,foodGrid:o,segmentGrid:l}=r;for(const s of t){if(!s.alive)continue;const n=s.isPlayer?r.skillModifiers||{}:{},h=1+(n.eatRadiusMult||0),d=1+(n.scoreMult||0),f=s.radius*P.EAT_DISTANCE*h;if(s.magnetized||s.isPlayer&&n.autoMagnet){const u=s.magnetized?200:120,p=o.query(s.head.x,s.head.y,u);for(const m of p){if(!m.alive)continue;if(_(s.head,m)<u){const C=z(m,s.head);m.x+=Math.cos(C)*4,m.y+=Math.sin(C)*4}}}if(s.isPlayer&&n.freezeAura)for(const u of t)u===s||!u.alive||u.isMinion||u.isMinion&&u.minionOwner===s||_(s.head,u.head)<150&&(u.frozen||(u.frozenTimer=Math.max(u.frozenTimer,500),u.frozen=!0));const c=s.isPlayer&&{0:1,1:1.05,2:1.1,3:1.2,4:1.3}[s.evolutionStage]||1,g=o.query(s.head.x,s.head.y,f);for(const u of g)if(u.alive&&_(s.head,u)<f){u.alive=!1;const p=u.tier||V[0];if(s.length+=p.growValue*c,s.score+=Math.floor(p.scoreValue*d),s.isMinion&&s.minionOwner&&s.minionOwner.alive){const y=Math.floor(p.scoreValue*d*.5);s.minionOwner.score+=y,s.minionOwner.length+=p.growValue*.3}(s.isPlayer||s.isMinion&&s.minionOwner&&s.minionOwner.isPlayer)&&kt(),Pt(u.x,u.y,s.head.x,s.head.y,u.color,u.radius);const m=p.golden?5:p.growValue>2?4:3;i.push(K.acquire(u.x,u.y,u.color,m))}for(const u of a)if(u.alive&&_(s.head,u)<f+P.ITEM_RADIUS){u.alive=!1,zt(s,u.type);for(let p=0;p<12;p++)i.push(K.acquire(u.x,u.y,u.type.color,4))}}for(const s of t){if(!s.alive)continue;for(const d of t){if(d===s||!d.alive||s.isMinion&&d===s.minionOwner||d.isMinion&&d.minionOwner===s||s.isMinion&&d.isMinion&&s.minionOwner===d.minionOwner)continue;const f=_(s.head,d.head),c=(s.radius+d.radius)*.8;f<c&&(s.shielded&&!d.shielded?ee(d,s):d.shielded&&!s.shielded?ee(s,d):s.length>d.length*1.1?ee(d,s):d.length>s.length*1.1&&ee(s,d))}if(!s.alive)continue;const n=s.radius+40,h=l.query(s.head.x,s.head.y,n);for(const d of h){const f=d.worm;if(f===s||!f.alive||s.isMinion&&f===s.minionOwner||f.isMinion&&f.minionOwner===s||s.isMinion&&f.isMinion&&s.minionOwner===f.minionOwner||s.length>=f.length||s.shielded)continue;const c=f.bodyRadius(d.segIndex);if(_(s.head,d)<(s.radius+c)*.6){ee(s,f);break}}}}function ee(t,e){if(!t.alive)return;t.alive=!1;const{foods:a,particles:i}=r,o=V[1],l=V[2],s=Math.min(Math.floor(t.length/2),30);for(let d=0;d<s;d++){const f=t.segments[Math.min(d*2,t.segments.length-1)],c=d%4===0?l:o,g=me.acquire(f.x+A(-15,15),f.y+A(-15,15),c);g.color=t.color.h,g.glow=t.color.l,a.push(g)}const n=Math.min(40+Math.floor(t.length/8),60);for(let d=0;d<n;d++){const f=t.segments[Q(0,t.segments.length-1)],c=[t.color.l,t.color.h,"#ffffff","#ffdd44"],g=c[Q(0,c.length-1)],u=A(2,9);i.push(K.acquire(f.x+A(-25,25),f.y+A(-25,25),g,u))}const h=Math.floor(t.score*.5)+50;e.length+=t.length*.2,e.score+=h,e.isMinion&&e.minionOwner&&(e.minionOwner.score+=30,e.minionOwner.length+=t.length*.15),t.isBoss&&(r.bossesAlive=Math.max(0,r.bossesAlive-1)),(e.isPlayer||e.isMinion&&e.minionOwner&&e.minionOwner.isPlayer)&&(r.killCount++,ve(t.head.x,t.head.y-20,`+${h}`,"#ffdd44",22),t.isBoss?(r._bossKilled=!0,q(`ðŸ’€ ë³´ìŠ¤ ì²˜ì¹˜! +${h}ì `,"#ff4444","large"),ve(t.head.x,t.head.y-50,"ðŸ’€ BOSS KILL!","#ff4444",28)):q(`ðŸ´ ${t.name} ì²˜ì¹˜!`,e.color.l),wt()),t.isPlayer&&(r.damageVignette=1,r.onGameOver&&r.onGameOver())}function zt(t,e){const{worms:a}=r,i=t.isPlayer||t.isMinion&&t.minionOwner&&t.minionOwner.isPlayer;switch(e.id){case"speed":t.speedBoosted=!0,setTimeout(()=>{t.speedBoosted=!1},P.ITEM_DURATION),i&&he(e);break;case"shield":t.shielded=!0,i&&At(),setTimeout(()=>{t.shielded=!1},P.ITEM_DURATION),i&&he(e);break;case"magnet":t.magnetized=!0,setTimeout(()=>{t.magnetized=!1},P.ITEM_DURATION),i&&he(e);break;case"growth":t.length+=15,t.score+=30,i&&ve(t.head.x,t.head.y-20,"+15 ê¸¸ì´","#44dd88",18);break;case"freeze":for(const o of a)o===t||!o.alive||t.isMinion&&o===t.minionOwner||_(t.head,o.head)<250&&(o.frozenTimer=P.ITEM_DURATION,o.frozen=!0);i&&(Rt(),he(e));break}i&&(e.id!=="shield"&&e.id!=="freeze"&&Et(),q(`${e.icon} ${e.name} íšë“!`,e.color))}function he(t){const e=Date.now()+"_"+t.id;r.activeItemEffects.push({id:e,type:t,start:Date.now(),duration:P.ITEM_DURATION})}function Ht(){const{player:t,camera:e}=r;if(t&&t.alive){e.targetX=t.head.x,e.targetY=t.head.y;const a=t.length;a<50?e.targetZoom=1:a<120?e.targetZoom=1-(a-50)*.002:a<300?e.targetZoom=.86-(a-120)*.001:e.targetZoom=Math.max(.45,.68-(a-300)*5e-4)}if(e.x=oe(e.x,e.targetX,P.CAMERA_SMOOTH),e.y=oe(e.y,e.targetY,P.CAMERA_SMOOTH),e.zoom=oe(e.zoom,e.targetZoom,.03),r.screenShake>0){const a=r.screenShake*15;r.screenShakeX=(Math.random()-.5)*a,r.screenShakeY=(Math.random()-.5)*a,r.screenShake-=.02,r.screenShake<0&&(r.screenShake=0,r.screenShakeX=0,r.screenShakeY=0)}}class Xt{constructor(){this.x=A(300,P.WORLD_W-300),this.y=A(300,P.WORLD_H-300),this.radius=A($.OBSTACLE_RADIUS_MIN,$.OBSTACLE_RADIUS_MAX)}draw(e,a,i,o){const l=this.x-a.x+i/2,s=this.y-a.y+o/2;if(l<-100||l>i+100||s<-100||s>o+100)return;const n=e.createRadialGradient(l-this.radius*.2,s-this.radius*.2,0,l,s,this.radius);n.addColorStop(0,"#3a3a50"),n.addColorStop(.7,"#252535"),n.addColorStop(1,"#1a1a28"),e.beginPath(),e.arc(l,s,this.radius,0,Math.PI*2),e.fillStyle=n,e.fill(),e.beginPath(),e.ellipse(l-this.radius*.2,s-this.radius*.3,this.radius*.5,this.radius*.25,-.3,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.06)",e.fill()}}class Yt{constructor(){const a=A(0,360);this.a={x:A(400,P.WORLD_W/2-200),y:A(400,P.WORLD_H-400),cooldown:0},this.b={x:A(P.WORLD_W/2+200,P.WORLD_W-400),y:A(400,P.WORLD_H-400),cooldown:0},this.radius=$.PORTAL_RADIUS,this.hue=a,this.phase=A(0,Math.PI*2)}update(e){this.phase+=e*3,this.a.cooldown>0&&(this.a.cooldown-=e*1e3),this.b.cooldown>0&&(this.b.cooldown-=e*1e3)}drawPortal(e,a,i,o,l){const s=a.x-i.x+o/2,n=a.y-i.y+l/2;if(s<-60||s>o+60||n<-60||n>l+60)return;const h=this.radius,d=a.cooldown>0;e.save(),e.translate(s,n),e.rotate(this.phase),e.beginPath(),e.arc(0,0,h+4,0,Math.PI*2),e.strokeStyle=`hsla(${this.hue}, 80%, ${d?30:60}%, ${d?.3:.7})`,e.lineWidth=3,e.setLineDash([8,6]),e.stroke(),e.setLineDash([]);const f=e.createRadialGradient(0,0,0,0,0,h);if(f.addColorStop(0,`hsla(${this.hue}, 80%, 70%, ${d?.1:.3})`),f.addColorStop(1,`hsla(${this.hue}, 80%, 50%, 0)`),e.beginPath(),e.arc(0,0,h,0,Math.PI*2),e.fillStyle=f,e.fill(),!d)for(let c=0;c<3;c++){const g=this.phase+c*Math.PI*2/3;e.beginPath(),e.arc(0,0,h*.6,g,g+1),e.strokeStyle=`hsla(${this.hue+30}, 80%, 70%, 0.5)`,e.lineWidth=2,e.stroke()}e.restore()}draw(e,a,i,o){this.drawPortal(e,this.a,a,i,o),this.drawPortal(e,this.b,a,i,o)}}function Ft(t){const e=Math.min(t*$.OBSTACLES_PER_WAVE,$.MAX_OBSTACLES);for(;r.obstacles.length<e;)r.obstacles.push(new Xt);if(t>0&&t%$.PORTALS_EVERY_N_WAVES===0){const a=Math.min(Math.floor(t/$.PORTALS_EVERY_N_WAVES),$.MAX_PORTAL_PAIRS);for(;r.portals.length<a;)r.portals.push(new Yt)}t>=$.DANGER_ZONE_START_WAVE&&!r.dangerZone.active&&(r.dangerZone.active=!0,r.dangerZone.radius=Math.max(P.WORLD_W,P.WORLD_H)/2)}function Ut(t){for(const e of r.portals)e.update(t)}function Vt(t){if(!r.dangerZone.active)return;r.dangerZone.radius=Math.max($.DANGER_ZONE_MIN_RADIUS,r.dangerZone.radius-$.DANGER_ZONE_SHRINK_RATE*t);const e=P.WORLD_W/2,a=P.WORLD_H/2,i=r.dangerZone.radius;for(const o of r.worms){if(!o.alive)continue;_(o.head,{x:e,y:a})>i&&(o.length-=$.DANGER_ZONE_DAMAGE*t,o.length<5&&(o.alive=!1,o.isPlayer&&r.onGameOver&&r.onGameOver()))}}function qt(){for(const t of r.worms)if(t.alive)for(const e of r.obstacles){const a=_(t.head,e),i=t.radius+e.radius;if(a<i){const o=z(e,t.head),l=i-a;t.head.x+=Math.cos(o)*l,t.head.y+=Math.sin(o)*l,t.targetAngle=o,t.boosting&&t.length>10&&(t.length-=2)}}}function jt(){for(const t of r.portals)for(const e of r.worms)if(e.alive){if(t.a.cooldown<=0&&_(e.head,t.a)<t.radius){e.head.x=t.b.x+Math.cos(e.angle)*(t.radius+10),e.head.y=t.b.y+Math.sin(e.angle)*(t.radius+10),t.a.cooldown=$.PORTAL_COOLDOWN,t.b.cooldown=$.PORTAL_COOLDOWN,e.isPlayer&&_e();break}if(t.b.cooldown<=0&&_(e.head,t.b)<t.radius){e.head.x=t.a.x+Math.cos(e.angle)*(t.radius+10),e.head.y=t.a.y+Math.sin(e.angle)*(t.radius+10),t.a.cooldown=$.PORTAL_COOLDOWN,t.b.cooldown=$.PORTAL_COOLDOWN,e.isPlayer&&_e();break}}}function Zt(t){r.waveTimer+=t,r.waveTimer>=Y.DURATION&&(r.waveTimer-=Y.DURATION,r.wave++,Ft(r.wave),r.player&&r.player.alive&&(r.player.score+=r.wave*Y.WAVE_BONUS_MULT),q(`ðŸŒŠ ì›¨ì´ë¸Œ ${r.wave} ì‹œìž‘!`,"#88bbff","large"),Wt(),Y.BOSS_WAVES.includes(r.wave)&&(r._spawnBoss=!0,setTimeout(()=>{q("ðŸ’€ ë³´ìŠ¤ ì¶œí˜„!","#ff4444","large"),Bt()},1500)))}function be(){const t=r.wave;return{foodCount:P.FOOD_COUNT+t*Y.FOOD_PER_WAVE,aiCount:P.AI_COUNT+t*Y.AI_PER_WAVE,aiInitialLength:{min:15+t*Y.AI_LENGTH_PER_WAVE,max:60+t*Y.AI_LENGTH_PER_WAVE}}}function Ue(){const t=be(),e=ke(),a=Q(0,Z.length-1),i=Ee[Q(0,Ee.length-1)],o=new ue(e.x,e.y,a,i,!1);o.length=A(t.aiInitialLength.min,t.aiInitialLength.max),r.worms.push(o)}function Kt(){const t=be(),e=ke(),a=Q(0,Z.length-1),i="ðŸ”¥ ë³´ìŠ¤",o=new ue(e.x,e.y,a,i,!1);o.length=t.aiInitialLength.max*Y.BOSS_LENGTH_MULT,o.score=r.wave*200,o.isBoss=!0,r.worms.push(o),r.bossesAlive++}function Jt(){const{player:t,particles:e,worms:a}=r;if(r.gameState!=="playing"||!t||!t.alive||r.minionCooldown>0)return;const i=r.skillModifiers||{},o=Math.max(.1,1+(i.minionCdMult||0));r.minionCooldown=P.MINION_COOLDOWN*o;const l=P.MINION_COUNT+(i.minionCountBonus||0);for(let s=0;s<l;s++){const n=Math.PI*2/l*s,h=t.head.x+Math.cos(n)*60,d=t.head.y+Math.sin(n)*60,f=new ue(h,d,r.selectedColor,"ë¶€í•˜",!1,!0);f.length=Math.max(10,t.length*.25),f.minionOwner=t,f.minionTimer=P.MINION_DURATION,a.push(f);for(let c=0;c<8;c++)e.push(K.acquire(h,d,t.color.l,4))}_t(),q(`ðŸ‘¥ ë¶€í•˜ ${l}ëª… ì†Œí™˜!`,"#ff9944")}function Qt(){const t=be(),{foods:e}=r,a=e.filter(o=>o.alive).length,i=t.foodCount;if(a<i)for(let o=0;o<i-a;o++)e.push(me.acquire())}function xt(){const{items:t}=r;t.filter(a=>a.alive).length<P.ITEM_COUNT&&t.push(new He)}function eo(){const t=be(),{worms:e,player:a}=r,i=e.filter(l=>l.alive&&!l.isPlayer&&!l.isMinion&&!l.isBoss).length;let o=t.aiCount;a&&a.alive&&(a.length>150?o=Math.max(3,Math.floor(t.aiCount*.7)):a.length>100&&(o=Math.max(4,Math.floor(t.aiCount*.85)))),i<o&&Ue(),r._spawnBoss&&(r._spawnBoss=!1,Kt())}const to=120,Ve=[];for(let t=0;t<to;t++)Ve.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,size:.5+Math.random()*2,brightness:.3+Math.random()*.7,twinkleSpeed:.02+Math.random()*.04,depth:.3+Math.random()*.4});const oo=35,qe=[];for(let t=0;t<oo;t++)qe.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,r:15+Math.random()*25,alpha:.02+Math.random()*.02,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.2});const Pe=80,je=[],Le=["grass","stone","flower","moss","pebble"];for(let t=0;t<Pe;t++){const e=Le[Math.floor(Math.random()*Le.length)];je.push({x:Math.random()*P.WORLD_W,y:Math.random()*P.WORLD_H,type:e,size:4+Math.random()*12,rotation:Math.random()*Math.PI*2,hue:Math.random()*30-15,alpha:.15+Math.random()*.15})}function ao(t,e,a,i,o,l,s,n,h,d){const f=e.x+a,c=e.y+i;if(f<s-30||f>s+h+30||c<n-30||c>n+d+30)return;const g=e.size;switch(t.globalAlpha=e.alpha,e.type){case"grass":{t.strokeStyle=`hsl(${120+e.hue}, 40%, 30%)`,t.lineWidth=1,t.lineCap="round";for(let u=0;u<3;u++){const p=e.rotation+(u-1)*.4;t.beginPath(),t.moveTo(f+(u-1)*2,c),t.lineTo(f+(u-1)*2+Math.cos(p)*g,c-Math.sin(p+.5)*g),t.stroke()}break}case"stone":{const u=t.createRadialGradient(f-g*.2,c-g*.2,0,f,c,g);u.addColorStop(0,`hsla(220, 10%, 45%, ${e.alpha})`),u.addColorStop(1,`hsla(220, 10%, 25%, ${e.alpha*.5})`),t.beginPath(),t.ellipse(f,c,g,g*.7,e.rotation,0,Math.PI*2),t.fillStyle=u,t.fill();break}case"flower":{const u=(e.hue+200+Math.abs(e.x)*.1)%360;t.fillStyle=`hsla(${u}, 70%, 60%, ${e.alpha})`;for(let p=0;p<5;p++){const m=e.rotation+p/5*Math.PI*2;t.beginPath(),t.ellipse(f+Math.cos(m)*g*.4,c+Math.sin(m)*g*.4,g*.3,g*.15,m,0,Math.PI*2),t.fill()}t.beginPath(),t.arc(f,c,g*.15,0,Math.PI*2),t.fillStyle=`hsla(45, 80%, 60%, ${e.alpha})`,t.fill();break}case"moss":{t.fillStyle=`hsla(${140+e.hue}, 35%, 28%, ${e.alpha*.7})`,t.beginPath(),t.arc(f,c,g*.8,0,Math.PI*2),t.fill();break}case"pebble":{t.fillStyle=`hsla(30, 8%, 35%, ${e.alpha*.6})`,t.beginPath(),t.ellipse(f,c,g*.5,g*.35,e.rotation,0,Math.PI*2),t.fill();break}}t.globalAlpha=1}function so(t=null,e=1){const{ctx:a,camera:i,W:o,H:l,frameCount:s}=r,n=t||i,h=-n.x+o/2,d=-n.y+l/2,f=o/e,c=l/e,g=o/2-f/2,u=l/2-c/2,p=s*.001,m=Math.sin(p)*.02+.98,y=a.createRadialGradient(o/2,l/2,0,o/2,l/2,Math.max(f,c)*.7*m);y.addColorStop(0,`hsl(240, 60%, ${8+Math.sin(p*.5)*2}%)`),y.addColorStop(.6,"#0c0c2d"),y.addColorStop(1,"#040412"),a.fillStyle=y,a.fillRect(g,u,f,c);const C=r.wave||0;if(C>0){const M=C*30%360,k=(.03+Math.min(C*.005,.05))*(1+Math.sin(s*.02)*.3),H=M+Math.sin(s*.01)*10;a.fillStyle=`hsla(${H}, 70%, 45%, ${k})`,a.fillRect(g,u,f,c)}for(const M of Ve){const k=M.x-n.x*M.depth+o/2,H=M.y-n.y*M.depth+l/2,le=(k%f+f)%f+g,re=(H%c+c)%c+u,de=Math.sin(s*M.twinkleSpeed+M.x)*.3+.7,et=M.brightness*de;a.beginPath(),a.arc(le,re,M.size,0,Math.PI*2),a.fillStyle=`rgba(200,210,255,${et})`,a.fill()}const v=60,S=300,T=f/2,b=c/2,I=Math.floor((n.x-T)/v)*v,w=Math.floor((n.y-b)/v)*v;a.strokeStyle="rgba(40, 40, 100, 0.12)",a.lineWidth=.5,a.beginPath();for(let M=I;M<n.x+T+v;M+=v){if(M%S===0)continue;const k=M+h;a.moveTo(k,u),a.lineTo(k,u+c)}for(let M=w;M<n.y+b+v;M+=v){if(M%S===0)continue;const k=M+d;a.moveTo(g,k),a.lineTo(g+f,k)}a.stroke();const O=Math.floor((n.x-T)/S)*S,R=Math.floor((n.y-b)/S)*S;a.strokeStyle="rgba(50, 50, 120, 0.2)",a.lineWidth=1,a.beginPath();for(let M=O;M<n.x+T+S;M+=S){const k=M+h;a.moveTo(k,u),a.lineTo(k,u+c)}for(let M=R;M<n.y+b+S;M+=S){const k=M+d;a.moveTo(g,k),a.lineTo(g+f,k)}a.stroke();const E=r.isMobile?Math.floor(Pe/2):Pe;for(let M=0;M<E;M++)ao(a,je[M],h,d,o,l,g,u,f,c);for(const M of qe){M.x+=M.vx,M.y+=M.vy,M.x<0&&(M.x+=P.WORLD_W),M.x>P.WORLD_W&&(M.x-=P.WORLD_W),M.y<0&&(M.y+=P.WORLD_H),M.y>P.WORLD_H&&(M.y-=P.WORLD_H);const k=M.x+h,H=M.y+d;k<g-50||k>g+f+50||H<u-50||H>u+c+50||(a.beginPath(),a.arc(k,H,M.r,0,Math.PI*2),a.fillStyle=`rgba(160,170,220,${M.alpha})`,a.fill())}if(r.dangerZone&&r.dangerZone.active){const M=P.WORLD_W/2+h,k=P.WORLD_H/2+d,H=r.dangerZone.radius;a.save(),a.beginPath(),a.rect(0,0,o,l),a.arc(M,k,H,0,Math.PI*2,!0),a.fillStyle="rgba(200, 30, 30, 0.15)",a.fill(),a.beginPath(),a.arc(M,k,H,0,Math.PI*2),a.strokeStyle="rgba(255, 60, 60, 0.5)",a.lineWidth=3,a.setLineDash([12,8]),a.stroke(),a.setLineDash([]),a.restore()}for(const M of r.obstacles)M.draw(a,i,o,l);for(const M of r.portals)M.draw(a,i,o,l);const L=P.BORDER_MARGIN,W=150,N=.25+Math.sin(s*.03)*.1;if(n.x-o/2<L+100){const M=L+h;a.strokeStyle=`rgba(255, 80, 120, ${N})`,a.lineWidth=2,a.shadowColor="rgba(255, 80, 120, 0.6)",a.shadowBlur=15,a.beginPath(),a.moveTo(M,0),a.lineTo(M,l),a.stroke(),a.shadowBlur=0;const k=a.createLinearGradient(M-30,0,M+W,0);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),a.fillStyle=k,a.fillRect(M-30,0,W+30,l)}if(n.x+o/2>P.WORLD_W-L-100){const M=P.WORLD_W-L+h;a.strokeStyle=`rgba(255, 80, 120, ${N})`,a.lineWidth=2,a.shadowColor="rgba(255, 80, 120, 0.6)",a.shadowBlur=15,a.beginPath(),a.moveTo(M,0),a.lineTo(M,l),a.stroke(),a.shadowBlur=0;const k=a.createLinearGradient(M+30,0,M-W,0);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),a.fillStyle=k,a.fillRect(M-W,0,W+30,l)}if(n.y-l/2<L+100){const M=L+d;a.strokeStyle=`rgba(255, 80, 120, ${N})`,a.lineWidth=2,a.shadowColor="rgba(255, 80, 120, 0.6)",a.shadowBlur=15,a.beginPath(),a.moveTo(0,M),a.lineTo(o,M),a.stroke(),a.shadowBlur=0;const k=a.createLinearGradient(0,M-30,0,M+W);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),a.fillStyle=k,a.fillRect(0,M-30,o,W+30)}if(n.y+l/2>P.WORLD_H-L-100){const M=P.WORLD_H-L+d;a.strokeStyle=`rgba(255, 80, 120, ${N})`,a.lineWidth=2,a.shadowColor="rgba(255, 80, 120, 0.6)",a.shadowBlur=15,a.beginPath(),a.moveTo(0,M),a.lineTo(o,M),a.stroke(),a.shadowBlur=0;const k=a.createLinearGradient(0,M+30,0,M-W);k.addColorStop(0,`rgba(255, 50, 80, ${N})`),k.addColorStop(1,"rgba(255, 50, 80, 0)"),a.fillStyle=k,a.fillRect(0,M-W,o,W+30)}}function no(){const{mmCtx:t,camera:e,foods:a,worms:i,W:o,H:l}=r,s=document.getElementById("minimap-container"),n=Math.round(parseFloat(getComputedStyle(s).width))||140,h=n;t.clearRect(0,0,n,h),t.fillStyle="rgba(10, 10, 40, 0.5)",t.fillRect(0,0,n,h);const d=n/P.WORLD_W,f=h/P.WORLD_H;if(r.dangerZone&&r.dangerZone.active){const m=P.WORLD_W/2*d,y=P.WORLD_H/2*f,C=r.dangerZone.radius*d;t.save(),t.beginPath(),t.rect(0,0,n,h),t.arc(m,y,C,0,Math.PI*2,!0),t.fillStyle="rgba(200, 30, 30, 0.3)",t.fill(),t.beginPath(),t.arc(m,y,C,0,Math.PI*2),t.strokeStyle="rgba(255, 60, 60, 0.6)",t.lineWidth=1,t.stroke(),t.restore()}t.fillStyle="rgba(100, 200, 100, 0.3)";for(const m of a)m.alive&&t.fillRect(m.x*d,m.y*f,1,1);t.fillStyle="rgba(120, 120, 140, 0.5)";for(const m of r.obstacles){const y=Math.max(1.5,m.radius*d);t.beginPath(),t.arc(m.x*d,m.y*f,y,0,Math.PI*2),t.fill()}for(const m of r.portals){const y=`hsl(${m.hue}, 80%, 60%)`;for(const C of[m.a,m.b])t.beginPath(),t.arc(C.x*d,C.y*f,2.5,0,Math.PI*2),t.fillStyle=y,t.fill()}for(const m of i){if(!m.alive||m.isMinion)continue;const y=Math.max(2,m.radius*d*2);t.beginPath(),t.arc(m.head.x*d,m.head.y*f,y,0,Math.PI*2),m.isBoss?t.fillStyle="#ff4444":t.fillStyle=m.isPlayer?"#ffdd44":m.color.h,t.globalAlpha=m.isPlayer?1:.7,t.fill(),t.globalAlpha=1}const c=(e.x-o/2)*d,g=(e.y-l/2)*f,u=o*d,p=l*f;t.strokeStyle="rgba(255, 255, 255, 0.4)",t.lineWidth=1,t.strokeRect(c,g,u,p)}const Ze="wormy_records",Me={highScore:0,maxLength:0,maxKills:0,longestSurvival:0,totalGames:0};let B=null,F=[];function ye(){try{const t=localStorage.getItem(Ze);B=t?{...Me,...JSON.parse(t)}:{...Me}}catch{B={...Me}}return F=[],B}function Ke(){if(B)try{localStorage.setItem(Ze,JSON.stringify(B))}catch{}}function io(){return B||ye(),B}function lo(){return F}function ro(){F=[]}function Je(t){if(!B)return!1;const{player:e,killCount:a}=t;if(!e)return!1;let i=!1;const o=Math.floor(e.score),l=Math.floor(e.length),s=t.survivalTime||0;return o>B.highScore&&(B.highScore=o,F.includes("highScore")||(F.push("highScore"),i=!0)),l>B.maxLength&&(B.maxLength=l,F.includes("maxLength")||(F.push("maxLength"),i=!0)),a>B.maxKills&&(B.maxKills=a,F.includes("maxKills")||(F.push("maxKills"),i=!0)),s>B.longestSurvival&&(B.longestSurvival=s,F.includes("longestSurvival")||(F.push("longestSurvival"),i=!0)),i}function ho(){B||ye(),B.totalGames++,Ke()}function Ce(t){const e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`}const Qe="wormy_achievements";let J={},ge=[];function fo(){try{const t=localStorage.getItem(Qe);J=t?JSON.parse(t):{}}catch{J={}}return ge=[],J}function co(){try{localStorage.setItem(Qe,JSON.stringify(J))}catch{}}function go(){const t=[...ge];return ge=[],t}function uo(t){const{player:e,killCount:a,survivalTime:i,wave:o,bossesAlive:l}=t;if(e)for(const s of fe)J[s.id]||s.check(t)&&(J[s.id]=!0,ge.push(s),co())}function mo(){const t=Ie.filter(a=>{const i=r.selectedSkills.find(o=>o.id===a.id);return!i||i.level<a.maxLevel});if(t.length===0)return null;const e=[...t].sort(()=>Math.random()-.5);return e.slice(0,Math.min(3,e.length))}function De(t){const e=Ie.find(i=>i.id===t);if(!e)return;let a=r.selectedSkills.find(i=>i.id===t);if(a){if(a.level>=e.maxLevel)return;a.level++}else r.selectedSkills.push({id:t,level:1});po()}function po(){const t={};for(const e of r.selectedSkills){const a=Ie.find(i=>i.id===e.id);if(a)for(const[i,o]of Object.entries(a.effect))typeof o=="boolean"?t[i]=o:t[i]=(t[i]||0)+o*e.level}r.skillModifiers=t}function bo(){if(!r.player||!r.player.alive||r.skillChoices)return!1;if(r.player.score>=r.nextSkillScore){const t=mo();if(t&&t.length>0)return r.skillChoices=t,r.nextSkillScore+=500,!0;r.nextSkillScore+=500}return!1}let X=null;function yo(t){X&&ce(),X=document.createElement("div"),X.id="skill-overlay",X.className="skill-overlay";let e='<div class="skill-title">ìŠ¤í‚¬ ì„ íƒ</div>';e+='<div class="skill-cards">';for(const a of t){const i=r.selectedSkills.find(n=>n.id===a.id),l=(i?i.level:0)+1,s=Array.from({length:a.maxLevel},(n,h)=>`<span class="skill-dot${h<l?" filled":""}"></span>`).join("");e+=`
      <button class="skill-card" data-skill="${a.id}">
        <div class="skill-card-icon">${a.icon}</div>
        <div class="skill-card-name">${a.name}</div>
        <div class="skill-card-desc">${a.desc}</div>
        <div class="skill-card-level">${s} Lv.${l}</div>
      </button>
    `}e+="</div>",X.innerHTML=e,document.body.appendChild(X),X.querySelectorAll(".skill-card").forEach(a=>{a.addEventListener("click",i=>{i.stopPropagation();const o=a.dataset.skill;De(o),Re(),ce(),r.skillChoices=null}),a.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation();const o=a.dataset.skill;De(o),Re(),ce(),r.skillChoices=null})}),requestAnimationFrame(()=>X.classList.add("active"))}function ce(){X&&(X.remove(),X=null)}function Mo(){return X!==null}r.foodGrid=new Xe(100);r.segmentGrid=new Xe(100);r.onGameOver=()=>vo();function So(){if(r.playerName=document.getElementById("nickname").value.trim()||"ë‚˜",document.getElementById("menu-screen").classList.add("hidden"),document.getElementById("hud").classList.add("active"),document.getElementById("minion-wrap").style.display="block",document.getElementById("boost-wrap").style.display="block",document.getElementById("minimap-container").style.display="block",r.isMobile){const a=document.getElementById("joystick-area");a&&(a.style.display="block")}r.killCount=0,r.minionCooldown=0,r.activeItemEffects=[],r.notifications=[],r.survivalTime=0,r.damageVignette=0,r.floatTexts=[],r.foodAbsorbs=[],r.wave=0,r.waveTimer=0,r.skillChoices=null,r.selectedSkills=[],r.skillModifiers={},r.nextSkillScore=500,r.obstacles=[],r.portals=[],r.dangerZone={active:!1,radius:0},r.bossesAlive=0,r.evolutionFlash=0,ye(),ro(),ho(),fo(),r._bossKilled=!1;const t=P.WORLD_W/2,e=P.WORLD_H/2;r.player=new ue(t,e,r.selectedColor,r.playerName,!0),r.worms=[r.player];for(let a=0;a<P.AI_COUNT;a++)Ue();r.foods=[];for(let a=0;a<P.FOOD_COUNT;a++)r.foods.push(me.acquire());r.items=[];for(let a=0;a<P.ITEM_COUNT;a++)r.items.push(new He);r.particles=[],r.camera.x=t,r.camera.y=e,r.camera.targetX=t,r.camera.targetY=e,r.gameState="playing",It(),Gt(),document.getElementById("mute-btn").style.display="block"}function vo(){const{player:t,killCount:e}=r;r.gameState="gameover",Fe(),Ot(),ce(),r.skillChoices=null,r.screenShake=1,Je(r),Ke();const a=io(),i=lo();document.getElementById("mute-btn").style.display="none";const o=document.getElementById("joystick-area");o&&(o.style.display="none");const l=G[t.evolutionStage]||G[0];document.getElementById("go-evo-icon").textContent=l.icon;const s=document.getElementById("go-wave");s&&(s.textContent=r.wave>0?`ðŸŒŠ ì›¨ì´ë¸Œ ${r.wave} ë„ë‹¬`:"");const n=document.getElementById("go-score-val"),h=document.getElementById("go-length-val"),d=document.getElementById("go-kills-val"),f=document.getElementById("go-time-val");n&&(n.textContent=Math.floor(t.score)),h&&(h.textContent=Math.floor(t.length)),d&&(d.textContent=e),f&&(f.textContent=Ce(r.survivalTime));const c=document.getElementById("go-records");if(c){let g="";i.length>0&&(g+='<div class="go-new-record">ðŸ† ìƒˆ ê¸°ë¡!</div>'),g+='<div class="go-record-list">',g+=`<span>ìµœê³  ${a.highScore}ì </span>`,g+=`<span>ìµœëŒ€ ê¸¸ì´ ${a.maxLength}</span>`,g+=`<span>ìµœë‹¤ í‚¬ ${a.maxKills}</span>`,g+=`<span>ìµœìž¥ ìƒì¡´ ${Ce(a.longestSurvival)}</span>`,g+="</div>",c.innerHTML=g}document.getElementById("game-over").classList.add("active"),document.getElementById("hud").classList.remove("active"),document.getElementById("minion-wrap").style.display="none",document.getElementById("boost-wrap").style.display="none",document.getElementById("minimap-container").style.display="none"}function xe(t){if(requestAnimationFrame(xe),r.gameState!=="playing"||Mo())return;const e=Math.min((t-r.lastTime)/1e3,.05);r.lastTime=t,r.frameCount++;const{player:a,worms:i,foods:o,items:l,particles:s,ctx:n,camera:h,mouse:d,W:f,H:c}=r;if(a&&a.alive){const b=d.x-f/2,I=d.y-c/2;a.targetAngle=Math.atan2(I,b),a.boosting=r.boosting}for(const b of i)if(b.alive&&(b.isPlayer||bt(b,e),b.update(e),!b.isMinion)){const I=gt(b);if(I.evolved&&b.isPlayer){q(`âœ¨ ${I.stage.icon} ${I.stage.name}(ìœ¼)ë¡œ ì§„í™”!`,"#ffdd44","large"),Dt();for(let w=0;w<50;w++){const O=["#ffdd44","#ff8844","#ffaa00","#ffffff","#ff66ff","#66ffff"],R=O[Math.random()*O.length|0],E=40+w*.5,L=Math.PI*2/50*w+Math.random()*.5,W=Math.random()*E,N=b.head.x+Math.cos(L)*W,M=b.head.y+Math.sin(L)*W,k=K.acquire(N,M,R,4+Math.random()*4);r.particles.push(k)}r.evolutionFlash=1}}r.foodGrid.clear();for(const b of o)b.alive&&r.foodGrid.insert(b,b.x,b.y);r.segmentGrid.clear();for(const b of i){if(!b.alive)continue;let I=3;b.length>100?I=Math.max(5,Math.floor(b.length/30)):b.length>50&&(I=5);for(let w=5;w<b.segments.length;w+=I){const O=b.segments[w];r.segmentGrid.insert({worm:b,segIndex:w,x:O.x,y:O.y},O.x,O.y)}}Nt(),qt(),jt(),Ut(e),Vt(e),Qt(),xt(),eo();const g=[];for(const b of o)b.alive?g.push(b):me.release(b);r.foods=g,r.items=l.filter(b=>b.alive),r.worms=i.filter(b=>b.alive||b.isPlayer);const u=[];for(const b of s)b.update(e)?u.push(b):K.release(b);if(r.particles=u,Ht(),r.minionCooldown>0&&(r.minionCooldown-=e*1e3),r.survivalTime+=e,Zt(e),r.frameCount%60===0&&Je(r)&&q("ðŸ† ìƒˆ ê¸°ë¡!","#ffdd44"),r.frameCount%30===0){uo(r);const b=go();for(const I of b)q(`ðŸ… ì—…ì  ë‹¬ì„±: ${I.name}!`,"#44ddff"),Lt()}if(bo()){yo(r.skillChoices);return}r.damageVignette>0&&(r.damageVignette-=e*2,r.damageVignette<0&&(r.damageVignette=0));const p={x:h.x+r.screenShakeX,y:h.y+r.screenShakeY,zoom:h.zoom},m=h.zoom,y=f/m,C=c/m;n.save(),n.translate(f/2,c/2),n.scale(m,m),n.translate(-f/2,-c/2),so(p,m);for(const b of r.foods)b.draw(n,p);for(const b of r.items)b.draw(n,p);for(const b of r.particles)b.draw(n,p);Ct(n,p,e);const v=[...r.worms].filter(b=>b.alive).sort((b,I)=>b.length-I.length),S=500/m,T={left:h.x-y/2-S,right:h.x+y/2+S,top:h.y-C/2-S,bottom:h.y+C/2+S};for(const b of v)!b.isPlayer&&(b.head.x<T.left||b.head.x>T.right||b.head.y<T.top||b.head.y>T.bottom)||b.draw(n,p);vt(n,p,e),n.restore(),a&&a.alive&&a.boosting&&Tt(n,f,c),r.evolutionFlash>0&&(n.fillStyle=`rgba(255,240,180,${r.evolutionFlash*.35})`,n.fillRect(0,0,f,c),r.evolutionFlash-=e*3,r.evolutionFlash<0&&(r.evolutionFlash=0)),r.frameCount%10===0&&St(),r.frameCount%20===0&&no()}let Te=null;function Po(){const t=document.getElementById("color-grid");Z.forEach((e,a)=>{const i=document.createElement("button");i.className="color-btn"+(a===0?" selected":""),i.style.background=`radial-gradient(circle at 40% 35%, ${e.l}, ${e.h}, ${e.b})`,i.addEventListener("click",()=>{document.querySelectorAll(".color-btn").forEach(o=>o.classList.remove("selected")),i.classList.add("selected"),r.selectedColor=a}),t.appendChild(i)}),document.getElementById("play-btn").addEventListener("click",()=>{Te&&cancelAnimationFrame(Te),So()}),document.getElementById("retry-btn").addEventListener("click",()=>{document.getElementById("game-over").classList.remove("active"),document.getElementById("menu-screen").classList.remove("hidden"),r.gameState="menu",Be(),Ge(),We()}),Co(),Be(),Ge(),We()}function Co(){const t=document.getElementById("menu-particles");if(!t)return;const e=15;for(let a=0;a<e;a++){const i=document.createElement("div");i.className="particle";const o=4+Math.random()*8,l=Math.random()*360;i.style.width=o+"px",i.style.height=o+"px",i.style.left=Math.random()*100+"%",i.style.top=Math.random()*100+"%",i.style.background=`hsla(${l}, 70%, 60%, 0.3)`,i.style.animationDelay=Math.random()*8+"s",i.style.animationDuration=6+Math.random()*6+"s",t.appendChild(i)}}function We(){const t=document.getElementById("preview-canvas");if(!t)return;const e=t.getContext("2d"),a=t.width,i=t.height;let o=0;function l(){Te=requestAnimationFrame(l),o+=.03,e.clearRect(0,0,a,i);const s=Z[r.selectedColor],n=12,h=6;for(let p=n-1;p>=0;p--){const m=p/n,y=a/2+Math.cos(o+p*.4)*20+(p-n/2)*6,C=i/2+Math.sin(o*2+p*.3)*8,v=h*(1-m*.4),S=e.createRadialGradient(y-v*.3,C-v*.3,0,y,C,v);S.addColorStop(0,s.l),S.addColorStop(.5,s.h),S.addColorStop(1,s.b),e.beginPath(),e.arc(y,C,v,0,Math.PI*2),e.fillStyle=S,e.fill()}const d=a/2+Math.cos(o)*20-n/2*6+n*3,f=i/2+Math.sin(o*2)*8,c=h*1.3,g=e.createRadialGradient(d-c*.3,f-c*.3,0,d,f,c);g.addColorStop(0,"#fff"),g.addColorStop(.3,s.l),g.addColorStop(.7,s.h),g.addColorStop(1,s.b),e.beginPath(),e.arc(d,f,c,0,Math.PI*2),e.fillStyle=g,e.fill();const u=Math.atan2(Math.sin(o*2)*.5,1);for(const p of[-1,1]){const m=d+Math.cos(u-p*.5)*c*.35,y=f+Math.sin(u-p*.5)*c*.35;e.beginPath(),e.arc(m,y,c*.3,0,Math.PI*2),e.fillStyle="#fff",e.fill(),e.beginPath(),e.arc(m+Math.cos(u)*c*.08,y+Math.sin(u)*c*.08,c*.18,0,Math.PI*2),e.fillStyle="#1a1a2e",e.fill(),e.beginPath(),e.arc(m+Math.cos(u)*c*.04-c*.06,y-c*.06,c*.07,0,Math.PI*2),e.fillStyle="rgba(255,255,255,0.8)",e.fill()}}l()}function Be(){const t=ye(),e=document.getElementById("menu-records");if(e){if(t.totalGames===0){e.innerHTML="";return}e.innerHTML=`
    <div class="records-title">ðŸ† ë‚´ ê¸°ë¡</div>
    <div class="records-grid">
      <div class="record-item"><span class="record-label">ìµœê³ ì ìˆ˜</span><span class="record-val">${t.highScore}</span></div>
      <div class="record-item"><span class="record-label">ìµœëŒ€ê¸¸ì´</span><span class="record-val">${t.maxLength}</span></div>
      <div class="record-item"><span class="record-label">ìµœë‹¤í‚¬</span><span class="record-val">${t.maxKills}</span></div>
      <div class="record-item"><span class="record-label">ìµœìž¥ìƒì¡´</span><span class="record-val">${Ce(t.longestSurvival)}</span></div>
      <div class="record-item"><span class="record-label">í”Œë ˆì´</span><span class="record-val">${t.totalGames}íšŒ</span></div>
    </div>
  `}}function Ge(){const t=document.getElementById("menu-achievements");if(!t)return;let e;try{const o=localStorage.getItem("wormy_achievements");e=o?JSON.parse(o):{}}catch{e={}}if(fe.length===0){t.innerHTML="";return}let i=`<div class="achieve-title">ðŸ… ì—…ì  (${Object.keys(e).length}/${fe.length})</div>`;i+='<div class="achieve-grid">';for(const o of fe){const l=!e[o.id];i+=`<div class="achieve-item${l?" locked":""}" title="${o.desc}">
      <span class="achieve-icon">${o.icon}</span>
      <span class="achieve-name">${o.name}</span>
    </div>`}i+="</div>",t.innerHTML=i}function To(){return/Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0}function Io(){const{canvas:t}=r;r.isMobile=To(),document.addEventListener("touchmove",a=>{r.gameState==="playing"&&a.preventDefault()},{passive:!1}),t.addEventListener("mousemove",a=>{r.mouse.x=a.clientX,r.mouse.y=a.clientY}),t.addEventListener("touchmove",a=>{a.preventDefault(),!r.joystick.active&&(r.mouse.x=a.touches[0].clientX,r.mouse.y=a.touches[0].clientY)},{passive:!1}),t.addEventListener("touchstart",a=>{a.preventDefault(),!r.joystick.active&&(r.mouse.x=a.touches[0].clientX,r.mouse.y=a.touches[0].clientY)},{passive:!1});const e=document.getElementById("boost-btn");e.addEventListener("mousedown",a=>{a.stopPropagation(),r.boosting=!0}),e.addEventListener("mouseup",()=>{r.boosting=!1}),e.addEventListener("mouseleave",()=>{r.boosting=!1}),e.addEventListener("touchstart",a=>{a.preventDefault(),a.stopPropagation(),r.boosting=!0}),e.addEventListener("touchend",a=>{a.preventDefault(),r.boosting=!1}),document.addEventListener("keydown",a=>{a.code==="Space"&&(r.boosting=!0)}),document.addEventListener("keyup",a=>{a.code==="Space"&&(r.boosting=!1)}),document.getElementById("minion-btn").addEventListener("click",Jt),document.getElementById("mute-btn").addEventListener("click",()=>{const a=$t();document.getElementById("mute-btn").textContent=a?"ðŸ”‡":"ðŸ”Š"}),r.isMobile&&ko()}function ko(){const t=document.getElementById("joystick-area"),e=document.getElementById("joystick-base"),a=document.getElementById("joystick-knob");if(!t)return;t.style.display="block";const i=50;t.addEventListener("touchstart",l=>{l.preventDefault(),l.stopPropagation();const s=l.touches[0],n=t.getBoundingClientRect();r.joystick.active=!0,r.joystick.id=s.identifier,r.joystick.startX=s.clientX,r.joystick.startY=s.clientY,r.joystick.currentX=s.clientX,r.joystick.currentY=s.clientY;const h=s.clientX-n.left,d=s.clientY-n.top;e.style.left=h+"px",e.style.top=d+"px",e.style.opacity="1",a.style.transform="translate(-50%, -50%)"},{passive:!1}),t.addEventListener("touchmove",l=>{l.preventDefault(),l.stopPropagation();for(const s of l.changedTouches)if(s.identifier===r.joystick.id){r.joystick.currentX=s.clientX,r.joystick.currentY=s.clientY;let n=s.clientX-r.joystick.startX,h=s.clientY-r.joystick.startY;const d=Math.hypot(n,h);d>i&&(n=n/d*i,h=h/d*i),a.style.transform=`translate(calc(-50% + ${n}px), calc(-50% + ${h}px))`,d>5&&(r.mouse.x=r.W/2+n*5,r.mouse.y=r.H/2+h*5)}},{passive:!1});const o=l=>{for(const s of l.changedTouches)s.identifier===r.joystick.id&&(r.joystick.active=!1,r.joystick.id=null,e.style.opacity="0.4",a.style.transform="translate(-50%, -50%)")};t.addEventListener("touchend",o),t.addEventListener("touchcancel",o)}r.canvas=document.getElementById("game");r.ctx=r.canvas.getContext("2d");r.mmCanvas=document.getElementById("minimap");r.mmCtx=r.mmCanvas.getContext("2d");function we(){r.dpr=Math.min(window.devicePixelRatio||1,2),r.W=window.innerWidth,r.H=window.innerHeight;const{canvas:t,ctx:e,mmCanvas:a,mmCtx:i,dpr:o,W:l,H:s}=r;t.width=l*o,t.height=s*o,t.style.width=l+"px",t.style.height=s+"px",e.setTransform(o,0,0,o,0,0);const n=document.getElementById("minimap-container"),h=Math.round(parseFloat(getComputedStyle(n).width))||140;a.width=h*o,a.height=h*o,a.style.width=h+"px",a.style.height=h+"px",i.setTransform(o,0,0,o,0,0)}window.addEventListener("resize",we);window.addEventListener("orientationchange",()=>setTimeout(we,150));we();dt();Po();Io();requestAnimationFrame(xe);
